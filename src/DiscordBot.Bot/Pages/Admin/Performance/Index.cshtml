@page "/Admin/Performance"
@model DiscordBot.Bot.Pages.Admin.Performance.IndexModel
@{
    ViewData["Title"] = "Bot Performance";
    ViewData["Breadcrumbs"] = new List<(string Text, string? Url)>
    {
        ("Dashboard", "/"),
        ("Bot Performance", null)
    };
}

@section Styles {
    <link rel="stylesheet" href="~/css/performance-pages.css" />
    <link rel="stylesheet" href="~/css/performance-shell.css" />
}

<!-- Skip Link for Accessibility -->
<a href="#tabContent" class="performance-skip-link">Skip to content</a>

<div class="performance-shell">
    <!-- Shell Header -->
    <header class="performance-shell-header">
        <div>
            <div class="performance-shell-title-group">
                <h1 class="performance-shell-title">Bot Performance</h1>
                <div class="live-indicator" id="liveIndicator">
                    <span class="live-dot"></span>
                    <span class="live-text">Live</span>
                </div>
            </div>
            <p class="performance-shell-subtitle">Real-time monitoring and performance metrics</p>
        </div>

        <div class="performance-shell-controls">
            <!-- Time Range Selector -->
            <div class="time-range-selector" role="group" aria-label="Time range">
                <button type="button" class="time-range-option active" data-hours="24">24h</button>
                <button type="button" class="time-range-option" data-hours="168">7d</button>
                <button type="button" class="time-range-option" data-hours="720">30d</button>
            </div>

            <!-- Overall Health Status -->
            <div class="health-status @Model.ShellViewModel.OverallStatusClass">
                @{
                    var statusIcon = Model.ShellViewModel.OverallStatus.ToLowerInvariant() switch
                    {
                        "healthy" => @"<svg class=""w-4 h-4"" fill=""none"" viewBox=""0 0 24 24"" stroke=""currentColor""><path stroke-linecap=""round"" stroke-linejoin=""round"" stroke-width=""2"" d=""M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"" /></svg>",
                        "warning" => @"<svg class=""w-4 h-4"" fill=""none"" viewBox=""0 0 24 24"" stroke=""currentColor""><path stroke-linecap=""round"" stroke-linejoin=""round"" stroke-width=""2"" d=""M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"" /></svg>",
                        "critical" => @"<svg class=""w-4 h-4"" fill=""none"" viewBox=""0 0 24 24"" stroke=""currentColor""><path stroke-linecap=""round"" stroke-linejoin=""round"" stroke-width=""2"" d=""M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"" /></svg>",
                        _ => @"<svg class=""w-4 h-4"" fill=""none"" viewBox=""0 0 24 24"" stroke=""currentColor""><path stroke-linecap=""round"" stroke-linejoin=""round"" stroke-width=""2"" d=""M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"" /></svg>"
                    };
                }
                @Html.Raw(statusIcon)
                <span>@Model.ShellViewModel.OverallStatusText</span>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    @await Html.PartialAsync("Components/_PerformanceTabNav", Model.ShellViewModel)

    <!-- Tab Content Area -->
    <main class="performance-shell-content" id="tabContent">
        <!-- Overview Tab Panel -->
        <div class="performance-tab-panel active" id="tabPanel-overview" role="tabpanel" aria-labelledby="tab-overview">
            @await Html.PartialAsync("Tabs/_OverviewTab", Model.ViewModel)
        </div>

        <!-- Health Metrics Tab Panel -->
        <div class="performance-tab-panel" id="tabPanel-health" role="tabpanel" aria-labelledby="tab-health" hidden>
            <div class="performance-placeholder">
                <svg class="performance-placeholder-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                </svg>
                <h3 class="performance-placeholder-title">Health Metrics</h3>
                <p class="performance-placeholder-description">Bot health and connection status will be loaded here via AJAX.</p>
            </div>
        </div>

        <!-- Commands Tab Panel -->
        <div class="performance-tab-panel" id="tabPanel-commands" role="tabpanel" aria-labelledby="tab-commands" hidden>
            <div class="performance-placeholder">
                <svg class="performance-placeholder-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                <h3 class="performance-placeholder-title">Command Performance</h3>
                <p class="performance-placeholder-description">Command execution metrics and response times will be loaded here via AJAX.</p>
            </div>
        </div>

        <!-- API Tab Panel -->
        <div class="performance-tab-panel" id="tabPanel-api" role="tabpanel" aria-labelledby="tab-api" hidden>
            <div class="performance-placeholder">
                <svg class="performance-placeholder-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <h3 class="performance-placeholder-title">API & Rate Limits</h3>
                <p class="performance-placeholder-description">Discord API usage and rate limit metrics will be loaded here via AJAX.</p>
            </div>
        </div>

        <!-- System Tab Panel -->
        <div class="performance-tab-panel" id="tabPanel-system" role="tabpanel" aria-labelledby="tab-system" hidden>
            <div class="performance-placeholder">
                <svg class="performance-placeholder-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
                </svg>
                <h3 class="performance-placeholder-title">System Health</h3>
                <p class="performance-placeholder-description">Database, cache, and background service status will be loaded here via AJAX.</p>
            </div>
        </div>

        <!-- Alerts Tab Panel -->
        <div class="performance-tab-panel" id="tabPanel-alerts" role="tabpanel" aria-labelledby="tab-alerts" hidden>
            <div class="performance-placeholder">
                <svg class="performance-placeholder-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                </svg>
                <h3 class="performance-placeholder-title">Performance Alerts</h3>
                <p class="performance-placeholder-description">Alert thresholds and incident management will be loaded here via AJAX.</p>
            </div>
        </div>
    </main>
</div>

@section Scripts {
    <script src="~/js/performance-shell.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="~/js/realtime-ui.js"></script>
    <script>
        // Chart.js default dark theme settings
        Chart.defaults.color = '#a8a5a3';
        Chart.defaults.borderColor = '#3f4447';

        let responseTimeChart;
        let throughputChart;

        // Initialize charts for overview tab
        async function initCharts() {
            try {
                // Fetch command performance data
                const performanceResponse = await fetch('/api/metrics/commands/performance?hours=24');
                const performanceData = await performanceResponse.json();

                // Fetch throughput data
                const throughputResponse = await fetch('/api/metrics/commands/throughput?hours=24&granularity=hour');
                const throughputData = await throughputResponse.json();

                // Response Time Chart
                const responseCtx = document.getElementById('responseTimeChart');
                if (responseCtx) {
                    const responseLabels = performanceData.slice(0, 12).map((_, i) => {
                        const hour = new Date().getHours() - (12 - i);
                        return `${(hour + 24) % 24}:00`;
                    });
                    const responseValues = performanceData.slice(0, 12).map(d => d.avgDurationMs || 0);

                    responseTimeChart = new Chart(responseCtx.getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: responseLabels,
                            datasets: [{
                                label: 'Avg Response (ms)',
                                data: responseValues,
                                borderColor: '#098ecf',
                                backgroundColor: 'rgba(9, 142, 207, 0.1)',
                                fill: true,
                                tension: 0.4,
                                pointBackgroundColor: '#098ecf',
                                pointBorderColor: '#098ecf',
                                pointRadius: 3,
                                pointHoverRadius: 5
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: '#2f3336',
                                    titleColor: '#d7d3d0',
                                    bodyColor: '#a8a5a3',
                                    borderColor: '#3f4447',
                                    borderWidth: 1,
                                    padding: 12,
                                    displayColors: false,
                                    callbacks: {
                                        label: function(context) {
                                            return context.parsed.y.toFixed(0) + ' ms';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: '#2f3336' },
                                    ticks: {
                                        callback: function(value) {
                                            return value + ' ms';
                                        }
                                    }
                                },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }

                // Throughput Chart
                const throughputCtx = document.getElementById('throughputChart');
                if (throughputCtx) {
                    const throughputLabels = throughputData.slice(0, 12).map(d => {
                        const date = new Date(d.timestamp);
                        return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                    });
                    const throughputValues = throughputData.slice(0, 12).map(d => d.commandCount);

                    throughputChart = new Chart(throughputCtx.getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: throughputLabels,
                            datasets: [{
                                label: 'Commands',
                                data: throughputValues,
                                backgroundColor: '#cb4e1b',
                                borderRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: '#2f3336',
                                    titleColor: '#d7d3d0',
                                    bodyColor: '#a8a5a3',
                                    borderColor: '#3f4447',
                                    borderWidth: 1,
                                    padding: 12,
                                    displayColors: false,
                                    callbacks: {
                                        label: function(context) {
                                            return context.parsed.y + ' commands';
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: { beginAtZero: true, grid: { color: '#2f3336' } },
                                x: { grid: { display: false } }
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to initialize charts:', error);
            }
        }

        // Auto-refresh data
        async function refreshData() {
            try {
                const response = await fetch('/api/metrics/health');
                const health = await response.json();
                console.log('Health data refreshed:', health);
            } catch (error) {
                console.error('Failed to refresh data:', error);
            }
        }

        // Convert UTC timestamps to local timezone
        function convertTimestampsToLocal() {
            const timestampElements = document.querySelectorAll('[data-utc-time]');
            timestampElements.forEach(element => {
                const utcTime = element.getAttribute('data-utc-time');
                const format = element.getAttribute('data-format');
                if (utcTime) {
                    try {
                        const date = new Date(utcTime);

                        if (format === 'relative') {
                            const now = new Date();
                            const elapsed = now - date;
                            const minutes = Math.floor(elapsed / 60000);
                            const hours = Math.floor(minutes / 60);
                            const days = Math.floor(hours / 24);

                            let relativeText;
                            if (days >= 1) {
                                relativeText = days === 1 ? '1 day ago' : `${days} days ago`;
                            } else if (hours >= 1) {
                                relativeText = hours === 1 ? '1 hour ago' : `${hours} hours ago`;
                            } else if (minutes >= 1) {
                                relativeText = minutes === 1 ? '1 minute ago' : `${minutes} minutes ago`;
                            } else {
                                relativeText = 'Just now';
                            }
                            element.textContent = relativeText;
                        } else {
                            const formatted = date.toLocaleDateString('en-US', {
                                month: 'short',
                                day: '2-digit',
                                year: 'numeric'
                            }) + ' at ' + date.toLocaleTimeString('en-US', {
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false
                            });
                            element.textContent = formatted;
                        }
                    } catch (e) {
                        console.error('Failed to parse timestamp:', utcTime, e);
                    }
                }
            });
        }

        // Listen for tab changes
        document.addEventListener('performanceTabChanged', function(e) {
            console.log('Tab changed to:', e.detail.tabId);
            // Re-initialize charts when switching to overview
            if (e.detail.tabId === 'overview' && !responseTimeChart) {
                initCharts();
            }
        });

        // Listen for time range changes
        document.addEventListener('timeRangeChanged', function(e) {
            console.log('Time range changed to:', e.detail.hours, 'hours');
            // Future: refresh data with new time range
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            convertTimestampsToLocal();

            // Auto-refresh every 30 seconds
            setInterval(refreshData, 30000);
        });
    </script>
}
