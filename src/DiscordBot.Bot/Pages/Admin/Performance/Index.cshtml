@page "/Admin/Performance"
@model DiscordBot.Bot.Pages.Admin.Performance.IndexModel
@{
    ViewData["Title"] = "Bot Performance";
    ViewData["Breadcrumbs"] = new List<(string Text, string? Url)>
    {
        ("Dashboard", "/"),
        ("Bot Performance", null)
    };
}

@section Styles {
    <link rel="stylesheet" href="~/css/performance-pages.css" />
    <link rel="stylesheet" href="~/css/tab-panel.css" asp-append-version="true" />
}

<!-- Page Header -->
<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
    <div class="flex items-center gap-3">
        <div>
            <h1 class="text-2xl lg:text-3xl font-bold text-text-primary">Bot Performance</h1>
            <p class="text-text-secondary mt-1">Real-time monitoring and performance metrics</p>
        </div>
        <div class="live-indicator" id="liveIndicator">
            <span class="live-dot"></span>
            <span class="live-text">Live</span>
        </div>
    </div>

    <!-- Overall Health Status -->
    <div class="health-status @Model.ViewModel.OverallStatusClass">
        @{
            var statusIcon = Model.ViewModel.OverallStatus.ToLowerInvariant() switch
            {
                "healthy" => @"<svg class=""w-4 h-4"" fill=""none"" viewBox=""0 0 24 24"" stroke=""currentColor""><path stroke-linecap=""round"" stroke-linejoin=""round"" stroke-width=""2"" d=""M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"" /></svg>",
                "warning" => @"<svg class=""w-4 h-4"" fill=""none"" viewBox=""0 0 24 24"" stroke=""currentColor""><path stroke-linecap=""round"" stroke-linejoin=""round"" stroke-width=""2"" d=""M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"" /></svg>",
                "critical" => @"<svg class=""w-4 h-4"" fill=""none"" viewBox=""0 0 24 24"" stroke=""currentColor""><path stroke-linecap=""round"" stroke-linejoin=""round"" stroke-width=""2"" d=""M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"" /></svg>",
                _ => @"<svg class=""w-4 h-4"" fill=""none"" viewBox=""0 0 24 24"" stroke=""currentColor""><path stroke-linecap=""round"" stroke-linejoin=""round"" stroke-width=""2"" d=""M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"" /></svg>"
            };
        }
        @Html.Raw(statusIcon)
        <span>@Model.ViewModel.OverallStatusText</span>
    </div>
</div>

<!-- Navigation Tabs with Time Range Selector -->
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    @{
        var performanceTabs = new DiscordBot.Bot.ViewModels.Components.TabPanelViewModel
        {
            Id = "performanceTabs",
            StyleVariant = DiscordBot.Bot.ViewModels.Components.TabStyleVariant.Underline,
            NavigationMode = DiscordBot.Bot.ViewModels.Components.TabNavigationMode.Ajax,
            AjaxUrlPattern = "/Admin/Performance?handler=Partial&tabId={tabId}",
            AjaxContentTarget = "#tabContent",
            PersistenceMode = DiscordBot.Bot.ViewModels.Components.TabPersistenceMode.UrlHash,
            AriaLabel = "Performance sections",
            ActiveTabId = "overview",
            DisableAutoInit = true, // Handled by dashboard.js with time range support
            Tabs = new List<DiscordBot.Bot.ViewModels.Components.TabItemViewModel>
            {
                new() { Id = "overview", Label = "Overview",
                    IconPathOutline = "M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z",
                    IconPathSolid = "M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zm6-4a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zm6-3a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" },
                new() { Id = "health", Label = "Health Metrics", ShortLabel = "Health",
                    IconPathOutline = "M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z",
                    IconPathSolid = "M3.172 5.172a4 4 0 015.656 0L12 8.343l3.172-3.171a4 4 0 115.656 5.656L12 19.657l-8.828-8.829a4 4 0 010-5.656z" },
                new() { Id = "commands", Label = "Commands",
                    IconPathOutline = "M13 10V3L4 14h7v7l9-11h-7z",
                    IconPathSolid = "M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" },
                new() { Id = "api", Label = "API & Rate Limits", ShortLabel = "API",
                    IconPathOutline = "M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z",
                    IconPathSolid = "M14.447 3.027a.75.75 0 01.527.92l-4.5 16.5a.75.75 0 01-1.448-.394l4.5-16.5a.75.75 0 01.921-.526zM16.72 6.22a.75.75 0 011.06 0l5.25 5.25a.75.75 0 010 1.06l-5.25 5.25a.75.75 0 11-1.06-1.06L21.44 12l-4.72-4.72a.75.75 0 010-1.06zm-9.44 0a.75.75 0 010 1.06L2.56 12l4.72 4.72a.75.75 0 11-1.06 1.06L.97 12.53a.75.75 0 010-1.06l5.25-5.25a.75.75 0 011.06 0z" },
                new() { Id = "system", Label = "System Health", ShortLabel = "System",
                    IconPathOutline = "M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01",
                    IconPathSolid = "M4.5 3A1.5 1.5 0 003 4.5v4A1.5 1.5 0 004.5 10h11a1.5 1.5 0 001.5-1.5v-4A1.5 1.5 0 0015.5 3h-11zm0 11A1.5 1.5 0 003 15.5v4A1.5 1.5 0 004.5 21h11a1.5 1.5 0 001.5-1.5v-4a1.5 1.5 0 00-1.5-1.5h-11zM13 7a1 1 0 100-2 1 1 0 000 2zm-3 0a1 1 0 100-2 1 1 0 000 2zm6 11a1 1 0 100-2 1 1 0 000 2zm-3 0a1 1 0 100-2 1 1 0 000 2z" },
                new() { Id = "alerts", Label = "Alerts",
                    IconPathOutline = "M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9",
                    IconPathSolid = "M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z",
                    BadgeCount = Model.ViewModel.ActiveAlertCount,
                    BadgeVariant = DiscordBot.Bot.ViewModels.Components.TabBadgeVariant.Warning }
            }
        };
    }
    @await Html.PartialAsync("Components/_TabPanel", performanceTabs)

    <!-- Time Range Selector -->
    <div class="flex items-center gap-2">
        <span class="text-sm text-text-secondary mr-2">Time Range:</span>
        <button class="time-range-btn active" data-hours="24">24h</button>
        <button class="time-range-btn" data-hours="168">7d</button>
        <button class="time-range-btn" data-hours="720">30d</button>
    </div>
</div>

<!-- Tab Content Container (for AJAX-loaded content) -->
<div class="tab-panel" id="tabContent" role="tabpanel" aria-live="polite" data-performance-tabs>
    <!-- Content loaded via AJAX by performance-tabs.js -->
    <!-- Loading states managed entirely by JavaScript for proper transition lifecycle -->
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="~/js/realtime-ui.js"></script>
    <script src="~/js/tab-panel.js" asp-append-version="true"></script>

    <!-- Performance Dashboard shared utilities -->
    <script src="~/js/performance/time-range.js"></script>
    <script src="~/js/performance/components/timestamp-utils.js"></script>
    <script src="~/js/performance/components/chart-utils.js"></script>

    <!-- Tab modules -->
    <script src="~/js/performance/tabs/overview.js"></script>
    <script src="~/js/performance/tabs/health.js"></script>
    <script src="~/js/performance/tabs/commands.js"></script>
    <script src="~/js/performance/tabs/api.js"></script>
    <script src="~/js/performance/tabs/system.js"></script>
    <script src="~/js/performance/tabs/alerts.js"></script>

    <!-- Main orchestrator (loads last) -->
    <script src="~/js/performance/dashboard.js"></script>

    <script>
        // Chart.js default dark theme settings
        Chart.defaults.color = '#a8a5a3';
        Chart.defaults.borderColor = '#3f4447';

        // Smart reconnect behavior foundation
        // Will be wired up to SignalR when DashboardHub is extended (issue #624)
        const RealtimeUI = {
            liveIndicatorId: 'liveIndicator',

            setLive(isLive) {
                const indicator = document.getElementById(this.liveIndicatorId);
                if (indicator) {
                    if (isLive) {
                        indicator.classList.remove('paused');
                    } else {
                        indicator.classList.add('paused');
                    }
                }
            },

            animateValueChange(elementId, newValue, formatter = null) {
                const element = document.getElementById(elementId);
                if (!element) return;

                const oldValue = element.textContent;
                const displayValue = formatter ? formatter(newValue) : String(newValue);
                element.textContent = displayValue;

                if (oldValue !== displayValue) {
                    element.classList.add('value-changed');
                    setTimeout(() => element.classList.remove('value-changed'), 500);
                }
            },

            // Called when SignalR reconnects
            async onReconnected() {
                this.setLive(true);

                // Refresh current tab
                if (window.PerformanceTabs) {
                    window.PerformanceTabs.refresh();
                }

                // Show reconnected toast
                if (typeof ToastManager !== 'undefined') {
                    ToastManager.show('success', 'Real-time updates restored', {
                        title: 'Reconnected',
                        duration: 3000
                    });
                }
            },

            // Called when SignalR disconnects
            onDisconnected() {
                this.setLive(false);

                if (typeof ToastManager !== 'undefined') {
                    ToastManager.show('warning', 'Attempting to reconnect...', {
                        title: 'Connection Lost',
                        duration: 5000
                    });
                }
            }
        };
    </script>
}
