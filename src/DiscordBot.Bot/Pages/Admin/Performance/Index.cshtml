@page "/Admin/Performance"
@model DiscordBot.Bot.Pages.Admin.Performance.IndexModel
@{
    ViewData["Title"] = "Bot Performance";
    ViewData["Breadcrumbs"] = new List<(string Text, string? Url)>
    {
        ("Dashboard", "/"),
        ("Bot Performance", null)
    };
}

@section Styles {
    <link rel="stylesheet" href="~/css/performance-pages.css" />
}

<!-- Page Header -->
<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
    <div class="flex items-center gap-3">
        <div>
            <h1 class="text-2xl lg:text-3xl font-bold text-text-primary">Bot Performance</h1>
            <p class="text-text-secondary mt-1">Real-time monitoring and performance metrics</p>
        </div>
        <div class="live-indicator" id="liveIndicator">
            <span class="live-dot"></span>
            <span class="live-text">Live</span>
        </div>
    </div>

    <!-- Overall Health Status -->
    <div class="health-status @Model.ViewModel.OverallStatusClass">
        @{
            var statusIcon = Model.ViewModel.OverallStatus.ToLowerInvariant() switch
            {
                "healthy" => @"<svg class=""w-4 h-4"" fill=""none"" viewBox=""0 0 24 24"" stroke=""currentColor""><path stroke-linecap=""round"" stroke-linejoin=""round"" stroke-width=""2"" d=""M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"" /></svg>",
                "warning" => @"<svg class=""w-4 h-4"" fill=""none"" viewBox=""0 0 24 24"" stroke=""currentColor""><path stroke-linecap=""round"" stroke-linejoin=""round"" stroke-width=""2"" d=""M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"" /></svg>",
                "critical" => @"<svg class=""w-4 h-4"" fill=""none"" viewBox=""0 0 24 24"" stroke=""currentColor""><path stroke-linecap=""round"" stroke-linejoin=""round"" stroke-width=""2"" d=""M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"" /></svg>",
                _ => @"<svg class=""w-4 h-4"" fill=""none"" viewBox=""0 0 24 24"" stroke=""currentColor""><path stroke-linecap=""round"" stroke-linejoin=""round"" stroke-width=""2"" d=""M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"" /></svg>"
            };
        }
        @Html.Raw(statusIcon)
        <span>@Model.ViewModel.OverallStatusText</span>
    </div>
</div>

<!-- Navigation Tabs with Time Range Selector -->
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    @await Html.PartialAsync("Components/_PerformanceTabs", new DiscordBot.Bot.ViewModels.Components.PerformanceTabsViewModel
    {
        ActiveTab = "overview",
        ActiveAlertCount = Model.ViewModel.ActiveAlertCount,
        UseAjaxNavigation = true
    })

    <!-- Time Range Selector -->
    <div class="flex items-center gap-2">
        <span class="text-sm text-text-secondary mr-2">Time Range:</span>
        <button class="time-range-btn active" data-hours="24">24h</button>
        <button class="time-range-btn" data-hours="168">7d</button>
        <button class="time-range-btn" data-hours="720">30d</button>
    </div>
</div>

<!-- Tab Content Container (for AJAX-loaded content) -->
<div class="tab-panel" id="tabContent" role="tabpanel" data-performance-tabs>
    <!-- Content loaded via AJAX by performance-tabs.js -->
    <!-- Loading states managed entirely by JavaScript for proper transition lifecycle -->
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="~/js/realtime-ui.js"></script>

    <!-- Performance Dashboard shared utilities -->
    <script src="~/js/performance/time-range.js"></script>
    <script src="~/js/performance/components/timestamp-utils.js"></script>
    <script src="~/js/performance/components/chart-utils.js"></script>

    <!-- Tab modules -->
    <script src="~/js/performance/tabs/overview.js"></script>
    <script src="~/js/performance/tabs/health.js"></script>
    <script src="~/js/performance/tabs/commands.js"></script>
    <script src="~/js/performance/tabs/api.js"></script>
    <script src="~/js/performance/tabs/system.js"></script>
    <script src="~/js/performance/tabs/alerts.js"></script>

    <!-- Main orchestrator (loads last) -->
    <script src="~/js/performance/dashboard.js"></script>

    <script>
        // Chart.js default dark theme settings
        Chart.defaults.color = '#a8a5a3';
        Chart.defaults.borderColor = '#3f4447';

        // Smart reconnect behavior foundation
        // Will be wired up to SignalR when DashboardHub is extended (issue #624)
        const RealtimeUI = {
            liveIndicatorId: 'liveIndicator',

            setLive(isLive) {
                const indicator = document.getElementById(this.liveIndicatorId);
                if (indicator) {
                    if (isLive) {
                        indicator.classList.remove('paused');
                    } else {
                        indicator.classList.add('paused');
                    }
                }
            },

            animateValueChange(elementId, newValue, formatter = null) {
                const element = document.getElementById(elementId);
                if (!element) return;

                const oldValue = element.textContent;
                const displayValue = formatter ? formatter(newValue) : String(newValue);
                element.textContent = displayValue;

                if (oldValue !== displayValue) {
                    element.classList.add('value-changed');
                    setTimeout(() => element.classList.remove('value-changed'), 500);
                }
            },

            // Called when SignalR reconnects
            async onReconnected() {
                this.setLive(true);

                // Refresh current tab
                if (window.PerformanceTabs) {
                    window.PerformanceTabs.refresh();
                }

                // Show reconnected toast
                if (typeof ToastManager !== 'undefined') {
                    ToastManager.show('success', 'Real-time updates restored', {
                        title: 'Reconnected',
                        duration: 3000
                    });
                }
            },

            // Called when SignalR disconnects
            onDisconnected() {
                this.setLive(false);

                if (typeof ToastManager !== 'undefined') {
                    ToastManager.show('warning', 'Attempting to reconnect...', {
                        title: 'Connection Lost',
                        duration: 5000
                    });
                }
            }
        };
    </script>
}
