@page "/Admin/Performance"
@model DiscordBot.Bot.Pages.Admin.Performance.IndexModel
@{
    ViewData["Title"] = "Bot Performance";
    ViewData["Breadcrumbs"] = new List<(string Text, string? Url)>
    {
        ("Dashboard", "/"),
        ("Bot Performance", null)
    };
}

@section Styles {
    <link rel="stylesheet" href="~/css/performance-pages.css" />
    <style>
        /* Chart Card */
        .chart-card {
            background: rgb(35, 38, 40);
            border: 1px solid rgb(63, 68, 71);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .chart-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem;
            border-bottom: 1px solid rgb(63, 68, 71);
        }

        .chart-card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: rgb(215, 211, 208);
            margin: 0;
        }

        .chart-card-subtitle {
            font-size: 0.875rem;
            color: rgb(168, 165, 163);
            margin: 0.25rem 0 0;
        }

        .chart-card-body {
            padding: 1.25rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Status Cards */
        .status-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .status-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: rgb(35, 38, 40);
            border: 1px solid rgb(63, 68, 71);
            border-radius: 0.5rem;
            transition: all 0.2s;
            text-decoration: none;
        }

        .status-card:hover {
            border-color: rgb(9, 142, 207);
            background: rgb(40, 43, 46);
        }

        .status-card-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .status-card-icon svg {
            width: 1.5rem;
            height: 1.5rem;
        }

        .status-card-content {
            flex: 1;
            min-width: 0;
        }

        .status-card-label {
            display: block;
            font-size: 0.75rem;
            color: rgb(168, 165, 163);
            margin-bottom: 0.25rem;
        }

        .status-card-value {
            display: block;
            font-size: 1.25rem;
            font-weight: 600;
            color: rgb(215, 211, 208);
        }

        /* Metric Cards */
        .metric-card {
            background: rgb(35, 38, 40);
            border: 1px solid rgb(63, 68, 71);
            border-radius: 0.5rem;
            padding: 1.25rem;
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .metric-label {
            font-size: 0.875rem;
            color: rgb(168, 165, 163);
        }

        .metric-icon {
            width: 1.25rem;
            height: 1.25rem;
            color: rgb(168, 165, 163);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: rgb(215, 211, 208);
            line-height: 1;
        }

        .metric-unit {
            font-size: 1rem;
            font-weight: 500;
            color: rgb(168, 165, 163);
        }

        .metric-trend {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            margin-top: 0.5rem;
            font-size: 0.75rem;
        }

        .metric-trend-up {
            color: rgb(16, 185, 129);
        }

        /* Progress Bar */
        .progress-labeled {
            margin-top: 1rem;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .progress-label {
            font-size: 0.875rem;
            color: rgb(168, 165, 163);
        }

        .progress-value {
            font-size: 0.875rem;
            color: rgb(215, 211, 208);
            font-weight: 500;
        }

        .progress-bar-container {
            width: 100%;
            height: 0.5rem;
            background: rgb(47, 51, 54);
            border-radius: 9999px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 9999px;
            transition: width 0.3s ease;
        }

        .progress-bar-healthy {
            background: rgb(16, 185, 129);
        }

        .progress-bar-warning {
            background: rgb(245, 158, 11);
        }

        .progress-bar-error {
            background: rgb(239, 68, 68);
        }

        /* Alert Card */
        .alert-card {
            display: flex;
            gap: 1rem;
            padding: 1rem;
            border: 1px solid rgb(63, 68, 71);
            border-radius: 0.5rem;
        }

        .alert-card-warning {
            background: rgba(245, 158, 11, 0.05);
            border-color: rgba(245, 158, 11, 0.3);
        }

        .alert-card-info {
            background: rgba(9, 142, 207, 0.05);
            border-color: rgba(9, 142, 207, 0.3);
        }

        .alert-icon {
            width: 1.25rem;
            height: 1.25rem;
            flex-shrink: 0;
        }

        .alert-icon-warning {
            color: rgb(245, 158, 11);
        }

        .alert-icon-info {
            color: rgb(9, 142, 207);
        }

        .alert-content {
            flex: 1;
            min-width: 0;
        }

        .alert-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: rgb(215, 211, 208);
            margin-bottom: 0.25rem;
        }

        .alert-description {
            font-size: 0.875rem;
            color: rgb(168, 165, 163);
            margin-bottom: 0.5rem;
        }

        .alert-meta {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.75rem;
            color: rgb(120, 116, 113);
        }

        .severity-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .severity-warning {
            background: rgba(245, 158, 11, 0.2);
            color: rgb(245, 158, 11);
        }

        .severity-info {
            background: rgba(9, 142, 207, 0.2);
            color: rgb(9, 142, 207);
        }

        /* Grid Layouts */
        .performance-grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        /* Button Styles */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.375rem;
            transition: all 0.2s;
            text-decoration: none;
            border: none;
            cursor: pointer;
        }

        .btn-secondary {
            background: rgb(47, 51, 54);
            color: rgb(215, 211, 208);
            border: 1px solid rgb(63, 68, 71);
        }

        .btn-secondary:hover {
            background: rgb(55, 60, 63);
            border-color: rgb(99, 102, 104);
        }

        .btn-svg-icon {
            width: 1rem;
            height: 1rem;
        }
    </style>
}

<!-- Page Header -->
<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
    <div class="flex items-center gap-3">
        <div>
            <h1 class="text-2xl lg:text-3xl font-bold text-text-primary">Bot Performance</h1>
            <p class="text-text-secondary mt-1">Real-time monitoring and performance metrics</p>
        </div>
        <div class="live-indicator" id="liveIndicator">
            <span class="live-dot"></span>
            <span class="live-text">Live</span>
        </div>
    </div>

    <!-- Overall Health Status -->
    <div class="health-status @Model.ViewModel.OverallStatusClass">
        @{
            var statusIcon = Model.ViewModel.OverallStatus.ToLowerInvariant() switch
            {
                "healthy" => @"<svg class=""w-4 h-4"" fill=""none"" viewBox=""0 0 24 24"" stroke=""currentColor""><path stroke-linecap=""round"" stroke-linejoin=""round"" stroke-width=""2"" d=""M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"" /></svg>",
                "warning" => @"<svg class=""w-4 h-4"" fill=""none"" viewBox=""0 0 24 24"" stroke=""currentColor""><path stroke-linecap=""round"" stroke-linejoin=""round"" stroke-width=""2"" d=""M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"" /></svg>",
                "critical" => @"<svg class=""w-4 h-4"" fill=""none"" viewBox=""0 0 24 24"" stroke=""currentColor""><path stroke-linecap=""round"" stroke-linejoin=""round"" stroke-width=""2"" d=""M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"" /></svg>",
                _ => @"<svg class=""w-4 h-4"" fill=""none"" viewBox=""0 0 24 24"" stroke=""currentColor""><path stroke-linecap=""round"" stroke-linejoin=""round"" stroke-width=""2"" d=""M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"" /></svg>"
            };
        }
        @Html.Raw(statusIcon)
        <span>@Model.ViewModel.OverallStatusText</span>
    </div>
</div>

<!-- Navigation Tabs with Time Range Selector -->
<div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
    @await Html.PartialAsync("Components/_PerformanceTabs", new DiscordBot.Bot.ViewModels.Components.PerformanceTabsViewModel
    {
        ActiveTab = "overview",
        ActiveAlertCount = Model.ViewModel.ActiveAlertCount,
        UseAjaxNavigation = true
    })

    <!-- Time Range Selector -->
    <div class="flex items-center gap-2">
        <span class="text-sm text-text-secondary mr-2">Time Range:</span>
        <button class="time-range-btn active" data-hours="24">24h</button>
        <button class="time-range-btn" data-hours="168">7d</button>
        <button class="time-range-btn" data-hours="720">30d</button>
    </div>
</div>

<!-- Tab Content Container (for AJAX-loaded content) -->
<div class="tab-panel" id="tabContent" role="tabpanel" data-performance-tabs>
    <!-- Content loaded via AJAX by performance-tabs.js -->
    <!-- Initial loading placeholder while waiting for AJAX response -->
    <div class="tab-loading-overlay">
        <div class="tab-loading-spinner">
            <svg class="animate-spin h-8 w-8" viewBox="0 0 24 24" aria-hidden="true">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="tab-loading-text">Loading...</span>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="~/js/realtime-ui.js"></script>
    <script src="~/js/performance-tabs.js"></script>
    <script>
        // Chart.js default dark theme settings
        Chart.defaults.color = '#a8a5a3';
        Chart.defaults.borderColor = '#3f4447';

        // Smart reconnect behavior foundation
        // Will be wired up to SignalR when DashboardHub is extended (issue #624)
        const RealtimeUI = {
            liveIndicatorId: 'liveIndicator',

            setLive(isLive) {
                const indicator = document.getElementById(this.liveIndicatorId);
                if (indicator) {
                    if (isLive) {
                        indicator.classList.remove('paused');
                    } else {
                        indicator.classList.add('paused');
                    }
                }
            },

            animateValueChange(elementId, newValue, formatter = null) {
                const element = document.getElementById(elementId);
                if (!element) return;

                const oldValue = element.textContent;
                const displayValue = formatter ? formatter(newValue) : String(newValue);
                element.textContent = displayValue;

                if (oldValue !== displayValue) {
                    element.classList.add('value-changed');
                    setTimeout(() => element.classList.remove('value-changed'), 500);
                }
            },

            // Called when SignalR reconnects
            async onReconnected() {
                this.setLive(true);

                // Refresh current tab
                if (window.PerformanceTabs) {
                    window.PerformanceTabs.refresh();
                }

                // Show reconnected toast
                if (typeof ToastManager !== 'undefined') {
                    ToastManager.show('success', 'Real-time updates restored', {
                        title: 'Reconnected',
                        duration: 3000
                    });
                }
            },

            // Called when SignalR disconnects
            onDisconnected() {
                this.setLive(false);

                if (typeof ToastManager !== 'undefined') {
                    ToastManager.show('warning', 'Attempting to reconnect...', {
                        title: 'Connection Lost',
                        duration: 5000
                    });
                }
            }
        };
    </script>
}
