@model DiscordBot.Bot.ViewModels.Pages.SystemHealthViewModel
@using DiscordBot.Bot.ViewModels.Pages

<div data-tab="system">

<!-- Database Performance Card -->
<div class="chart-card mb-6">
    <div class="chart-card-header">
        <div>
            <h2 class="chart-card-title">Database Performance</h2>
            <p class="chart-card-subtitle">Query execution and connection pool metrics</p>
        </div>
        <span class="status-badge status-badge-connected">Healthy</span>
    </div>
    <div class="chart-card-body">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <!-- Avg Query Time -->
            <div class="text-center p-4 bg-bg-tertiary rounded-lg">
                <div class="text-3xl font-bold text-text-primary @SystemHealthViewModel.GetQueryTimeStatusClass(Model.DatabaseMetrics.AvgQueryTimeMs)">
                    <span id="avgQueryTime">@Model.DatabaseMetrics.AvgQueryTimeMs.ToString("F0")</span><span class="text-lg font-normal text-text-secondary">ms</span>
                </div>
                <div class="text-sm text-text-secondary mt-1">Avg Query Time</div>
            </div>

            <!-- Total Queries -->
            <div class="text-center p-4 bg-bg-tertiary rounded-lg">
                <div class="text-3xl font-bold text-text-primary" id="totalQueries">@Model.DatabaseMetrics.TotalQueries.ToString("N0")</div>
                <div class="text-sm text-text-secondary mt-1">Total Queries</div>
            </div>

            <!-- Queries/sec -->
            <div class="text-center p-4 bg-bg-tertiary rounded-lg">
                <div class="text-3xl font-bold text-text-primary" id="queriesPerSecond">@Model.QueriesPerSecond.ToString("F1")</div>
                <div class="text-sm text-text-secondary mt-1">Queries/sec</div>
            </div>

            <!-- Slow Query Count -->
            <div class="text-center p-4 bg-bg-tertiary rounded-lg">
                <div class="text-3xl font-bold @(Model.DatabaseMetrics.SlowQueryCount > 10 ? "text-error" : Model.DatabaseMetrics.SlowQueryCount > 0 ? "text-warning" : "text-success")">
                    <span id="slowQueryCount">@Model.DatabaseMetrics.SlowQueryCount</span>
                </div>
                <div class="text-sm text-text-secondary mt-1">Slow Queries</div>
            </div>
        </div>

        <!-- Query Time Chart -->
        <div class="chart-container chart-container-sm">
            <canvas id="systemQueryTimeChart"></canvas>

            <!-- Loading State -->
            <div class="chart-loading hidden" id="systemQueryTimeLoading" role="status" aria-live="polite" aria-label="Loading chart data">
                <div class="flex items-center justify-center h-full">
                    <svg class="animate-spin h-8 w-8 text-brand" viewBox="0 0 24 24" aria-hidden="true">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            </div>

            <!-- Empty State -->
            <div class="chart-empty hidden" id="systemQueryTimeEmpty">
                <div class="flex flex-col items-center justify-center h-full text-text-tertiary">
                    <svg class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    <p>No data available for this time range</p>
                    <p class="text-sm mt-1">Data collection may still be initializing</p>
                </div>
            </div>

            <!-- Error State -->
            <div class="chart-error hidden" id="systemQueryTimeError">
                <div class="flex flex-col items-center justify-center h-full text-text-tertiary">
                    <svg class="h-12 w-12 mb-2 text-error" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p>Failed to load metrics</p>
                    <button class="mt-2 text-sm text-brand hover:underline chart-retry-btn" id="systemQueryTimeRetry">Retry</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Slow Queries Table -->
@if (Model.SlowQueries.Any())
{
    <div class="chart-card mb-6">
        <div class="chart-card-header">
            <div>
                <h2 class="chart-card-title">Slow Queries</h2>
                <p class="chart-card-subtitle">Queries exceeding 100ms threshold (last 24 hours)</p>
            </div>
            <span class="severity-badge severity-info">@Model.SlowQueries.Count slow queries</span>
        </div>
        <div class="overflow-x-auto">
            <table class="performance-table" id="slowQueriesTable">
                <thead>
                    <tr>
                        <th class="w-8"></th>
                        <th>Query</th>
                        <th>Duration</th>
                        <th>Timestamp</th>
                        <th>Parameters</th>
                    </tr>
                </thead>
                <tbody>
                    @{ var queryIndex = 0; }
                    @foreach (var query in Model.SlowQueries.Take(10))
                    {
                        var hasFullContent = query.CommandText.Length > 100 || (!string.IsNullOrEmpty(query.Parameters) && query.Parameters.Length > 50);
                        <tr class="@(hasFullContent ? "cursor-pointer hover:bg-bg-tertiary" : "")" data-query-row="@queryIndex" @(hasFullContent ? $"onclick=\"toggleQueryDetails({queryIndex})\"" : "")>
                            <td class="text-center">
                                @if (hasFullContent)
                                {
                                    <svg class="w-4 h-4 text-text-tertiary transition-transform duration-200" id="queryChevron-@queryIndex" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                    </svg>
                                }
                            </td>
                            <td>
                                <code class="text-mono text-xs text-text-secondary">@(query.CommandText.Length > 100 ? query.CommandText.Substring(0, 100) + "..." : query.CommandText)</code>
                            </td>
                            <td class="font-medium @(query.DurationMs > 500 ? "text-error" : "text-warning")">@query.DurationMs.ToString("F0")ms</td>
                            <td class="text-text-tertiary" data-utc-time="@query.Timestamp.ToString("o")">@query.Timestamp.ToString("MMM dd, HH:mm")</td>
                            <td class="text-xs text-text-tertiary">@(string.IsNullOrEmpty(query.Parameters) ? "(none)" : query.Parameters.Length > 50 ? query.Parameters.Substring(0, 50) + "..." : query.Parameters)</td>
                        </tr>
                        @if (hasFullContent)
                        {
                            <tr class="hidden bg-bg-tertiary" id="queryDetails-@queryIndex">
                                <td colspan="5" class="p-4">
                                    <div class="space-y-3">
                                        <div>
                                            <div class="text-xs font-medium text-text-secondary mb-1">Full Query</div>
                                            <pre class="text-xs text-text-primary bg-bg-secondary p-3 rounded-lg overflow-x-auto whitespace-pre-wrap break-all font-mono">@query.CommandText</pre>
                                        </div>
                                        @if (!string.IsNullOrEmpty(query.Parameters))
                                        {
                                            <div>
                                                <div class="text-xs font-medium text-text-secondary mb-1">Parameters</div>
                                                <pre class="text-xs text-text-primary bg-bg-secondary p-3 rounded-lg overflow-x-auto whitespace-pre-wrap break-all font-mono">@query.Parameters</pre>
                                            </div>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                        queryIndex++;
                    }
                </tbody>
            </table>
        </div>
    </div>
}

<!-- Background Services & Cache Status -->
<div class="performance-grid-2 mb-6">
    <!-- Background Services -->
    <div class="chart-card">
        <div class="chart-card-header">
            <div>
                <h2 class="chart-card-title">Background Services</h2>
                <p class="chart-card-subtitle">Hosted service status and health</p>
            </div>
        </div>
        <div class="chart-card-body p-0">
            <div class="divide-y divide-border-primary max-h-80 overflow-y-auto">
                @if (Model.BackgroundServices.Any())
                {
                    @foreach (var service in Model.BackgroundServices)
                    {
                        var statusClass = SystemHealthViewModel.GetServiceStatusClass(service.Status);
                        var isRunning = service.Status.Equals("Running", StringComparison.OrdinalIgnoreCase);
                        var statusText = service.Status;
                        var statusColor = service.Status.ToUpperInvariant() switch
                        {
                            "RUNNING" => "text-success",
                            "STARTING" => "text-warning",
                            "STOPPED" => "text-text-tertiary",
                            _ => "text-error"
                        };

                        <div class="p-4 flex items-center justify-between" data-service-name="@service.ServiceName">
                            <div class="flex items-center gap-3">
                                <div class="w-3 h-3 rounded-full service-status-dot @statusClass @(isRunning ? "animate-pulse" : "")"></div>
                                <div>
                                    <div class="font-medium text-text-primary">@service.ServiceName</div>
                                    <div class="text-xs text-error service-error @(string.IsNullOrEmpty(service.LastError) ? "hidden" : "")">@service.LastError</div>
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm font-medium service-status-text @statusColor">@statusText</div>
                                @if (service.LastHeartbeat.HasValue)
                                {
                                    var timeSinceHeartbeat = DateTime.UtcNow - service.LastHeartbeat.Value;
                                    <div class="text-xs text-text-tertiary service-heartbeat">
                                        @if (timeSinceHeartbeat.TotalMinutes < 1)
                                        {
                                            <span>@((int)timeSinceHeartbeat.TotalSeconds)s ago</span>
                                        }
                                        else if (timeSinceHeartbeat.TotalHours < 1)
                                        {
                                            <span>@((int)timeSinceHeartbeat.TotalMinutes)m ago</span>
                                        }
                                        else
                                        {
                                            <span>@((int)timeSinceHeartbeat.TotalHours)h ago</span>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <div class="text-xs text-text-tertiary service-heartbeat">Never</div>
                                }
                            </div>
                        </div>
                    }
                }
                else
                {
                    <div class="p-8 text-center text-text-tertiary">
                        No background services registered
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Cache Status -->
    <div class="chart-card">
        <div class="chart-card-header">
            <div>
                <h2 class="chart-card-title">Cache Performance</h2>
                <p class="chart-card-subtitle">In-memory cache hit rates</p>
            </div>
        </div>
        <div class="chart-card-body space-y-6">
            @if (Model.CacheStatsByPrefix.Any())
            {
                @foreach (var cache in Model.CacheStatsByPrefix)
                {
                    var hitRateClass = SystemHealthViewModel.GetCacheHitRateClass(cache.HitRate);
                    var colorClass = cache.HitRate switch
                    {
                        >= 90 => "text-success",
                        >= 70 => "text-warning",
                        _ => "text-error"
                    };

                    <div data-cache-name="@cache.KeyPrefix">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-text-primary">@cache.KeyPrefix</span>
                            <span class="text-sm @colorClass font-medium cache-hit-rate">@cache.HitRate.ToString("F1")%</span>
                        </div>
                        <div class="progress-bar-container progress-bar-lg">
                            <div class="progress-bar-fill @hitRateClass" style="width: @cache.HitRate.ToString("F1")%;"></div>
                        </div>
                        <div class="flex justify-between text-xs text-text-tertiary mt-1">
                            <span class="cache-hits">@cache.Hits.ToString("N0") hits / @cache.Misses.ToString("N0") misses</span>
                            <span class="cache-size">Size: @cache.Size items</span>
                        </div>
                    </div>
                }

                <!-- Total Cache Stats -->
                <div class="pt-4 border-t border-border-primary">
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div>
                            <div class="text-xl font-bold text-text-primary" id="totalCacheHits">@Model.OverallCacheStats.Hits.ToString("N0")</div>
                            <div class="text-xs text-text-tertiary">Total Hits</div>
                        </div>
                        <div>
                            <div class="text-xl font-bold text-text-primary" id="totalCacheMisses">@Model.OverallCacheStats.Misses.ToString("N0")</div>
                            <div class="text-xs text-text-tertiary">Total Misses</div>
                        </div>
                        <div>
                            <div class="text-xl font-bold text-text-primary" id="totalCacheItems">@Model.OverallCacheStats.Size</div>
                            <div class="text-xs text-text-tertiary">Total Items</div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="text-center py-8 text-text-tertiary">
                    No cache statistics available
                </div>
            }
        </div>
    </div>
</div>

<!-- Memory & GC Stats -->
<div class="chart-card">
    <div class="chart-card-header">
        <div>
            <h2 class="chart-card-title">Memory & Garbage Collection</h2>
            <p class="chart-card-subtitle">.NET runtime memory statistics</p>
        </div>
    </div>
    <div class="chart-card-body">
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6">
            <div class="text-center p-3 bg-bg-tertiary rounded-lg">
                <div class="text-xl font-bold text-text-primary">@Model.WorkingSetMB MB</div>
                <div class="text-xs text-text-tertiary">Working Set</div>
            </div>
            <div class="text-center p-3 bg-bg-tertiary rounded-lg">
                <div class="text-xl font-bold text-text-primary">@Model.PrivateMemoryMB MB</div>
                <div class="text-xs text-text-tertiary">Private Bytes</div>
            </div>
            <div class="text-center p-3 bg-bg-tertiary rounded-lg">
                <div class="text-xl font-bold text-text-primary">@Model.HeapSizeMB MB</div>
                <div class="text-xs text-text-tertiary">Heap Size</div>
            </div>
            <div class="text-center p-3 bg-bg-tertiary rounded-lg">
                <div class="text-xl font-bold text-text-primary">@Model.Gen0Collections.ToString("N0")</div>
                <div class="text-xs text-text-tertiary">Gen 0 Collections</div>
            </div>
            <div class="text-center p-3 bg-bg-tertiary rounded-lg">
                <div class="text-xl font-bold text-text-primary">@Model.Gen1Collections.ToString("N0")</div>
                <div class="text-xs text-text-tertiary">Gen 1 Collections</div>
            </div>
            <div class="text-center p-3 bg-bg-tertiary rounded-lg">
                <div class="text-xl font-bold text-text-primary">@Model.Gen2Collections</div>
                <div class="text-xs text-text-tertiary">Gen 2 Collections</div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="systemMemoryChart"></canvas>

            <!-- Loading State -->
            <div class="chart-loading hidden" id="systemMemoryLoading" role="status" aria-live="polite" aria-label="Loading chart data">
                <div class="flex items-center justify-center h-full">
                    <svg class="animate-spin h-8 w-8 text-brand" viewBox="0 0 24 24" aria-hidden="true">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            </div>

            <!-- Empty State -->
            <div class="chart-empty hidden" id="systemMemoryEmpty">
                <div class="flex flex-col items-center justify-center h-full text-text-tertiary">
                    <svg class="h-12 w-12 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                    <p>No data available for this time range</p>
                    <p class="text-sm mt-1">Data collection may still be initializing</p>
                </div>
            </div>

            <!-- Error State -->
            <div class="chart-error hidden" id="systemMemoryError">
                <div class="flex flex-col items-center justify-center h-full text-text-tertiary">
                    <svg class="h-12 w-12 mb-2 text-error" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p>Failed to load metrics</p>
                    <button class="mt-2 text-sm text-brand hover:underline chart-retry-btn" id="systemMemoryRetry">Retry</button>
                </div>
            </div>
        </div>
    </div>
</div>

</div>
@* JavaScript now loaded from external module: ~/js/performance/tabs/system.js *@
