@page
@model DiscordBot.Bot.Pages.Admin.Performance.AlertsModel
@using DiscordBot.Core.Enums
@using DiscordBot.Bot.ViewModels.Pages
@using DiscordBot.Bot.ViewModels.Components
@{
    ViewData["Title"] = "Alerts & Incidents";
    ViewData["Breadcrumbs"] = new List<(string Text, string? Url)>
    {
        ("Dashboard", "/"),
        ("Bot Performance", null),
        ("Alerts & Incidents", null)
    };
}

@section Styles {
    <link rel="stylesheet" href="~/css/performance-pages.css" />
}

<!-- Page Header -->
<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
    <div>
        <h1 class="text-2xl lg:text-3xl font-bold text-text-primary">Alerts & Incidents</h1>
        <p class="text-text-secondary mt-1">Active alerts, incident history, and alert configuration</p>
    </div>

    <div class="flex items-center gap-3">
        @if (Model.ViewModel.AlertSummary.ActiveCount > 0)
        {
            var severityClass = Model.ViewModel.AlertSummary.CriticalCount > 0 ? "severity-critical"
                : Model.ViewModel.AlertSummary.WarningCount > 0 ? "severity-warning"
                : "severity-info";
            <span class="severity-badge @severityClass">@Model.ViewModel.AlertSummary.ActiveCount Active Alert@(Model.ViewModel.AlertSummary.ActiveCount != 1 ? "s" : "")</span>
        }
    </div>
</div>

<!-- Display Success/Error Messages -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="mb-6 p-4 bg-success/10 border border-success/20 rounded-lg text-success">
        @TempData["SuccessMessage"]
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="mb-6 p-4 bg-error/10 border border-error/20 rounded-lg text-error">
        @TempData["ErrorMessage"]
    </div>
}

<!-- Navigation Tabs -->
@await Html.PartialAsync("Components/_PerformanceTabs", new PerformanceTabsViewModel
{
    ActiveTab = "alerts",
    ActiveAlertCount = Model.ViewModel.AlertSummary.ActiveCount
})

<!-- Tab Content -->
@await Html.PartialAsync("Tabs/_AlertsTab", Model.ViewModel)

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        // Chart.js default dark theme settings
        Chart.defaults.color = '#a8a5a3';
        Chart.defaults.borderColor = '#3f4447';

        let alertsRefreshInterval;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize the Alerts tab (function defined in partial)
            if (typeof window.initAlertsTab === 'function') {
                await window.initAlertsTab();
            }

            // Start auto-refresh for active alerts
            startAutoRefresh();
        });

        function startAutoRefresh() {
            alertsRefreshInterval = setInterval(async () => {
                try {
                    // Check active alerts count
                    const response = await fetch('/api/alerts/active');
                    if (response.ok) {
                        const activeCount = await response.json();
                        // Could update the header badge dynamically here
                    }
                } catch (error) {
                    console.error('Failed to refresh active alerts:', error);
                }
            }, 30000);
        }

        // Stop refresh when page hidden
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                if (alertsRefreshInterval) clearInterval(alertsRefreshInterval);
            } else {
                startAutoRefresh();
            }
        });

        // Warn before leaving if there are unsaved changes
        window.addEventListener('beforeunload', function(e) {
            if (typeof window.alertsTabHasUnsavedChanges === 'function' && window.alertsTabHasUnsavedChanges()) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
}
