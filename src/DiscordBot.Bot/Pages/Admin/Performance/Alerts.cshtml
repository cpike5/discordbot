@page
@model DiscordBot.Bot.Pages.Admin.Performance.AlertsModel
@using DiscordBot.Core.Enums
@using DiscordBot.Bot.ViewModels.Pages
@{
    ViewData["Title"] = "Alerts & Incidents";
    ViewData["Breadcrumbs"] = new List<(string Text, string? Url)>
    {
        ("Dashboard", "/"),
        ("Bot Performance", null),
        ("Alerts & Incidents", null)
    };
}

@section Styles {
    <style>
        /* Performance Page Shared Styles */
        .performance-tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid rgb(63, 68, 71);
            margin-bottom: 1.5rem;
            overflow-x: auto;
            scrollbar-width: thin;
        }

        .performance-tab {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: rgb(168, 165, 163);
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
            white-space: nowrap;
            text-decoration: none;
        }

        .performance-tab:hover {
            color: rgb(215, 211, 208);
            border-bottom-color: rgb(99, 102, 104);
        }

        .performance-tab.active {
            color: rgb(9, 142, 207);
            border-bottom-color: rgb(9, 142, 207);
        }

        .tab-icon {
            width: 1.25rem;
            height: 1.25rem;
        }

        /* Chart Card */
        .chart-card {
            background: rgb(35, 38, 40);
            border: 1px solid rgb(63, 68, 71);
            border-radius: 0.5rem;
            overflow: hidden;
        }

        .chart-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem;
            border-bottom: 1px solid rgb(63, 68, 71);
        }

        .chart-card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: rgb(215, 211, 208);
            margin: 0;
        }

        .chart-card-subtitle {
            font-size: 0.875rem;
            color: rgb(168, 165, 163);
            margin: 0.25rem 0 0;
        }

        .chart-card-body {
            padding: 1.25rem;
        }

        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Severity Badges */
        .severity-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .severity-critical {
            background: rgba(239, 68, 68, 0.1);
            color: rgb(239, 68, 68);
        }

        .severity-warning {
            background: rgba(245, 158, 11, 0.1);
            color: rgb(245, 158, 11);
        }

        .severity-info {
            background: rgba(9, 142, 207, 0.1);
            color: rgb(9, 142, 207);
        }

        /* Alert Card */
        .alert-card {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1rem;
            border: 1px solid rgb(63, 68, 71);
            border-radius: 0.5rem;
            background: rgb(35, 38, 40);
        }

        .alert-card-warning {
            border-left: 4px solid rgb(245, 158, 11);
        }

        .alert-card-critical {
            border-left: 4px solid rgb(239, 68, 68);
        }

        .alert-card-info {
            border-left: 4px solid rgb(9, 142, 207);
        }

        .alert-icon {
            width: 1.5rem;
            height: 1.5rem;
        }

        .alert-icon-warning {
            color: rgb(245, 158, 11);
        }

        .alert-icon-critical {
            color: rgb(239, 68, 68);
        }

        .alert-icon-info {
            color: rgb(9, 142, 207);
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-size: 0.9375rem;
            font-weight: 600;
            color: rgb(215, 211, 208);
            margin-bottom: 0.25rem;
        }

        .alert-description {
            font-size: 0.875rem;
            color: rgb(168, 165, 163);
            margin-bottom: 0.75rem;
        }

        .alert-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.75rem;
            color: rgb(120, 116, 113);
        }

        .alert-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 2rem;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 0;
            bottom: 0;
            width: 2px;
            background: rgb(47, 51, 54);
        }

        .timeline-entry {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .timeline-entry:last-child {
            margin-bottom: 0;
        }

        .timeline-dot {
            position: absolute;
            left: -1.625rem;
            width: 0.75rem;
            height: 0.75rem;
            border-radius: 9999px;
            border: 2px solid rgb(35, 38, 40);
        }

        .timeline-dot-success {
            background: rgb(16, 185, 129);
        }

        .timeline-dot-warning {
            background: rgb(245, 158, 11);
        }

        .timeline-dot-error {
            background: rgb(239, 68, 68);
        }

        .timeline-dot-info {
            background: rgb(9, 142, 207);
        }

        .timeline-content {
            padding-left: 0.5rem;
        }

        .timeline-time {
            font-size: 0.75rem;
            color: rgb(120, 116, 113);
            margin-bottom: 0.25rem;
        }

        .timeline-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: rgb(215, 211, 208);
            margin-bottom: 0.25rem;
        }

        .timeline-description {
            font-size: 0.875rem;
            color: rgb(168, 165, 163);
        }

        /* Config Table */
        .config-table {
            width: 100%;
            border-collapse: collapse;
        }

        .config-table th {
            text-align: left;
            padding: 0.75rem 1rem;
            background: rgb(47, 51, 54);
            color: rgb(168, 165, 163);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid rgb(63, 68, 71);
        }

        .config-table td {
            padding: 1rem;
            border-bottom: 1px solid rgb(63, 68, 71);
            color: rgb(168, 165, 163);
        }

        .config-table tbody tr:hover {
            background: rgba(47, 51, 54, 0.5);
        }

        .config-table input[type="number"] {
            width: 5rem;
            padding: 0.375rem 0.5rem;
            background: rgb(47, 51, 54);
            border: 1px solid rgb(63, 68, 71);
            border-radius: 0.25rem;
            color: rgb(215, 211, 208);
            font-size: 0.875rem;
        }

        .config-table input[type="number"]:focus {
            outline: none;
            border-color: rgb(9, 142, 207);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgb(63, 68, 71);
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: rgb(9, 142, 207);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
        }

        .empty-state-icon {
            width: 3rem;
            height: 3rem;
            margin: 0 auto 1rem;
            color: rgb(120, 116, 113);
        }

        .empty-state-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: rgb(215, 211, 208);
            margin-bottom: 0.5rem;
        }

        .empty-state-description {
            font-size: 0.875rem;
            color: rgb(168, 165, 163);
        }

        /* Grid Layout for Two Columns */
        .performance-grid-2 {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @@media (min-width: 1024px) {
            .performance-grid-2 {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Status Badges */
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: rgb(16, 185, 129);
        }

        .status-badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: rgb(245, 158, 11);
        }

        .status-badge-error {
            background: rgba(239, 68, 68, 0.1);
            color: rgb(239, 68, 68);
        }

        .status-badge-secondary {
            background: rgba(168, 165, 163, 0.1);
            color: rgb(168, 165, 163);
        }
    </style>
}

<!-- Page Header -->
<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
    <div>
        <h1 class="text-2xl lg:text-3xl font-bold text-text-primary">Alerts & Incidents</h1>
        <p class="text-text-secondary mt-1">Active alerts, incident history, and alert configuration</p>
    </div>

    <div class="flex items-center gap-3">
        @if (Model.ViewModel.AlertSummary.ActiveCount > 0)
        {
            var severityClass = Model.ViewModel.AlertSummary.CriticalCount > 0 ? "severity-critical"
                : Model.ViewModel.AlertSummary.WarningCount > 0 ? "severity-warning"
                : "severity-info";
            <span class="severity-badge @severityClass">@Model.ViewModel.AlertSummary.ActiveCount Active Alert@(Model.ViewModel.AlertSummary.ActiveCount != 1 ? "s" : "")</span>
        }
    </div>
</div>

<!-- Display Success/Error Messages -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="mb-6 p-4 bg-success/10 border border-success/20 rounded-lg text-success">
        @TempData["SuccessMessage"]
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="mb-6 p-4 bg-error/10 border border-error/20 rounded-lg text-error">
        @TempData["ErrorMessage"]
    </div>
}

<!-- Navigation Tabs -->
<div class="performance-tabs mb-6">
    <a href="/Admin/Performance" class="performance-tab">
        <svg class="tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
        Overview
    </a>
    <a href="/Admin/Performance/HealthMetrics" class="performance-tab">
        <svg class="tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
        </svg>
        Health Metrics
    </a>
    <a href="/Admin/Performance/Commands" class="performance-tab">
        <svg class="tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
        Commands
    </a>
    <a href="/Admin/Performance/ApiMetrics" class="performance-tab">
        <svg class="tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
        </svg>
        API & Rate Limits
    </a>
    <a href="/Admin/Performance/SystemHealth" class="performance-tab">
        <svg class="tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
        </svg>
        System
    </a>
    <a href="/Admin/Performance/Alerts" class="performance-tab active">
        <svg class="tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
        </svg>
        Alerts
        @if (Model.ViewModel.AlertSummary.ActiveCount > 0)
        {
            <span class="ml-1 px-1.5 py-0.5 text-xs font-bold bg-warning/20 text-warning rounded-full">@Model.ViewModel.AlertSummary.ActiveCount</span>
        }
    </a>
</div>

<!-- Active Alerts Section -->
<div class="chart-card mb-6">
    <div class="chart-card-header">
        <div>
            <h2 class="chart-card-title">Active Alerts</h2>
            <p class="chart-card-subtitle">Current issues requiring attention</p>
        </div>
        @if (Model.ViewModel.ActiveIncidents.Any() && (User.IsInRole("Admin") || User.IsInRole("SuperAdmin")))
        {
            <form method="post" asp-page-handler="AcknowledgeAll">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-sm btn-secondary">
                    Acknowledge All
                </button>
            </form>
        }
    </div>
    <div class="chart-card-body p-0">
        @if (Model.ViewModel.ActiveIncidents.Any())
        {
            <div class="divide-y divide-border-primary">
                @foreach (var incident in Model.ViewModel.ActiveIncidents)
                {
                    var alertClass = incident.Severity switch
                    {
                        AlertSeverity.Critical => "alert-card-critical",
                        AlertSeverity.Warning => "alert-card-warning",
                        _ => "alert-card-info"
                    };
                    var iconClass = incident.Severity switch
                    {
                        AlertSeverity.Critical => "alert-icon-critical",
                        AlertSeverity.Warning => "alert-icon-warning",
                        _ => "alert-icon-info"
                    };

                    <div class="alert-card border-0 rounded-none @alertClass">
                        <svg class="alert-icon @iconClass flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            @if (incident.Severity == AlertSeverity.Critical)
                            {
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                            }
                            else
                            {
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                            }
                        </svg>
                        <div class="alert-content flex-1">
                            <div class="alert-title">@incident.Message</div>
                            <div class="alert-description">Metric: @incident.MetricName | Threshold: @incident.ThresholdValue | Actual: @incident.ActualValue</div>
                            <div class="alert-meta">
                                <span class="severity-badge @AlertsPageViewModel.GetSeverityClass(incident.Severity)">@incident.Severity</span>
                                @if (incident.IsAcknowledged)
                                {
                                    <span class="status-badge status-badge-secondary">Acknowledged</span>
                                    @if (!string.IsNullOrEmpty(incident.AcknowledgedBy))
                                    {
                                        <span class="text-text-tertiary">by @incident.AcknowledgedBy</span>
                                    }
                                }
                                <span data-utc-time="@incident.TriggeredAt.ToString("o")" data-format="relative">Triggered @AlertsPageViewModel.FormatRelativeTime(incident.TriggeredAt)</span>
                            </div>
                        </div>
                        @if ((User.IsInRole("Admin") || User.IsInRole("SuperAdmin")) && !incident.IsAcknowledged)
                        {
                            <div class="alert-actions flex items-center gap-2">
                                <form method="post" asp-page-handler="Acknowledge" asp-route-id="@incident.Id">
                                    @Html.AntiForgeryToken()
                                    <button type="submit" class="btn btn-sm btn-secondary">Acknowledge</button>
                                </form>
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <div class="empty-state py-12">
                <svg class="empty-state-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div class="empty-state-title">No Active Alerts</div>
                <div class="empty-state-description">All systems are operating within normal parameters.</div>
            </div>
        }
    </div>
</div>

<!-- Alert Thresholds Configuration -->
<div class="chart-card mb-6">
    <div class="chart-card-header">
        <div>
            <h2 class="chart-card-title">Alert Threshold Configuration</h2>
            <p class="chart-card-subtitle">Define warning and critical thresholds for key metrics</p>
        </div>
        @if (User.IsInRole("Admin") || User.IsInRole("SuperAdmin"))
        {
            <button id="saveConfigBtn"
                    type="button"
                    onclick="saveConfigChanges()"
                    class="btn btn-primary hidden"
                    style="display: none;">
                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                Save Changes
            </button>
        }
    </div>
    <div class="overflow-x-auto">
        <table class="config-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Warning Threshold</th>
                    <th>Critical Threshold</th>
                    <th>Current Value</th>
                    <th>Enabled</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var config in Model.ViewModel.AlertConfigs)
                {
                    var currentValueClass = "text-success";
                    if (config.CurrentValue.HasValue)
                    {
                        if (config.CriticalThreshold.HasValue && config.CurrentValue >= config.CriticalThreshold)
                        {
                            currentValueClass = "text-error";
                        }
                        else if (config.WarningThreshold.HasValue && config.CurrentValue >= config.WarningThreshold)
                        {
                            currentValueClass = "text-warning";
                        }
                    }

                    <tr data-metric="@config.MetricName">
                        <td>
                            <div class="font-medium text-text-primary">@config.DisplayName</div>
                            @if (!string.IsNullOrEmpty(config.Description))
                            {
                                <div class="text-xs text-text-tertiary">@config.Description</div>
                            }
                        </td>
                        <td>
                            <div class="flex items-center gap-2">
                                <input type="number"
                                       value="@config.WarningThreshold"
                                       min="0"
                                       data-field="warning"
                                       class="threshold-input" />
                                <span class="text-text-secondary">@config.ThresholdUnit</span>
                            </div>
                        </td>
                        <td>
                            <div class="flex items-center gap-2">
                                <input type="number"
                                       value="@config.CriticalThreshold"
                                       min="0"
                                       data-field="critical"
                                       class="threshold-input" />
                                <span class="text-text-secondary">@config.ThresholdUnit</span>
                            </div>
                        </td>
                        <td>
                            <span class="@currentValueClass font-medium">
                                @(config.CurrentValue?.ToString("F2") ?? "N/A")@config.ThresholdUnit
                            </span>
                        </td>
                        <td>
                            <label class="toggle-switch">
                                <input type="checkbox"
                                       @(config.IsEnabled ? "checked" : "")
                                       data-field="enabled"
                                       class="enabled-toggle">
                                <span class="toggle-slider"></span>
                            </label>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

<!-- Incident History & Auto-Recovery -->
<div class="performance-grid-2 mb-6">
    <!-- Incident History Timeline -->
    <div class="chart-card">
        <div class="chart-card-header">
            <div>
                <h2 class="chart-card-title">Incident History</h2>
                <p class="chart-card-subtitle">Recent incidents and resolutions</p>
            </div>
        </div>
        <div class="chart-card-body">
            @if (Model.ViewModel.RecentIncidents.Any())
            {
                <div class="timeline">
                    @foreach (var incident in Model.ViewModel.RecentIncidents)
                    {
                        <div class="timeline-entry">
                            <div class="timeline-dot @AlertsPageViewModel.GetTimelineDotClass(incident.Severity)"></div>
                            <div class="timeline-content">
                                <div class="timeline-time" data-utc-time="@incident.TriggeredAt.ToString("o")">
                                    @incident.TriggeredAt.ToString("MMM dd, yyyy 'at' HH:mm") UTC
                                </div>
                                <div class="timeline-title">@incident.Message</div>
                                <div class="timeline-description">
                                    <span class="severity-badge @AlertsPageViewModel.GetSeverityClass(incident.Severity) mr-2">@incident.Severity</span>
                                    Duration: @AlertsPageViewModel.FormatDuration(incident.DurationSeconds)
                                    @if (incident.Status == IncidentStatus.Resolved)
                                    {
                                        <span class="ml-2">- Auto-resolved</span>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-8">
                    <svg class="w-12 h-12 mx-auto mb-3 text-text-tertiary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div class="text-text-secondary font-medium">No incidents</div>
                    <div class="text-text-tertiary text-sm">No recent incidents to display</div>
                </div>
            }
        </div>
    </div>

    <!-- Auto-Recovery Event Log -->
    <div class="chart-card">
        <div class="chart-card-header">
            <div>
                <h2 class="chart-card-title">Auto-Recovery Events</h2>
                <p class="chart-card-subtitle">Automatic issue detection and remediation</p>
            </div>
        </div>
        <div class="chart-card-body p-0">
            @if (Model.ViewModel.AutoRecoveryEvents.Any())
            {
                <div class="divide-y divide-border-primary max-h-96 overflow-y-auto">
                    @foreach (var evt in Model.ViewModel.AutoRecoveryEvents)
                    {
                        <div class="p-4">
                            <div class="flex items-start gap-3">
                                <div class="w-8 h-8 rounded-full bg-success/10 flex items-center justify-center flex-shrink-0">
                                    <svg class="w-4 h-4 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                </div>
                                <div class="flex-1">
                                    <div class="flex items-center justify-between">
                                        <span class="font-medium text-text-primary">@evt.MetricName</span>
                                        <span class="text-xs text-text-tertiary" data-utc-time="@evt.Timestamp.ToString("o")" data-format="relative">
                                            @AlertsPageViewModel.FormatRelativeTime(evt.Timestamp)
                                        </span>
                                    </div>
                                    <div class="text-sm text-text-secondary mt-1">
                                        <span class="text-warning">Issue:</span> @evt.Issue
                                    </div>
                                    <div class="text-sm text-text-secondary">
                                        <span class="text-accent-blue">Action:</span> @evt.Action
                                    </div>
                                    <div class="text-sm text-text-secondary">
                                        <span class="text-success">Result:</span> @evt.Result
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="p-4 bg-bg-tertiary border-t border-border-primary">
                    <div class="flex items-center justify-between text-sm">
                        <span class="text-text-secondary">
                            <span class="font-medium text-text-primary">@Model.ViewModel.AutoRecoveryEvents.Count</span> auto-recovery events
                        </span>
                    </div>
                </div>
            }
            else
            {
                <div class="empty-state py-12">
                    <svg class="empty-state-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div class="empty-state-title">No Auto-Recovery Events</div>
                    <div class="empty-state-description">No automatic recoveries have occurred</div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Alert Frequency Chart -->
<div class="chart-card">
    <div class="chart-card-header">
        <div>
            <h2 class="chart-card-title">Alert Frequency</h2>
            <p class="chart-card-subtitle">Alerts triggered over the last 30 days</p>
        </div>
    </div>
    <div class="chart-card-body">
        <div class="chart-container">
            <canvas id="alertFrequencyChart"></canvas>
        </div>
        <div class="flex justify-center gap-6 mt-4">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded bg-error"></div>
                <span class="text-sm text-text-secondary">Critical (@Model.ViewModel.AlertFrequencyData.Sum(d => d.CriticalCount))</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded bg-warning"></div>
                <span class="text-sm text-text-secondary">Warning (@Model.ViewModel.AlertFrequencyData.Sum(d => d.WarningCount))</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded bg-info"></div>
                <span class="text-sm text-text-secondary">Info (@Model.ViewModel.AlertFrequencyData.Sum(d => d.InfoCount))</span>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script>
        // Chart.js default dark theme settings
        Chart.defaults.color = '#a8a5a3';
        Chart.defaults.borderColor = '#3f4447';

        let alertFrequencyChart;

        // Convert UTC timestamps to local timezone
        function convertTimestampsToLocal() {
            const timestampElements = document.querySelectorAll('[data-utc-time]');
            timestampElements.forEach(element => {
                const utcTime = element.getAttribute('data-utc-time');
                const format = element.getAttribute('data-format');
                if (utcTime) {
                    try {
                        const date = new Date(utcTime);

                        if (format === 'relative') {
                            // For relative times, calculate the difference and format as "X ago"
                            const now = new Date();
                            const elapsed = now - date;
                            const seconds = Math.floor(elapsed / 1000);
                            const minutes = Math.floor(seconds / 60);
                            const hours = Math.floor(minutes / 60);
                            const days = Math.floor(hours / 24);
                            const months = Math.floor(days / 30);

                            let relativeText;
                            if (months >= 1) {
                                relativeText = months === 1 ? '1 month ago' : `${months} months ago`;
                            } else if (days >= 1) {
                                relativeText = days === 1 ? '1 day ago' : `${days} days ago`;
                            } else if (hours >= 1) {
                                relativeText = hours === 1 ? '1 hour ago' : `${hours} hours ago`;
                            } else if (minutes >= 1) {
                                relativeText = minutes === 1 ? '1 minute ago' : `${minutes} minutes ago`;
                            } else {
                                relativeText = 'Just now';
                            }

                            // Preserve any prefix text like "Triggered "
                            const currentText = element.textContent.trim();
                            const triggeredPrefix = currentText.startsWith('Triggered') ? 'Triggered ' : '';
                            element.textContent = triggeredPrefix + relativeText;
                        } else {
                            // For absolute times, format as local date/time
                            const formatted = date.toLocaleDateString('en-US', {
                                month: 'short',
                                day: '2-digit',
                                year: 'numeric'
                            }) + ' at ' + date.toLocaleTimeString('en-US', {
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false
                            });
                            element.textContent = formatted;
                        }
                    } catch (e) {
                        console.error('Failed to parse timestamp:', utcTime, e);
                    }
                }
            });
        }

        // Initialize Alert Frequency Chart
        function initAlertFrequencyChart() {
            const ctx = document.getElementById('alertFrequencyChart');
            if (!ctx) return;

            const data = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ViewModel.AlertFrequencyData));

            const labels = data.map(d => {
                const date = new Date(d.date);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            });

            const criticalData = data.map(d => d.criticalCount);
            const warningData = data.map(d => d.warningCount);
            const infoData = data.map(d => d.infoCount);

            alertFrequencyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Critical',
                            data: criticalData,
                            backgroundColor: '#ef4444',
                            borderRadius: 2
                        },
                        {
                            label: 'Warning',
                            data: warningData,
                            backgroundColor: '#f59e0b',
                            borderRadius: 2
                        },
                        {
                            label: 'Info',
                            data: infoData,
                            backgroundColor: '#098ecf',
                            borderRadius: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: '#2f3336',
                            titleColor: '#d7d3d0',
                            bodyColor: '#a8a5a3',
                            borderColor: '#3f4447',
                            borderWidth: 1,
                            padding: 12
                        }
                    },
                    scales: {
                        x: {
                            stacked: true,
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45,
                                autoSkip: true,
                                maxTicksLimit: 15
                            }
                        },
                        y: {
                            stacked: true,
                            beginAtZero: true,
                            grid: {
                                color: '#2f3336'
                            },
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }

        // Configuration change tracking
        let configChanges = {};

        function trackConfigChange(metricName, field, value) {
            if (!configChanges[metricName]) {
                configChanges[metricName] = {};
            }
            configChanges[metricName][field] = value;
            updateSaveButtonVisibility();
            updateCurrentValueColor(metricName);
        }

        function updateCurrentValueColor(metricName) {
            const row = document.querySelector(`tr[data-metric="${metricName}"]`);
            if (!row) return;

            const warningInput = row.querySelector('input[data-field="warning"]');
            const criticalInput = row.querySelector('input[data-field="critical"]');
            const currentValueSpan = row.querySelector('td:nth-child(4) span');

            if (!currentValueSpan) return;

            // Extract current value from the span text (e.g., "85.50%" -> 85.50)
            const currentText = currentValueSpan.textContent.trim();
            const currentValue = parseFloat(currentText);

            if (isNaN(currentValue)) return; // N/A case

            const warningThreshold = warningInput ? parseFloat(warningInput.value) : null;
            const criticalThreshold = criticalInput ? parseFloat(criticalInput.value) : null;

            // Remove existing color classes
            currentValueSpan.classList.remove('text-success', 'text-warning', 'text-error');

            // Apply new color based on thresholds
            if (criticalThreshold !== null && !isNaN(criticalThreshold) && currentValue >= criticalThreshold) {
                currentValueSpan.classList.add('text-error');
            } else if (warningThreshold !== null && !isNaN(warningThreshold) && currentValue >= warningThreshold) {
                currentValueSpan.classList.add('text-warning');
            } else {
                currentValueSpan.classList.add('text-success');
            }
        }

        function hasUnsavedChanges() {
            return Object.keys(configChanges).length > 0;
        }

        function updateSaveButtonVisibility() {
            const saveBtn = document.getElementById('saveConfigBtn');
            if (saveBtn) {
                if (hasUnsavedChanges()) {
                    saveBtn.style.display = 'inline-flex';
                    saveBtn.classList.remove('hidden');
                } else {
                    saveBtn.style.display = 'none';
                    saveBtn.classList.add('hidden');
                }
            }
        }

        async function saveConfigChanges() {
            if (!hasUnsavedChanges()) return;

            const saveBtn = document.getElementById('saveConfigBtn');

            // Disable button and show saving state
            if (saveBtn) {
                saveBtn.disabled = true;
                saveBtn.innerHTML = `
                    <svg class="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Saving...
                `;
            }

            const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
            const token = tokenElement ? tokenElement.value : '';

            let hasError = false;
            for (const [metricName, changes] of Object.entries(configChanges)) {
                try {
                    const response = await fetch(`/api/alerts/config/${encodeURIComponent(metricName)}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token
                        },
                        body: JSON.stringify(changes)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.message || `Failed to update ${metricName}`);
                    }
                } catch (error) {
                    console.error('Failed to save config changes:', error);
                    hasError = true;
                    showNotification(`Failed to save configuration for ${metricName}. Please try again.`, 'error');
                    break;
                }
            }

            if (!hasError) {
                configChanges = {};
                showNotification('Alert thresholds saved successfully.', 'success');
                updateSaveButtonVisibility();
            }

            // Reset button state
            if (saveBtn) {
                saveBtn.disabled = false;
                saveBtn.innerHTML = `
                    <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    Save Changes
                `;
            }
        }

        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg shadow-lg max-w-md transform transition-all duration-300 translate-x-full ${
                type === 'success' ? 'bg-success/10 border border-success/20 text-success' : 'bg-error/10 border border-error/20 text-error'
            }`;
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        ${type === 'success'
                            ? '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />'
                            : '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />'}
                    </svg>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);

            // Animate in
            requestAnimationFrame(() => {
                notification.classList.remove('translate-x-full');
            });

            // Remove after 4 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            convertTimestampsToLocal();
            initAlertFrequencyChart();

            // Track config changes
            const thresholdInputs = document.querySelectorAll('.threshold-input');
            const enabledToggles = document.querySelectorAll('.enabled-toggle');

            // Map HTML data-field values to API property names
            const fieldNameMap = {
                'warning': 'warningThreshold',
                'critical': 'criticalThreshold',
                'enabled': 'isEnabled'
            };

            thresholdInputs.forEach(input => {
                // Use 'input' event for immediate feedback while typing
                input.addEventListener('input', function() {
                    const row = this.closest('tr');
                    const metricName = row.dataset.metric;
                    const field = fieldNameMap[this.dataset.field];
                    const value = parseFloat(this.value);
                    trackConfigChange(metricName, field, value);
                });
            });

            enabledToggles.forEach(input => {
                input.addEventListener('change', function() {
                    const row = this.closest('tr');
                    const metricName = row.dataset.metric;
                    const field = fieldNameMap[this.dataset.field];
                    const value = this.checked;
                    trackConfigChange(metricName, field, value);
                });
            });

            // Auto-refresh active alerts every 30 seconds
            setInterval(async function() {
                try {
                    const response = await fetch('/api/alerts/active');
                    if (response.ok) {
                        const activeCount = await response.json();
                        // Could update the UI here without full page reload
                    }
                } catch (error) {
                    console.error('Failed to refresh active alerts:', error);
                }
            }, 30000);
        });

        // Warn before leaving if there are unsaved changes
        window.addEventListener('beforeunload', function(e) {
            if (hasUnsavedChanges()) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
}
