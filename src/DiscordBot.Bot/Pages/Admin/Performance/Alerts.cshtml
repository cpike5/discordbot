@page
@model DiscordBot.Bot.Pages.Admin.Performance.AlertsModel
@using DiscordBot.Core.Enums
@using DiscordBot.Bot.ViewModels.Pages
@using DiscordBot.Bot.ViewModels.Components
@{
    ViewData["Title"] = "Alerts & Incidents";
    ViewData["Breadcrumbs"] = new List<(string Text, string? Url)>
    {
        ("Dashboard", "/"),
        ("Bot Performance", null),
        ("Alerts & Incidents", null)
    };
}

@section Styles {
    <link rel="stylesheet" href="~/css/performance-pages.css" />
    <link rel="stylesheet" href="~/css/tab-panel.css" asp-append-version="true" />
    <style>
        /* Alert animation styles */
        .alert-entering {
            animation: alertSlideIn 0.5s ease-out;
        }
        .alert-exiting {
            animation: alertSlideOut 0.3s ease-in forwards;
        }
        .alert-highlight {
            animation: alertPulse 0.5s ease-in-out 3;
        }
        @@keyframes alertSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @@keyframes alertSlideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        @@keyframes alertPulse {
            0%, 100% {
                background-color: inherit;
            }
            50% {
                background-color: rgba(var(--color-accent-blue-rgb), 0.2);
            }
        }
        /* Live indicator styles */
        #alertsLiveIndicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        #alertsLiveIndicator .live-dot {
            width: 8px;
            height: 8px;
            background-color: rgb(16, 185, 129);
            border-radius: 50%;
            animation: livePulse 2s infinite;
        }
        #alertsLiveIndicator.paused .live-dot {
            background-color: rgb(107, 114, 128);
            animation: none;
        }
        #alertsLiveIndicator.flash .live-dot {
            animation: liveFlash 0.3s ease-out;
        }
        @@keyframes livePulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        @@keyframes liveFlash {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% {
                transform: scale(1.2);
                box-shadow: 0 0 0 8px rgba(16, 185, 129, 0);
            }
            100% {
                transform: scale(1);
            }
        }
    </style>
}

<!-- Page Header -->
<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
    <div>
        <h1 class="text-2xl lg:text-3xl font-bold text-text-primary">Alerts & Incidents</h1>
        <p class="text-text-secondary mt-1">Active alerts, incident history, and alert configuration</p>
    </div>

    <div class="flex items-center gap-3">
        <span id="alertsLiveIndicator" class="hidden text-sm text-text-secondary">
            <span class="live-dot"></span>
            <span>Live</span>
        </span>
        @if (Model.ViewModel.AlertSummary.ActiveCount > 0)
        {
            var severityClass = Model.ViewModel.AlertSummary.CriticalCount > 0 ? "severity-critical"
                : Model.ViewModel.AlertSummary.WarningCount > 0 ? "severity-warning"
                : "severity-info";
            <span class="severity-badge @severityClass">@Model.ViewModel.AlertSummary.ActiveCount Active Alert@(Model.ViewModel.AlertSummary.ActiveCount != 1 ? "s" : "")</span>
        }
    </div>
</div>

<!-- Display Success/Error Messages -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="mb-6 p-4 bg-success/10 border border-success/20 rounded-lg text-success">
        @TempData["SuccessMessage"]
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="mb-6 p-4 bg-error/10 border border-error/20 rounded-lg text-error">
        @TempData["ErrorMessage"]
    </div>
}

@if (!Model.CanEdit)
{
    <div class="mb-6 p-4 bg-warning/10 border border-warning/20 rounded-lg text-warning text-sm flex items-center gap-2">
        <svg class="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
        <span>You have read-only access to this page. Admin privileges are required to modify alert settings.</span>
    </div>
}

<!-- Navigation Tabs -->
@{
    var performanceTabs = new TabPanelViewModel
    {
        Id = "performanceTabs",
        StyleVariant = TabStyleVariant.Underline,
        NavigationMode = TabNavigationMode.PageNavigation,
        PersistenceMode = TabPersistenceMode.None,
        AriaLabel = "Performance sections",
        ActiveTabId = "alerts",
        Tabs = new List<TabItemViewModel>
        {
            new() { Id = "overview", Label = "Overview", Href = "/Admin/Performance",
                IconPathOutline = "M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z",
                IconPathSolid = "M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zm6-4a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zm6-3a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" },
            new() { Id = "health", Label = "Health Metrics", ShortLabel = "Health", Href = "/Admin/Performance/HealthMetrics",
                IconPathOutline = "M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z",
                IconPathSolid = "M3.172 5.172a4 4 0 015.656 0L12 8.343l3.172-3.171a4 4 0 115.656 5.656L12 19.657l-8.828-8.829a4 4 0 010-5.656z" },
            new() { Id = "commands", Label = "Commands", Href = "/Admin/Performance/Commands",
                IconPathOutline = "M13 10V3L4 14h7v7l9-11h-7z",
                IconPathSolid = "M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" },
            new() { Id = "api", Label = "API & Rate Limits", ShortLabel = "API", Href = "/Admin/Performance/ApiMetrics",
                IconPathOutline = "M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z",
                IconPathSolid = "M14.447 3.027a.75.75 0 01.527.92l-4.5 16.5a.75.75 0 01-1.448-.394l4.5-16.5a.75.75 0 01.921-.526zM16.72 6.22a.75.75 0 011.06 0l5.25 5.25a.75.75 0 010 1.06l-5.25 5.25a.75.75 0 11-1.06-1.06L21.44 12l-4.72-4.72a.75.75 0 010-1.06zm-9.44 0a.75.75 0 010 1.06L2.56 12l4.72 4.72a.75.75 0 11-1.06 1.06L.97 12.53a.75.75 0 010-1.06l5.25-5.25a.75.75 0 011.06 0z" },
            new() { Id = "system", Label = "System Health", ShortLabel = "System", Href = "/Admin/Performance/SystemHealth",
                IconPathOutline = "M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01",
                IconPathSolid = "M4.5 3A1.5 1.5 0 003 4.5v4A1.5 1.5 0 004.5 10h11a1.5 1.5 0 001.5-1.5v-4A1.5 1.5 0 0015.5 3h-11zm0 11A1.5 1.5 0 003 15.5v4A1.5 1.5 0 004.5 21h11a1.5 1.5 0 001.5-1.5v-4a1.5 1.5 0 00-1.5-1.5h-11zM13 7a1 1 0 100-2 1 1 0 000 2zm-3 0a1 1 0 100-2 1 1 0 000 2zm6 11a1 1 0 100-2 1 1 0 000 2zm-3 0a1 1 0 100-2 1 1 0 000 2z" },
            new() { Id = "alerts", Label = "Alerts", Href = "/Admin/Performance/Alerts",
                IconPathOutline = "M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9",
                IconPathSolid = "M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z",
                BadgeCount = Model.ViewModel.AlertSummary.ActiveCount,
                BadgeVariant = TabBadgeVariant.Warning }
        }
    };
}
@await Html.PartialAsync("Components/_TabPanel", performanceTabs)

<!-- Tab Content -->
@await Html.PartialAsync("Tabs/_AlertsTab", Model.ViewModel)

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script src="~/js/dashboard-hub.js"></script>
    <script src="~/js/performance/alerts-realtime.js"></script>
    <script>
        // Chart.js default dark theme settings
        Chart.defaults.color = '#a8a5a3';
        Chart.defaults.borderColor = '#3f4447';

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize the Alerts tab (function defined in partial)
            if (typeof window.initAlertsTab === 'function') {
                await window.initAlertsTab();
            }

            // Initialize SignalR real-time updates
            if (typeof AlertsRealtime !== 'undefined') {
                await AlertsRealtime.initialize();
            }
        });

        // Cleanup on page unload
        window.addEventListener('pagehide', async function() {
            if (typeof AlertsRealtime !== 'undefined') {
                await AlertsRealtime.cleanup();
            }
        });

        // Warn before leaving if there are unsaved changes
        window.addEventListener('beforeunload', function(e) {
            if (typeof window.alertsTabHasUnsavedChanges === 'function' && window.alertsTabHasUnsavedChanges()) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
}
