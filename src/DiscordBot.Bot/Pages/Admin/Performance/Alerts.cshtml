@page
@model DiscordBot.Bot.Pages.Admin.Performance.AlertsModel
@using DiscordBot.Core.Enums
@using DiscordBot.Bot.ViewModels.Pages
@using DiscordBot.Bot.ViewModels.Components
@{
    ViewData["Title"] = "Alerts & Incidents";
    ViewData["Breadcrumbs"] = new List<(string Text, string? Url)>
    {
        ("Dashboard", "/"),
        ("Bot Performance", null),
        ("Alerts & Incidents", null)
    };
}

@section Styles {
    <link rel="stylesheet" href="~/css/performance-pages.css" />
    <style>
        /* Alert animation styles */
        .alert-entering {
            animation: alertSlideIn 0.5s ease-out;
        }
        .alert-exiting {
            animation: alertSlideOut 0.3s ease-in forwards;
        }
        .alert-highlight {
            animation: alertPulse 0.5s ease-in-out 3;
        }
        @@keyframes alertSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        @@keyframes alertSlideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
        @@keyframes alertPulse {
            0%, 100% {
                background-color: inherit;
            }
            50% {
                background-color: rgba(var(--color-accent-blue-rgb), 0.2);
            }
        }
        /* Live indicator styles */
        #alertsLiveIndicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        #alertsLiveIndicator .live-dot {
            width: 8px;
            height: 8px;
            background-color: rgb(16, 185, 129);
            border-radius: 50%;
            animation: livePulse 2s infinite;
        }
        #alertsLiveIndicator.paused .live-dot {
            background-color: rgb(107, 114, 128);
            animation: none;
        }
        #alertsLiveIndicator.flash .live-dot {
            animation: liveFlash 0.3s ease-out;
        }
        @@keyframes livePulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        @@keyframes liveFlash {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }
            70% {
                transform: scale(1.2);
                box-shadow: 0 0 0 8px rgba(16, 185, 129, 0);
            }
            100% {
                transform: scale(1);
            }
        }
    </style>
}

<!-- Page Header -->
<div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
    <div>
        <h1 class="text-2xl lg:text-3xl font-bold text-text-primary">Alerts & Incidents</h1>
        <p class="text-text-secondary mt-1">Active alerts, incident history, and alert configuration</p>
    </div>

    <div class="flex items-center gap-3">
        <span id="alertsLiveIndicator" class="hidden text-sm text-text-secondary">
            <span class="live-dot"></span>
            <span>Live</span>
        </span>
        @if (Model.ViewModel.AlertSummary.ActiveCount > 0)
        {
            var severityClass = Model.ViewModel.AlertSummary.CriticalCount > 0 ? "severity-critical"
                : Model.ViewModel.AlertSummary.WarningCount > 0 ? "severity-warning"
                : "severity-info";
            <span class="severity-badge @severityClass">@Model.ViewModel.AlertSummary.ActiveCount Active Alert@(Model.ViewModel.AlertSummary.ActiveCount != 1 ? "s" : "")</span>
        }
    </div>
</div>

<!-- Display Success/Error Messages -->
@if (TempData["SuccessMessage"] != null)
{
    <div class="mb-6 p-4 bg-success/10 border border-success/20 rounded-lg text-success">
        @TempData["SuccessMessage"]
    </div>
}
@if (TempData["ErrorMessage"] != null)
{
    <div class="mb-6 p-4 bg-error/10 border border-error/20 rounded-lg text-error">
        @TempData["ErrorMessage"]
    </div>
}

<!-- Navigation Tabs -->
@await Html.PartialAsync("Components/_PerformanceTabs", new PerformanceTabsViewModel
{
    ActiveTab = "alerts",
    ActiveAlertCount = Model.ViewModel.AlertSummary.ActiveCount
})

<!-- Tab Content -->
@await Html.PartialAsync("Tabs/_AlertsTab", Model.ViewModel)

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script src="~/js/dashboard-hub.js"></script>
    <script src="~/js/performance/alerts-realtime.js"></script>
    <script>
        // Chart.js default dark theme settings
        Chart.defaults.color = '#a8a5a3';
        Chart.defaults.borderColor = '#3f4447';

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', async function() {
            // Initialize the Alerts tab (function defined in partial)
            if (typeof window.initAlertsTab === 'function') {
                await window.initAlertsTab();
            }

            // Initialize SignalR real-time updates
            if (typeof AlertsRealtime !== 'undefined') {
                await AlertsRealtime.initialize();
            }
        });

        // Cleanup on page unload
        window.addEventListener('pagehide', async function() {
            if (typeof AlertsRealtime !== 'undefined') {
                await AlertsRealtime.cleanup();
            }
        });

        // Warn before leaving if there are unsaved changes
        window.addEventListener('beforeunload', function(e) {
            if (typeof window.alertsTabHasUnsavedChanges === 'function' && window.alertsTabHasUnsavedChanges()) {
                e.preventDefault();
                e.returnValue = '';
            }
        });
    </script>
}
