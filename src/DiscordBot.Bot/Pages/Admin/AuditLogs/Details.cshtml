@page "{id:long}"
@model DiscordBot.Bot.Pages.Admin.AuditLogs.DetailsModel
@{
    ViewData["Title"] = "Audit Entry Details";
}

<!-- Breadcrumb -->
<nav aria-label="Breadcrumb" class="mb-6">
    <ol class="flex items-center gap-2 text-sm">
        <li>
            <a asp-page="/Index" class="text-text-secondary hover:text-accent-blue transition-colors">Admin</a>
        </li>
        <li class="text-text-tertiary">/</li>
        <li>
            <a asp-page="/Admin/AuditLogs/Index" class="text-text-secondary hover:text-accent-blue transition-colors">Audit Logs</a>
        </li>
        <li class="text-text-tertiary">/</li>
        <li class="text-text-primary font-medium">Entry Details</li>
    </ol>
</nav>

<!-- Header with Back Button -->
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div class="flex items-center gap-4">
        <a href="@Model.ReturnUrl" class="inline-flex items-center justify-center w-10 h-10 text-text-secondary bg-bg-secondary border border-border-primary rounded-md hover:bg-bg-hover transition-colors" aria-label="Back to audit logs">
            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
        </a>
        <div>
            <h1 class="text-2xl font-bold text-text-primary">Audit Entry Details</h1>
            <p class="mt-1 text-sm text-text-secondary">Entry ID: <span class="font-mono">@Model.ViewModel.Id</span></p>
        </div>
    </div>
    <div class="flex items-center gap-2">
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-semibold @Model.ViewModel.ActionBadgeClass">
            @Model.ViewModel.Action
        </span>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Left Column - Metadata -->
    <div class="lg:col-span-1 space-y-6">
        <!-- Actor Information Card -->
        <div class="bg-bg-secondary border border-border-primary rounded-lg overflow-hidden">
            <div class="px-4 py-3 border-b border-border-primary bg-bg-tertiary">
                <h2 class="text-sm font-semibold text-text-primary flex items-center gap-2">
                    <svg class="w-4 h-4 text-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    Actor Information
                </h2>
            </div>
            <div class="p-4">
                <div class="flex items-center gap-4 mb-4">
                    <div class="h-12 w-12 rounded-full @Model.ViewModel.ActorAvatarClass flex items-center justify-center">
                        <span class="font-bold text-lg">@Model.ViewModel.ActorInitials</span>
                    </div>
                    <div>
                        <p class="text-base font-medium text-text-primary">@Model.ViewModel.ActorName</p>
                        <p class="text-sm text-text-secondary">@Model.ViewModel.ActorTypeName</p>
                    </div>
                </div>
                <div class="space-y-3 pt-3 border-t border-border-secondary">
                    <div class="flex justify-between items-start">
                        <span class="text-sm text-text-tertiary">Actor ID</span>
                        <span class="text-sm font-mono text-text-secondary break-all text-right">@Model.ViewModel.ActorId</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Target Resource Card -->
        @if (!string.IsNullOrEmpty(Model.ViewModel.TargetType))
        {
            <div class="bg-bg-secondary border border-border-primary rounded-lg overflow-hidden">
                <div class="px-4 py-3 border-b border-border-primary bg-bg-tertiary">
                    <h2 class="text-sm font-semibold text-text-primary flex items-center gap-2">
                        <svg class="w-4 h-4 text-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        Target Resource
                    </h2>
                </div>
                <div class="p-4 space-y-3">
                    <div class="flex justify-between items-start">
                        <span class="text-sm text-text-tertiary">Type</span>
                        <span class="text-sm text-text-primary">@Model.ViewModel.TargetType</span>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.ViewModel.TargetId))
                    {
                        <div class="flex justify-between items-start">
                            <span class="text-sm text-text-tertiary">Resource ID</span>
                            <span class="text-sm font-mono text-text-secondary break-all text-right">@Model.ViewModel.TargetId</span>
                        </div>
                    }
                    @if (Model.ViewModel.HasGuild)
                    {
                        <div class="flex justify-between items-start">
                            <span class="text-sm text-text-tertiary">Guild</span>
                            <a asp-page="/Admin/Guilds/Details" asp-route-id="@Model.ViewModel.GuildId" class="text-sm text-accent-blue hover:text-accent-blue-hover transition-colors flex items-center gap-1">
                                @Model.ViewModel.GuildName
                                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                </svg>
                            </a>
                        </div>
                        <div class="flex justify-between items-start">
                            <span class="text-sm text-text-tertiary">Guild ID</span>
                            <span class="text-sm font-mono text-text-secondary">@Model.ViewModel.GuildId</span>
                        </div>
                    }
                </div>
            </div>
        }

        <!-- Request Metadata Card -->
        <div class="bg-bg-secondary border border-border-primary rounded-lg overflow-hidden">
            <div class="px-4 py-3 border-b border-border-primary bg-bg-tertiary">
                <h2 class="text-sm font-semibold text-text-primary flex items-center gap-2">
                    <svg class="w-4 h-4 text-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Request Metadata
                </h2>
            </div>
            <div class="p-4 space-y-3">
                <div class="flex justify-between items-start">
                    <span class="text-sm text-text-tertiary">Timestamp</span>
                    <div class="text-right">
                        <p class="text-sm text-text-primary" data-utc="@Model.ViewModel.TimestampUtcIso" data-format="datetime-seconds">Loading...</p>
                        <p class="text-xs text-text-tertiary timezone-indicator"></p>
                    </div>
                </div>
                @if (!string.IsNullOrEmpty(Model.ViewModel.IpAddress))
                {
                    <div class="flex justify-between items-start">
                        <span class="text-sm text-text-tertiary">IP Address</span>
                        <span class="text-sm font-mono text-text-secondary">@Model.ViewModel.IpAddress</span>
                    </div>
                }
                @if (!string.IsNullOrEmpty(Model.ViewModel.CorrelationId))
                {
                    <div class="flex flex-col gap-1">
                        <span class="text-sm text-text-tertiary">Correlation ID</span>
                        <span class="text-xs font-mono text-text-secondary bg-bg-primary rounded px-2 py-1.5 break-all">@Model.ViewModel.CorrelationId</span>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Right Column - Changes & Details -->
    <div class="lg:col-span-2">
        <!-- Changes/Details Panel -->
        @if (Model.ViewModel.HasDetails)
        {
            <div class="bg-bg-secondary border border-border-primary rounded-lg overflow-hidden mb-6">
                <div class="px-4 py-3 border-b border-border-primary bg-bg-tertiary flex items-center justify-between">
                    <h2 class="text-sm font-semibold text-text-primary flex items-center gap-2">
                        <svg class="w-4 h-4 text-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" />
                        </svg>
                        Details
                    </h2>
                </div>
                <div class="p-4">
                    @if (Model.ViewModel.ParsedDetails != null && Model.ViewModel.ParsedDetails.Any())
                    {
                        <div class="space-y-4">
                            @foreach (var (key, value) in Model.ViewModel.ParsedDetails)
                            {
                                <div class="rounded-lg border border-border-primary overflow-hidden">
                                    <div class="px-3 py-2 bg-bg-tertiary border-b border-border-primary">
                                        <h3 class="text-sm font-medium text-text-primary flex items-center gap-2">
                                            <svg class="w-4 h-4 text-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                                            </svg>
                                            @key
                                        </h3>
                                    </div>
                                    <div class="p-3">
                                        <div class="rounded px-3 py-2 bg-bg-primary font-mono text-sm text-text-primary break-all">
                                            @value.ToString()
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-sm text-text-secondary">
                            <p>No structured details available for this entry.</p>
                        </div>
                    }
                </div>
            </div>

            <!-- Raw Data Panel (Expandable) -->
            <div class="bg-bg-secondary border border-border-primary rounded-lg overflow-hidden mb-6">
                <div class="px-4 py-3 border-b border-border-primary bg-bg-tertiary flex items-center justify-between">
                    <h2 class="text-sm font-semibold text-text-primary flex items-center gap-2">
                        <svg class="w-4 h-4 text-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4" />
                        </svg>
                        Raw Change Data
                    </h2>
                    <button id="toggleRawData" type="button" class="text-xs text-accent-blue hover:text-accent-blue-hover transition-colors flex items-center gap-1" aria-expanded="false">
                        <span id="rawDataToggleText">Expand</span>
                        <svg id="rawDataToggleIcon" class="w-4 h-4 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                </div>
                <div id="rawDataContent" class="json-collapsed relative">
                    <pre class="p-4 text-xs font-mono text-text-secondary overflow-x-auto">@Model.ViewModel.FormattedDetails</pre>
                </div>
            </div>
        }
        else
        {
            <div class="bg-bg-secondary border border-border-primary rounded-lg p-8 text-center mb-6">
                <svg class="w-12 h-12 mx-auto text-text-tertiary mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <h3 class="text-lg font-medium text-text-primary mb-2">No Additional Details</h3>
                <p class="text-sm text-text-secondary">This audit log entry does not contain additional detail information.</p>
            </div>
        }

        <!-- Related Entries Panel -->
        @if (Model.ViewModel.HasRelatedEntries)
        {
            <div class="bg-bg-secondary border border-border-primary rounded-lg overflow-hidden mb-6">
                <div class="px-4 py-3 border-b border-border-primary bg-bg-tertiary">
                    <h2 class="text-sm font-semibold text-text-primary flex items-center gap-2">
                        <svg class="w-4 h-4 text-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        Related Entries
                        <span class="ml-auto text-xs font-normal text-text-tertiary">@Model.ViewModel.RelatedEntries.Count entries</span>
                    </h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-border-primary">
                        <thead class="bg-bg-tertiary">
                            <tr>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Timestamp</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Action</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Actor</th>
                                <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">Target</th>
                                <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-text-secondary uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-border-secondary">
                            @foreach (var entry in Model.ViewModel.RelatedEntries)
                            {
                                <tr class="hover:bg-bg-hover transition-colors">
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <span class="text-sm font-mono text-text-secondary" data-utc="@entry.TimestampUtcIso" data-format="datetime-seconds"></span>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium @entry.ActionBadgeClass">
                                            @entry.Action
                                        </span>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <div class="flex items-center gap-2">
                                            <div class="h-6 w-6 rounded-full @entry.ActorAvatarClass flex items-center justify-center">
                                                <span class="text-xs font-medium">@entry.ActorInitials</span>
                                            </div>
                                            <span class="text-sm text-text-primary">@entry.ActorName</span>
                                        </div>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap">
                                        <span class="text-sm text-text-secondary">@entry.TargetType</span>
                                    </td>
                                    <td class="px-4 py-3 whitespace-nowrap text-right">
                                        <a asp-page="/Admin/AuditLogs/Details" asp-route-id="@entry.Id" class="text-accent-blue hover:text-accent-blue-hover text-sm font-medium transition-colors">
                                            View
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }

        <!-- Action Buttons -->
        <div class="flex flex-wrap gap-3">
            <a href="@Model.ReturnUrl" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-text-primary bg-bg-secondary border border-border-primary rounded-md hover:bg-bg-hover transition-colors">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                Back to Audit Logs
            </a>
            <button id="copyEntryIdBtn" type="button" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-text-primary bg-bg-secondary border border-border-primary rounded-md hover:bg-bg-hover transition-colors" aria-label="Copy entry ID to clipboard">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                </svg>
                <span id="copyEntryIdText">Copy Entry ID</span>
            </button>
            <button id="exportJsonBtn" type="button" class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-text-primary bg-bg-secondary border border-border-primary rounded-md hover:bg-bg-hover transition-colors" aria-label="Export this entry as JSON">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Export JSON
            </button>
        </div>
    </div>
</div>

@section Scripts {
    <style>
        /* JSON expand/collapse */
        .json-collapsed {
            max-height: 100px;
            overflow: hidden;
            position: relative;
        }
        .json-collapsed::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 40px;
            background: linear-gradient(transparent, #262a2d);
        }
    </style>

    <script>
        // Toggle raw data expand/collapse
        const toggleRawDataBtn = document.getElementById('toggleRawData');
        const rawDataContent = document.getElementById('rawDataContent');
        const rawDataToggleText = document.getElementById('rawDataToggleText');
        const rawDataToggleIcon = document.getElementById('rawDataToggleIcon');

        if (toggleRawDataBtn && rawDataContent) {
            toggleRawDataBtn.addEventListener('click', function() {
                const isExpanded = this.getAttribute('aria-expanded') === 'true';

                if (isExpanded) {
                    rawDataContent.classList.add('json-collapsed');
                    rawDataToggleText.textContent = 'Expand';
                    rawDataToggleIcon.style.transform = 'rotate(0deg)';
                    this.setAttribute('aria-expanded', 'false');
                } else {
                    rawDataContent.classList.remove('json-collapsed');
                    rawDataToggleText.textContent = 'Collapse';
                    rawDataToggleIcon.style.transform = 'rotate(180deg)';
                    this.setAttribute('aria-expanded', 'true');
                }
            });
        }

        // Copy Entry ID functionality
        const copyEntryIdBtn = document.getElementById('copyEntryIdBtn');
        const copyEntryIdText = document.getElementById('copyEntryIdText');
        const entryId = '@Model.ViewModel.Id';

        if (copyEntryIdBtn) {
            copyEntryIdBtn.addEventListener('click', function() {
                navigator.clipboard.writeText(entryId).then(() => {
                    const originalText = copyEntryIdText.textContent;
                    copyEntryIdText.textContent = 'Copied!';
                    setTimeout(() => {
                        copyEntryIdText.textContent = originalText;
                    }, 2000);
                }).catch(err => {
                    console.error('Failed to copy entry ID:', err);
                });
            });
        }

        // Export JSON functionality
        const exportJsonBtn = document.getElementById('exportJsonBtn');
        if (exportJsonBtn) {
            exportJsonBtn.addEventListener('click', function() {
                const jsonData = {
                    entryId: @Model.ViewModel.Id,
                    timestamp: '@Model.ViewModel.Timestamp.ToString("yyyy-MM-ddTHH:mm:ss.fffZ")',
                    category: '@Model.ViewModel.Category',
                    action: '@Model.ViewModel.Action',
                    actor: {
                        id: '@Model.ViewModel.ActorId',
                        name: '@Model.ViewModel.ActorName',
                        type: '@Model.ViewModel.ActorTypeName'
                    },
                    target: {
                        type: '@Model.ViewModel.TargetType',
                        id: '@Model.ViewModel.TargetId'
                    },
                    @if (Model.ViewModel.HasGuild)
                    {
                        <text>
                        guild: {
                            id: '@Model.ViewModel.GuildId',
                            name: '@Model.ViewModel.GuildName'
                        },
                        </text>
                    }
                    @if (!string.IsNullOrEmpty(Model.ViewModel.IpAddress))
                    {
                        <text>ipAddress: '@Model.ViewModel.IpAddress',</text>
                    }
                    @if (!string.IsNullOrEmpty(Model.ViewModel.CorrelationId))
                    {
                        <text>correlationId: '@Model.ViewModel.CorrelationId',</text>
                    }
                    @if (Model.ViewModel.HasDetails)
                    {
                        <text>details: @Html.Raw(Model.ViewModel.Details)</text>
                    }
                };

                const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `audit-entry-${entryId}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }
    </script>
}
