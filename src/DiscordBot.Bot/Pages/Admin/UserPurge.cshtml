@page
@model DiscordBot.Bot.Pages.Admin.UserPurgeModel
@{
    ViewData["Title"] = "User Data Purge";
}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-6">
        <h1 class="text-h1 text-text-primary">User Data Purge</h1>
        <p class="mt-1 text-sm text-text-secondary">Permanently delete all user data for GDPR compliance</p>
    </div>

    <!-- Warning Notice -->
    <div class="mb-6 p-4 bg-error-bg border border-error-border rounded-lg">
        <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-error flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
            </svg>
            <div>
                <p class="text-sm font-semibold text-error">Warning: Irreversible Operation</p>
                <p class="text-sm text-error/90 mt-1">
                    This action permanently deletes all user data from the system. This operation cannot be undone. Use with extreme caution.
                </p>
            </div>
        </div>
    </div>

    <!-- Success/Error Messages -->
    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="mb-6">
            <partial name="Shared/Components/_Alert" model="new DiscordBot.Bot.ViewModels.Components.AlertViewModel { Variant = DiscordBot.Bot.ViewModels.Components.AlertVariant.Success, Message = Model.SuccessMessage, IsDismissible = true }" />
        </div>
    }
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="mb-6">
            <partial name="Shared/Components/_Alert" model="new DiscordBot.Bot.ViewModels.Components.AlertViewModel { Variant = DiscordBot.Bot.ViewModels.Components.AlertVariant.Error, Message = Model.ErrorMessage, IsDismissible = true }" />
        </div>
    }

    <!-- Input Form -->
    <div class="bg-bg-secondary border border-border-primary rounded-lg p-6 mb-6">
        <h2 class="text-lg font-semibold text-text-primary mb-4">Enter Discord User ID</h2>
        <form method="get" class="space-y-4">
            <div>
                <label for="discord-user-id" class="block text-sm font-medium text-text-primary mb-2">
                    Discord User ID
                </label>
                <input
                    type="text"
                    id="discord-user-id"
                    name="DiscordUserId"
                    value="@Model.DiscordUserId"
                    placeholder="Enter Discord user ID (e.g., 123456789012345678)"
                    class="w-full py-2 px-3 text-sm text-text-primary bg-bg-primary border border-border-primary rounded-md placeholder-text-tertiary focus:outline-none focus:ring-2 focus:ring-border-focus focus:border-transparent"
                    required />
                @if (!ViewData.ModelState.IsValid && ViewData.ModelState["DiscordUserId"]?.Errors.Count > 0)
                {
                    <p class="mt-1 text-sm text-error">
                        @ViewData.ModelState["DiscordUserId"]?.Errors[0].ErrorMessage
                    </p>
                }
            </div>
            <div class="flex gap-2">
                <button type="submit" class="btn btn-primary">
                    <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    Preview Data
                </button>
                @if (!string.IsNullOrEmpty(Model.DiscordUserId))
                {
                    <a asp-page="UserPurge" class="btn btn-secondary">Clear</a>
                }
            </div>
        </form>
    </div>

    <!-- Cannot Purge Warning -->
    @if (!string.IsNullOrEmpty(Model.CannotPurgeReason))
    {
        <div class="bg-warning-bg border border-warning-border rounded-lg p-6 mb-6">
            <div class="flex items-start gap-3">
                <svg class="w-6 h-6 text-warning flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
                <div>
                    <h3 class="text-lg font-semibold text-warning mb-2">Cannot Purge User</h3>
                    <p class="text-sm text-warning/90">@Model.CannotPurgeReason</p>
                </div>
            </div>
        </div>
    }

    <!-- Preview Results -->
    @if (Model.ShowPreview && Model.PreviewResult != null)
    {
        <div class="bg-bg-secondary border border-border-primary rounded-lg overflow-hidden mb-6">
            <div class="px-6 py-4 border-b border-border-primary bg-bg-tertiary">
                <h2 class="text-lg font-semibold text-text-primary">Preview: Data to be Deleted</h2>
                <p class="text-sm text-text-secondary mt-1">
                    The following records will be permanently deleted for Discord user ID: <span class="font-mono text-text-primary">@Model.DiscordUserId</span>
                </p>
            </div>

            <div class="p-6">
                @if (Model.PreviewResult.DeletedCounts.Any())
                {
                    <!-- Data Counts Table -->
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-border-primary">
                            <thead>
                                <tr>
                                    <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider">
                                        Data Type
                                    </th>
                                    <th scope="col" class="px-4 py-3 text-right text-xs font-medium text-text-secondary uppercase tracking-wider">
                                        Records
                                    </th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-border-primary">
                                @foreach (var kvp in Model.PreviewResult.DeletedCounts.OrderByDescending(x => x.Value))
                                {
                                    <tr class="hover:bg-bg-tertiary/50 transition-colors">
                                        <td class="px-4 py-3 text-sm text-text-primary">
                                            @if (kvp.Key.Contains("Anonymized"))
                                            {
                                                <span class="inline-flex items-center">
                                                    @kvp.Key.Replace("_Anonymized", "")
                                                    <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-info-bg text-info border border-info-border">
                                                        Anonymized
                                                    </span>
                                                </span>
                                            }
                                            else
                                            {
                                                @kvp.Key
                                            }
                                        </td>
                                        <td class="px-4 py-3 text-sm text-text-primary text-right font-mono">
                                            @kvp.Value.ToString("N0")
                                        </td>
                                    </tr>
                                }
                                <tr class="bg-bg-tertiary font-semibold">
                                    <td class="px-4 py-3 text-sm text-text-primary">
                                        Total Records
                                    </td>
                                    <td class="px-4 py-3 text-sm text-text-primary text-right font-mono">
                                        @Model.PreviewResult.DeletedCounts.Values.Sum().ToString("N0")
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Info Notice -->
                    <div class="mt-6 p-4 bg-info-bg border border-info-border rounded-md">
                        <div class="flex items-start gap-3">
                            <svg class="w-5 h-5 text-info flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                            </svg>
                            <div class="text-sm text-info">
                                <p class="font-semibold mb-1">About Anonymization</p>
                                <p class="text-info/90">
                                    Some records (RatRecords, RatWatches) are anonymized rather than deleted to preserve historical data integrity. The user's ID is replaced with 0.
                                </p>
                            </div>
                        </div>
                    </div>

                    <!-- Purge Confirmation Form -->
                    <div class="mt-6 pt-6 border-t border-border-primary">
                        <form method="post" id="purge-form" onsubmit="return confirmPurge();">
                            <input type="hidden" name="DiscordUserId" value="@Model.DiscordUserId" />
                            <button type="submit" class="btn btn-error">
                                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Purge User Data
                            </button>
                            <p class="mt-2 text-xs text-text-tertiary">
                                This operation will permanently delete the user data shown above. You will be asked to confirm before proceeding.
                            </p>
                        </form>
                    </div>
                }
                else
                {
                    <!-- No Data Found -->
                    <div class="text-center py-8">
                        <div class="inline-flex items-center justify-center w-16 h-16 bg-bg-tertiary rounded-xl mb-4">
                            <svg class="w-10 h-10 text-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-text-primary mb-2">No Data Found</h3>
                        <p class="text-sm text-text-secondary">
                            No records found for this Discord user ID. The user may not exist in the database.
                        </p>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Purge Result -->
    @if (Model.PurgeResult != null && Model.PurgeResult.Success)
    {
        <div class="bg-success-bg border border-success-border rounded-lg p-6">
            <div class="flex items-start gap-3">
                <svg class="w-6 h-6 text-success flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                </svg>
                <div class="flex-1">
                    <h3 class="text-lg font-semibold text-success mb-2">Purge Complete</h3>
                    <p class="text-sm text-success/90 mb-4">
                        Successfully purged all data for Discord user ID: <span class="font-mono">@Model.DiscordUserId</span>
                    </p>

                    <!-- Deleted Counts Summary -->
                    <div class="bg-bg-secondary rounded-lg p-4 border border-success-border/30">
                        <p class="text-xs font-semibold text-text-primary uppercase tracking-wider mb-2">Deleted Records</p>
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                            @foreach (var kvp in Model.PurgeResult.DeletedCounts.Where(x => x.Value > 0))
                            {
                                <div class="text-xs">
                                    <span class="text-text-secondary">@kvp.Key:</span>
                                    <span class="text-text-primary font-mono ml-1">@kvp.Value</span>
                                </div>
                            }
                        </div>
                        <div class="mt-3 pt-3 border-t border-border-primary">
                            <span class="text-sm font-semibold text-text-primary">Total: </span>
                            <span class="text-sm font-mono text-text-primary">@Model.PurgeResult.DeletedCounts.Values.Sum().ToString("N0")</span>
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.PurgeResult.AuditLogCorrelationId))
                    {
                        <p class="text-xs text-success/80 mt-4">
                            Audit Correlation ID: <span class="font-mono">@Model.PurgeResult.AuditLogCorrelationId</span>
                        </p>
                    }
                </div>
            </div>
        </div>
    }

    <!-- Additional Information -->
    <div class="mt-6 p-4 bg-info-bg border border-info-border rounded-md">
        <div class="flex items-start gap-3">
            <svg class="w-5 h-5 text-info flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20" aria-hidden="true">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
            </svg>
            <div class="text-sm text-info">
                <p class="font-semibold mb-1">GDPR Compliance</p>
                <p class="text-info/90">
                    This tool implements the "right to be forgotten" under GDPR. All user data is permanently deleted or anonymized.
                    An audit log entry is created for compliance tracking. Users can also request deletion via the <code class="px-1.5 py-0.5 bg-info/20 rounded font-mono text-xs">/privacy</code> command in Discord.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    function confirmPurge() {
        const userId = '@Model.DiscordUserId';
        const message = `WARNING: You are about to permanently delete ALL data for Discord user ID: ${userId}\n\n` +
                       `This action CANNOT be undone.\n\n` +
                       `Are you absolutely sure you want to proceed?`;

        return confirm(message);
    }
</script>

<style>
    .btn-error {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        font-size: 0.875rem;
        font-weight: 600;
        color: white;
        background-color: #dc2626;
        border: 1px solid #dc2626;
        border-radius: 0.375rem;
        transition: background-color 0.2s, border-color 0.2s;
    }

    .btn-error:hover {
        background-color: #b91c1c;
        border-color: #b91c1c;
    }

    .btn-error:focus {
        outline: none;
        box-shadow: 0 0 0 2px #2a2e32, 0 0 0 4px #ef4444;
    }
</style>
