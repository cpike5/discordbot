@page "{guildId:long}"
@model DiscordBot.Bot.Pages.Portal.Soundboard.IndexModel
@{
    ViewData["Title"] = Model.IsAuthenticated ? "Soundboard" : "Verify Your Membership";
}

<style>
    /* ===============================================
       Landing Page Styles (Unauthenticated View)
       =============================================== */
    .landing-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
        background-color: #1d2022;
    }

    .landing-card {
        width: 100%;
        max-width: 480px;
        background-color: #262a2d;
        border: 1px solid #3f4447;
        border-radius: 0.5rem;
        padding: 2.5rem 2rem;
        text-align: center;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .landing-guild-icon {
        width: 120px;
        height: 120px;
        margin: 0 auto 1.5rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid #3f4447;
        box-shadow: 0 4px 12px rgba(203, 78, 27, 0.3);
        overflow: hidden;
        background: linear-gradient(135deg, #cb4e1b 0%, #e5591f 100%);
    }

    .landing-guild-icon img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .landing-guild-icon-placeholder {
        font-size: 3rem;
        color: white;
    }

    .landing-guild-name {
        font-size: 1.75rem;
        font-weight: 600;
        color: #dbdee1;
        margin-bottom: 0.5rem;
        word-wrap: break-word;
        word-break: break-word;
    }

    .landing-portal-badge {
        display: inline-block;
        font-size: 0.75rem;
        font-weight: 500;
        color: #cb4e1b;
        background-color: rgba(203, 78, 27, 0.1);
        border: 1px solid rgba(203, 78, 27, 0.3);
        padding: 0.375rem 0.75rem;
        border-radius: 999px;
        margin-bottom: 1.5rem;
    }

    .landing-description {
        font-size: 1rem;
        color: #d7d3d0;
        margin-bottom: 1.5rem;
        line-height: 1.6;
    }

    .landing-description-highlight {
        color: #cb4e1b;
        font-weight: 500;
    }

    .landing-discord-button {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.75rem;
        width: 100%;
        padding: 0.875rem 1.5rem;
        background-color: #5865F2;
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
        margin-bottom: 1.5rem;
    }

    .landing-discord-button:hover {
        background-color: #4752C4;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(88, 101, 242, 0.4);
        color: white;
        text-decoration: none;
    }

    .landing-discord-button:active {
        transform: translateY(0);
    }

    .landing-discord-logo {
        width: 20px;
        height: 20px;
    }

    .landing-permissions-notice {
        background-color: #1a1d23;
        border: 1px solid #3f4447;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1.5rem;
        text-align: left;
    }

    .landing-permissions-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: #d7d3d0;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: 0.5rem;
    }

    .landing-permissions-item {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        font-size: 0.813rem;
        color: #a8a5a3;
        line-height: 1.5;
    }

    .landing-permissions-item:last-child {
        margin-bottom: 0;
    }

    .landing-permission-icon {
        color: #cb4e1b;
        font-weight: bold;
        flex-shrink: 0;
        margin-top: 0.125rem;
    }

    .landing-footer-text {
        font-size: 0.813rem;
        color: #a8a5a3;
        line-height: 1.5;
    }

    .landing-footer-text a {
        color: #cb4e1b;
        text-decoration: none;
        transition: color 0.2s;
    }

    .landing-footer-text a:hover {
        color: #e5591f;
        text-decoration: underline;
    }

    /* Landing page responsive */
    @@media (max-width: 480px) {
        .landing-card {
            padding: 2rem 1.5rem;
        }

        .landing-guild-icon {
            width: 100px;
            height: 100px;
        }

        .landing-guild-icon-placeholder {
            font-size: 2.5rem;
        }

        .landing-guild-name {
            font-size: 1.5rem;
            margin-bottom: 0.375rem;
        }

        .landing-description {
            font-size: 0.9375rem;
            margin-bottom: 1.25rem;
        }

        .landing-discord-button {
            padding: 0.75rem 1.25rem;
            font-size: 0.9375rem;
        }
    }

    @@media (max-width: 360px) {
        .landing-card {
            padding: 1.5rem 1.25rem;
        }

        .landing-guild-icon {
            width: 80px;
            height: 80px;
            margin-bottom: 1rem;
        }

        .landing-guild-icon-placeholder {
            font-size: 2rem;
        }

        .landing-guild-name {
            font-size: 1.25rem;
            margin-bottom: 0.25rem;
        }

        .landing-portal-badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.625rem;
        }

        .landing-description {
            font-size: 0.875rem;
            margin-bottom: 1rem;
        }

        .landing-permissions-notice {
            padding: 0.75rem;
        }

        .landing-permissions-title {
            font-size: 0.75rem;
        }

        .landing-permissions-item {
            font-size: 0.75rem;
        }
    }

    /* ===============================================
       Soundboard Styles (Authenticated View)
       =============================================== */
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    /* Header */
    .portal-header {
        background-color: #1a1d23;
        border-bottom: 1px solid #40444b;
        padding: 1rem 1.5rem;
    }

    .portal-header .header-content {
        max-width: 1600px;
        margin: 0 auto;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .header-left {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .bot-icon {
        width: 40px;
        height: 40px;
        border-radius: 0.5rem;
        background-color: #cb4e1b;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .bot-icon svg {
        width: 24px;
        height: 24px;
        color: white;
    }

    .header-text h1 {
        font-size: 1.125rem;
        font-weight: bold;
        color: #dbdee1;
    }

    .header-text p {
        font-size: 0.875rem;
        color: #949ba4;
    }

    .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 500;
        border-radius: 9999px;
    }

    .status-badge.online {
        background-color: rgba(87, 171, 90, 0.1);
        color: #57ab5a;
    }

    .status-badge.offline {
        background-color: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .status-dot {
        width: 6px;
        height: 6px;
        border-radius: 50%;
        background-color: currentColor;
    }

    /* Main layout */
    .main-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    .portal-content {
        display: flex;
        gap: 1.5rem;
    }

    /* Sidebar - Fixed width on LEFT */
    .sidebar {
        width: 300px;
        flex-shrink: 0;
    }

    .sidebar-panel {
        background-color: #262a2d;
        border: 1px solid #40444b;
        border-radius: 0.5rem;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
    }

    .sidebar-panel:last-child {
        margin-bottom: 0;
    }

    .sidebar-title {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #949ba4;
        margin-bottom: 0.75rem;
    }

    .connection-status {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
    }

    .status-badge-voice {
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 500;
        border-radius: 9999px;
    }

    .status-badge-voice.connected {
        background-color: rgba(87, 171, 90, 0.1);
        color: #57ab5a;
    }

    .status-badge-voice.disconnected {
        background-color: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .channel-member-count {
        font-size: 0.75rem;
        color: #949ba4;
    }

    .channel-member-count.hidden {
        display: none;
    }

    .channel-label {
        display: block;
        font-size: 0.75rem;
        font-weight: 500;
        color: #949ba4;
        margin-bottom: 0.5rem;
    }

    .channel-select {
        width: 100%;
        appearance: none;
        background-color: #1a1d23;
        border: 1px solid #40444b;
        border-radius: 0.5rem;
        padding: 0.5rem 2rem 0.5rem 0.75rem;
        font-size: 0.875rem;
        color: #dbdee1;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 1rem;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23949ba4'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.5rem center;
        background-size: 1.25rem;
    }

    .channel-select:hover {
        border-color: #72767d;
    }

    .channel-select:focus {
        outline: none;
        border-color: #cb4e1b;
        box-shadow: 0 0 0 2px rgba(203, 78, 27, 0.1);
    }

    .button-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
    }

    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.625rem 1rem;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        text-decoration: none;
    }

    .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .btn-join {
        background-color: #cb4e1b;
        color: white;
        width: 100%;
    }

    .btn-join:hover:not(:disabled) {
        background-color: #e5591f;
    }

    .btn-leave {
        background-color: #ef4444;
        color: white;
        width: 100%;
    }

    .btn-leave:hover:not(:disabled) {
        background-color: #dc2626;
    }

    /* Now Playing */
    .now-playing-container {
        background-color: #1a1d23;
        border-radius: 0.5rem;
        padding: 1rem;
    }

    .now-playing-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .now-playing-icon {
        width: 36px;
        height: 36px;
        border-radius: 0.5rem;
        background-color: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .now-playing-info {
        flex: 1;
        min-width: 0;
    }

    .now-playing-name {
        font-size: 0.875rem;
        font-weight: 500;
        color: #dbdee1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .now-playing-status {
        font-size: 0.75rem;
        color: #949ba4;
    }

    .stop-btn {
        width: 32px;
        height: 32px;
        border-radius: 0.5rem;
        background-color: #ef4444;
        color: white;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .stop-btn:hover {
        background-color: #dc2626;
    }

    .empty-now-playing {
        text-align: center;
        padding: 1.5rem;
        color: #949ba4;
    }

    .empty-now-playing svg {
        width: 32px;
        height: 32px;
        margin: 0 auto 0.75rem;
        opacity: 0.5;
    }

    .empty-now-playing p {
        font-size: 0.875rem;
    }

    /* Upload Section */
    .dropzone {
        border: 2px dashed #40444b;
        border-radius: 0.5rem;
        padding: 1.5rem 1rem;
        background-color: #1a1d23;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 1rem;
    }

    .dropzone:hover {
        border-color: #cb4e1b;
        background-color: rgba(203, 78, 27, 0.05);
    }

    .dropzone.drag-over {
        border-color: #cb4e1b;
        background-color: rgba(203, 78, 27, 0.1);
    }

    .dropzone.has-file {
        border-color: #57ab5a;
        background-color: rgba(87, 171, 90, 0.1);
    }

    .dropzone-icon {
        width: 32px;
        height: 32px;
        margin: 0 auto 0.75rem;
        color: #949ba4;
    }

    .dropzone.has-file .dropzone-icon {
        color: #57ab5a;
    }

    .dropzone-text {
        font-size: 0.875rem;
        font-weight: 500;
        color: #dbdee1;
    }

    .dropzone-hint {
        font-size: 0.75rem;
        color: #949ba4;
        margin-top: 0.25rem;
    }

    /* Upload Form */
    .upload-form {
        margin-top: 1rem;
    }

    .upload-form.hidden {
        display: none;
    }

    .file-preview {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background-color: #1a1d23;
        border-radius: 0.5rem;
        margin-bottom: 0.75rem;
    }

    .file-preview-icon {
        width: 36px;
        height: 36px;
        border-radius: 0.5rem;
        background-color: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
    }

    .file-preview-info {
        flex: 1;
        min-width: 0;
    }

    .file-preview-name {
        font-size: 0.875rem;
        font-weight: 500;
        color: #dbdee1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .file-preview-size {
        font-size: 0.75rem;
        color: #949ba4;
    }

    .file-preview-clear {
        width: 28px;
        height: 28px;
        border-radius: 0.25rem;
        background: transparent;
        border: none;
        color: #949ba4;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
        flex-shrink: 0;
    }

    .file-preview-clear:hover {
        background-color: rgba(239, 68, 68, 0.1);
        color: #ef4444;
    }

    .upload-name-input {
        width: 100%;
        background-color: #1a1d23;
        border: 1px solid #40444b;
        border-radius: 0.5rem;
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        color: #dbdee1;
        margin-bottom: 0.75rem;
        transition: all 0.2s;
    }

    .upload-name-input:hover {
        border-color: #72767d;
    }

    .upload-name-input:focus {
        outline: none;
        border-color: #cb4e1b;
        box-shadow: 0 0 0 2px rgba(203, 78, 27, 0.1);
    }

    .upload-name-input::placeholder {
        color: #949ba4;
    }

    .upload-btn {
        width: 100%;
        padding: 0.625rem 1rem;
        background-color: #cb4e1b;
        color: white;
        border: none;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .upload-btn:hover:not(:disabled) {
        background-color: #e5591f;
    }

    .upload-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    /* Upload Progress */
    .upload-progress {
        margin-top: 0.75rem;
    }

    .upload-progress.hidden {
        display: none;
    }

    .progress-bar-container {
        height: 8px;
        background-color: #1a1d23;
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 0.5rem;
    }

    .progress-bar {
        height: 100%;
        background-color: #cb4e1b;
        border-radius: 4px;
        transition: width 0.3s ease;
        width: 0%;
    }

    .progress-text {
        font-size: 0.75rem;
        color: #949ba4;
        text-align: center;
    }

    /* Upload Messages */
    .upload-message {
        padding: 0.75rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        margin-top: 0.75rem;
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .upload-message.hidden {
        display: none;
    }

    .upload-message.success {
        background-color: rgba(87, 171, 90, 0.1);
        color: #57ab5a;
        border: 1px solid rgba(87, 171, 90, 0.3);
    }

    .upload-message.error {
        background-color: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .upload-message svg {
        width: 18px;
        height: 18px;
        flex-shrink: 0;
        margin-top: 1px;
    }

    .upload-message-text {
        flex: 1;
    }

    .upload-limits {
        font-size: 0.75rem;
        color: #949ba4;
        line-height: 1.5;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #40444b;
    }

    .upload-limits p {
        margin: 0.25rem 0;
    }

    /* Sound Grid Panel - Flexible on RIGHT */
    .sound-panel {
        flex: 1;
        min-width: 0;
    }

    .sound-grid-wrapper {
        background-color: #262a2d;
        border: 1px solid #40444b;
        border-radius: 0.5rem;
        padding: 1.25rem;
    }

    .search-container {
        position: relative;
        margin-bottom: 1.5rem;
    }

    .search-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        width: 18px;
        height: 18px;
        color: #949ba4;
        pointer-events: none;
    }

    .search-input {
        width: 100%;
        background-color: #1a1d23;
        border: 1px solid #40444b;
        border-radius: 0.5rem;
        padding: 0.625rem 1rem 0.625rem 2.5rem;
        font-size: 0.875rem;
        color: #dbdee1;
        transition: all 0.2s;
    }

    .search-input:hover {
        border-color: #72767d;
    }

    .search-input:focus {
        outline: none;
        border-color: #cb4e1b;
        box-shadow: 0 0 0 2px rgba(203, 78, 27, 0.1);
    }

    .search-input::placeholder {
        color: #949ba4;
    }

    .search-clear-btn {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0.25rem;
        color: #949ba4;
        transition: color 0.2s;
        display: none;
        align-items: center;
        justify-content: center;
    }

    .search-clear-btn:hover {
        color: #dbdee1;
    }

    .search-clear-btn.visible {
        display: flex;
    }

    /* Toast container for portal */
    .portal-toast-container {
        position: fixed;
        bottom: 1.5rem;
        right: 1.5rem;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        max-width: 400px;
    }

    .portal-toast {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem 1.25rem;
        border-radius: 0.5rem;
        background-color: #262a2d;
        border: 1px solid #40444b;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        animation: toast-slide-in 0.3s ease-out;
    }

    .portal-toast.success {
        border-color: rgba(87, 171, 90, 0.3);
    }

    .portal-toast.error {
        border-color: rgba(239, 68, 68, 0.3);
    }

    .portal-toast.warning {
        border-color: rgba(251, 191, 36, 0.3);
    }

    .portal-toast.info {
        border-color: rgba(59, 130, 246, 0.3);
    }

    .portal-toast-icon {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
    }

    .portal-toast.success .portal-toast-icon {
        color: #57ab5a;
    }

    .portal-toast.error .portal-toast-icon {
        color: #ef4444;
    }

    .portal-toast.warning .portal-toast-icon {
        color: #fbbf24;
    }

    .portal-toast.info .portal-toast-icon {
        color: #3b82f6;
    }

    .portal-toast-message {
        flex: 1;
        font-size: 0.875rem;
        color: #dbdee1;
    }

    .portal-toast-close {
        background: none;
        border: none;
        cursor: pointer;
        color: #949ba4;
        padding: 0.25rem;
        transition: color 0.2s;
    }

    .portal-toast-close:hover {
        color: #dbdee1;
    }

    @@keyframes toast-slide-in {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .portal-toast.dismissing {
        animation: toast-slide-out 0.2s ease-in forwards;
    }

    @@keyframes toast-slide-out {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }

    /* Sound Grid - 4 columns desktop, 2 columns mobile */
    .sound-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 1rem;
    }

    .sound-card {
        background-color: #1a1d23;
        border: 1px solid #40444b;
        border-radius: 0.5rem;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
        position: relative;
    }

    .sound-card:hover {
        border-color: #72767d;
        background-color: #2c2f33;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .sound-card.playing {
        border-color: #3b82f6;
        background-color: rgba(59, 130, 246, 0.1);
        animation: card-pulse 2s ease-in-out infinite;
    }

    .sound-card.playing .play-icon {
        animation: pulse 1s ease-in-out infinite;
    }

    .sound-card.playing .play-icon-wrapper {
        animation: glow-pulse 1.5s ease-in-out infinite;
    }

    @@keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    @@keyframes card-pulse {
        0%, 100% {
            border-color: #3b82f6;
            box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
        }
        50% {
            border-color: #60a5fa;
            box-shadow: 0 0 12px 2px rgba(59, 130, 246, 0.4);
        }
    }

    @@keyframes glow-pulse {
        0%, 100% {
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.5);
        }
        50% {
            box-shadow: 0 0 16px rgba(59, 130, 246, 0.8);
        }
    }

    .favorite-btn {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        background: transparent;
        border: none;
        cursor: pointer;
        padding: 0.25rem;
        color: #949ba4;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .favorite-btn:hover {
        color: #fbbf24;
        transform: scale(1.1);
    }

    .favorite-btn.active {
        color: #fbbf24;
    }

    .favorite-btn.active svg {
        fill: currentColor;
    }

    .play-icon-wrapper {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background-color: #3b82f6;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s;
    }

    .sound-card:hover .play-icon-wrapper {
        background-color: #2563eb;
        transform: scale(1.05);
    }

    .play-icon {
        color: white;
        width: 20px;
        height: 20px;
        fill: currentColor;
    }

    .sound-name {
        font-weight: 500;
        font-size: 0.875rem;
        color: #dbdee1;
        text-align: center;
        word-break: break-word;
    }

    .sound-plays {
        font-size: 0.75rem;
        color: #949ba4;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 3rem 1.5rem;
        color: #949ba4;
    }

    .empty-state svg {
        width: 48px;
        height: 48px;
        margin: 0 auto 1rem;
        opacity: 0.5;
    }

    .empty-state-title {
        font-weight: 500;
        color: #dbdee1;
        margin-bottom: 0.5rem;
    }

    .empty-state-text {
        font-size: 0.875rem;
    }

    .hidden {
        display: none !important;
    }

    /* Toast notifications */
    .toast-notification {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%) translateY(100%);
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        font-weight: 500;
        z-index: 9999;
        opacity: 0;
        transition: all 0.3s ease;
    }

    .toast-notification.show {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
    }

    .toast-info {
        background-color: #3b82f6;
        color: white;
    }

    .toast-success {
        background-color: #57ab5a;
        color: white;
    }

    .toast-warning {
        background-color: #f59e0b;
        color: #1a1d23;
    }

    .toast-error {
        background-color: #ef4444;
        color: white;
    }

    /* Highlight required field animation */
    .highlight-required {
        animation: highlight-pulse 0.5s ease-in-out 2;
    }

    @@keyframes highlight-pulse {
        0%, 100% {
            border-color: #40444b;
            box-shadow: none;
        }
        50% {
            border-color: #f59e0b;
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
        }
    }

    /* Responsive */
    @@media (max-width: 1023px) {
        .portal-content {
            flex-direction: column;
        }

        .sidebar {
            width: 100%;
        }

        .sound-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @@media (max-width: 768px) {
        .sound-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @@media (max-width: 640px) {
        .portal-header {
            padding: 1rem;
        }

        .main-container {
            padding: 1rem;
        }

        .portal-content {
            gap: 1rem;
        }

        .button-row {
            grid-template-columns: 1fr;
        }

        .sound-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        .sound-grid-wrapper {
            padding: 1rem;
        }

        .sidebar-panel {
            padding: 1rem;
        }
    }
</style>

@if (!Model.IsAuthenticated)
{
    <!-- ===============================================
         Landing Page (Unauthenticated Users)
         =============================================== -->
    <div class="landing-container">
        <div class="landing-card">
            <!-- Guild Icon -->
            <div class="landing-guild-icon">
                @if (!string.IsNullOrEmpty(Model.GuildIconUrl))
                {
                    <img src="@Model.GuildIconUrl" alt="@Model.GuildName" />
                }
                else
                {
                    <span class="landing-guild-icon-placeholder">@(Model.GuildName.Length > 0 ? Model.GuildName[0].ToString().ToUpper() : "?")</span>
                }
            </div>

            <!-- Guild Name -->
            <h1 class="landing-guild-name">@Model.GuildName</h1>

            <!-- Portal Badge -->
            <span class="landing-portal-badge">Soundboard Portal</span>

            <!-- Description -->
            <p class="landing-description">
                To access this soundboard, we need to verify you're a member of <span class="landing-description-highlight">this server</span>
            </p>

            <!-- Discord Login Button -->
            <a href="@Model.LoginUrl" class="landing-discord-button">
                <svg class="landing-discord-logo" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M20.317 4.3698a19.7913 19.7913 0 00-4.8851-1.5152.0741.0741 0 00-.0785.0371c-.211.3753-.4447.8648-.6083 1.2495-1.8447-.2762-3.68-.2762-5.4868 0-.1636-.3933-.4058-.8742-.6177-1.2495a.077.077 0 00-.0785-.037 19.7363 19.7363 0 00-4.8852 1.515.0699.0699 0 00-.0321.0277C.5334 9.0458-.319 13.5799.0992 18.0578a.0824.0824 0 00.0312.0561c2.0528 1.5076 4.0413 2.4228 5.9929 3.0294a.0777.0777 0 00.0842-.0276c.4616-.6304.8731-1.2952 1.226-1.9942a.076.076 0 00-.0416-.1057c-.6528-.2476-1.2743-.5495-1.8722-.8923a.077.077 0 01-.0076-.1277c.1258-.0943.2517-.1923.3718-.2914a.0743.0743 0 01.0776-.0105c3.9278 1.7933 8.18 1.7933 12.0614 0a.0739.0739 0 01.0785.0095c.1202.099.246.1981.3728.2924a.077.077 0 01-.0066.1276 12.2986 12.2986 0 01-1.873.8914.0766.0766 0 00-.0407.1067c.3604.698.7719 1.3628 1.225 1.9932a.076.076 0 00.0842.0286c1.961-.6067 3.9495-1.5219 6.0023-3.0294a.077.077 0 00.0313-.0552c.5004-5.177-.8382-9.6739-3.5485-13.6604a.061.061 0 00-.0312-.0286zM8.02 15.3312c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9555-2.4189 2.157-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.9555 2.4189-2.1569 2.4189zm7.9748 0c-1.1825 0-2.1569-1.0857-2.1569-2.419 0-1.3332.9554-2.4189 2.1569-2.4189 1.2108 0 2.1757 1.0952 2.1568 2.419 0 1.3332-.946 2.4189-2.1568 2.4189z"/>
                </svg>
                Login with Discord
            </a>

            <!-- Permissions Notice -->
            <div class="landing-permissions-notice">
                <div class="landing-permissions-title">What we'll request</div>
                <div class="landing-permissions-item">
                    <span class="landing-permission-icon">✓</span>
                    <span>Access to see your server memberships</span>
                </div>
                <div class="landing-permissions-item">
                    <span class="landing-permission-icon">✓</span>
                    <span>Your Discord username and avatar</span>
                </div>
            </div>

            <!-- Footer -->
            <p class="landing-footer-text">
                By logging in, you agree to our <a href="/Account/Privacy">Privacy Policy</a>
            </p>
        </div>
    </div>
}
else
{
    <!-- ===============================================
         Soundboard Portal (Authenticated Users)
         =============================================== -->

    <!-- Portal Header with Navigation -->
    <partial name="../Shared/_PortalHeader" model='new DiscordBot.Bot.ViewModels.Portal.PortalHeaderViewModel {
        GuildId = Model.GuildId,
        GuildName = Model.GuildName,
        GuildIconUrl = Model.GuildIconUrl,
        IsOnline = Model.IsOnline,
        ActiveTab = "soundboard"
    }' />

<!-- Main Content -->
<main class="main-container">
    <div class="portal-content">

        <!-- LEFT: Sidebar (Fixed width 300px) -->
        <div class="sidebar">

            <!-- Voice Channel Section -->
            <div class="sidebar-panel">
                <div class="sidebar-title">Voice Channel</div>

                <!-- Connection Status -->
                <div class="connection-status">
                    <span id="connectionStatus" class="status-badge-voice @(Model.IsConnected ? "connected" : "disconnected")">
                        <span class="status-dot"></span>
                        <span id="connectionStatusText">@(Model.IsConnected ? "Connected" : "Disconnected")</span>
                    </span>
                    <span id="channelMemberCount" class="channel-member-count @(Model.IsConnected ? "" : "hidden")">
                        @if (Model.IsConnected && Model.CurrentChannelMemberCount.HasValue)
                        {
                            <text>@Model.CurrentChannelMemberCount @(Model.CurrentChannelMemberCount == 1 ? "member" : "members")</text>
                        }
                    </span>
                </div>

                <!-- Channel Selector -->
                <label class="channel-label">Select Channel</label>
                <select id="channelSelect" class="channel-select">
                    <option value="">-- Select a channel --</option>
                    @foreach (var channel in Model.VoiceChannels)
                    {
                        <option value="@channel.Id" selected="@(channel.Id == Model.CurrentChannelId)">
                            @channel.Name (@channel.MemberCount @(channel.MemberCount == 1 ? "member" : "members"))
                        </option>
                    }
                </select>

                <!-- Join/Leave Buttons -->
                <div class="button-row">
                    <button id="joinBtn" class="btn btn-join" @(Model.IsConnected ? "disabled" : "")>
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
                        </svg>
                        Join
                    </button>
                    <button id="leaveBtn" class="btn btn-leave" @(!Model.IsConnected ? "disabled" : "")>
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        Leave
                    </button>
                </div>
            </div>

            <!-- Now Playing Section -->
            <div class="sidebar-panel">
                <div class="sidebar-title">Now Playing</div>

                <!-- Now Playing Content (hidden when nothing playing) -->
                <div id="nowPlayingContent" class="hidden">
                    <div class="now-playing-container">
                        <div class="now-playing-item">
                            <div class="now-playing-icon">
                                <svg fill="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px;">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </div>
                            <div class="now-playing-info">
                                <div id="nowPlayingName" class="now-playing-name">--</div>
                                <div class="now-playing-status">Playing...</div>
                            </div>
                            <button class="stop-btn" title="Stop">
                                <svg fill="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                                    <path d="M5 3h14a2 2 0 012 2v14a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Empty state when nothing playing -->
                <div id="nowPlayingEmpty" class="empty-now-playing">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p>No sound playing</p>
                </div>
            </div>

            <!-- Upload Sound Section -->
            <div class="sidebar-panel">
                <div class="sidebar-title">Upload Sound</div>

                <!-- Dropzone -->
                <div id="dropzone" class="dropzone">
                    <svg class="dropzone-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                    </svg>
                    <p id="dropzoneText" class="dropzone-text">Drop audio file here</p>
                    <p id="dropzoneHint" class="dropzone-hint">or click to browse</p>
                </div>

                <!-- Upload Form (hidden until file selected) -->
                <div id="uploadForm" class="upload-form hidden">
                    <!-- File Preview -->
                    <div class="file-preview">
                        <div class="file-preview-icon">
                            <svg fill="currentColor" viewBox="0 0 24 24" style="width: 18px; height: 18px;">
                                <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/>
                            </svg>
                        </div>
                        <div class="file-preview-info">
                            <div id="filePreviewName" class="file-preview-name">--</div>
                            <div id="filePreviewSize" class="file-preview-size">--</div>
                        </div>
                        <button type="button" id="clearFileBtn" class="file-preview-clear" title="Clear selection">
                            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <!-- Sound Name Input -->
                    <input type="text"
                           id="soundNameInput"
                           class="upload-name-input"
                           placeholder="Sound name (required)"
                           maxlength="50">

                    <!-- Upload Button -->
                    <button type="button" id="uploadBtn" class="upload-btn" disabled>
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                        </svg>
                        <span id="uploadBtnText">Upload Sound</span>
                    </button>

                    <!-- Progress Indicator -->
                    <div id="uploadProgress" class="upload-progress hidden">
                        <div class="progress-bar-container">
                            <div id="progressBar" class="progress-bar"></div>
                        </div>
                        <div id="progressText" class="progress-text">Uploading...</div>
                    </div>
                </div>

                <!-- Upload Message -->
                <div id="uploadMessage" class="upload-message hidden">
                    <svg id="uploadMessageIcon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <span id="uploadMessageText" class="upload-message-text"></span>
                </div>

                <!-- Upload Limits -->
                <div class="upload-limits">
                    <p><strong>Formats:</strong> @Model.SupportedFormats</p>
                    <p><strong>Max size:</strong> @Model.MaxFileSizeMB MB</p>
                    <p><strong>Max duration:</strong> @Model.MaxDurationSeconds seconds</p>
                    <p><strong>Sounds:</strong> @Model.CurrentSoundCount / @Model.MaxSounds</p>
                </div>
            </div>

        </div>

        <!-- RIGHT: Sound Grid Panel (Flexible) -->
        <div class="sound-panel">
            <div class="sound-grid-wrapper">

                <!-- Search Bar -->
                <div class="search-container">
                    <svg class="search-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <input type="text" id="searchInput" class="search-input" placeholder="Search sounds..." style="padding-right: 2.5rem;">
                    <button type="button" id="searchClearBtn" class="search-clear-btn" title="Clear search">
                        <svg style="width: 16px; height: 16px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>

                <!-- Sound Grid -->
                <div id="soundGrid" class="sound-grid">
                    @foreach (var sound in Model.Sounds)
                    {
                        <div class="sound-card" data-sound-id="@sound.Id" data-sound-name="@sound.Name">
                            <button class="favorite-btn" data-sound-id="@sound.Id" title="Add to favorites">
                                <svg style="width: 20px; height: 20px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                                </svg>
                            </button>
                            <div class="play-icon-wrapper">
                                <svg class="play-icon" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M8 5v14l11-7z"/>
                                </svg>
                            </div>
                            <div class="sound-name">@sound.Name</div>
                            <div class="sound-plays">@sound.PlayCount plays</div>
                        </div>
                    }
                </div>

                <!-- Empty State -->
                <div id="emptyState" class="empty-state @(Model.Sounds.Count == 0 ? "" : "hidden")">
                    <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <p class="empty-state-title">No sounds found</p>
                    <p class="empty-state-text">Try a different search term</p>
                </div>

            </div>
        </div>

    </div>
</main>

    <!-- Hidden file input for upload -->
    <input type="file" id="fileInput" accept="audio/mp3,audio/wav,audio/ogg,.mp3,.wav,.ogg" class="hidden">
} @* End of IsAuthenticated else block *@

<!-- Toast Container -->
<div id="portalToastContainer" class="portal-toast-container"></div>

@section Scripts {
    <!-- SignalR for real-time updates -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script src="/js/dashboard-hub.js"></script>
@if (Model.IsAuthenticated)
{
    <script>
        // Pass guild ID to JavaScript as a string (critical for Discord snowflake IDs)
        window.guildId = '@Model.GuildId';

        // State
        let favorites = JSON.parse(localStorage.getItem('soundboard_favorites_' + window.guildId) || '[]');
        let currentlyPlaying = null;
        let currentlyPlayingName = null;
        let isConnected = @Model.IsConnected.ToString().ToLower();
        let selectedChannel = '@(Model.CurrentChannelId?.ToString() ?? "")';
        let searchDebounceTimer = null;
        let signalRConnected = false;

        // ========================================
        // Toast Notification System
        // ========================================
        const PortalToast = {
            container: null,
            icons: {
                success: '<svg class="portal-toast-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
                error: '<svg class="portal-toast-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
                warning: '<svg class="portal-toast-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>',
                info: '<svg class="portal-toast-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
            },

            init() {
                this.container = document.getElementById('portalToastContainer');
            },

            show(type, message, duration = 5000) {
                if (!this.container) this.init();

                const toast = document.createElement('div');
                toast.className = `portal-toast ${type}`;
                toast.innerHTML = `
                    ${this.icons[type]}
                    <span class="portal-toast-message">${this.escapeHtml(message)}</span>
                    <button class="portal-toast-close" aria-label="Dismiss">
                        <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                `;

                // Close button handler
                toast.querySelector('.portal-toast-close').addEventListener('click', () => this.dismiss(toast));

                this.container.appendChild(toast);

                // Auto dismiss
                if (duration > 0) {
                    setTimeout(() => this.dismiss(toast), duration);
                }

                return toast;
            },

            dismiss(toast) {
                if (!toast || !toast.parentNode) return;
                toast.classList.add('dismissing');
                setTimeout(() => toast.remove(), 200);
            },

            success(message, duration) { return this.show('success', message, duration); },
            error(message, duration) { return this.show('error', message, duration); },
            warning(message, duration) { return this.show('warning', message, duration); },
            info(message, duration) { return this.show('info', message, duration); },

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        };

        // ========================================
        // Initialization
        // ========================================
        document.addEventListener('DOMContentLoaded', async function() {
            PortalToast.init();
            initializeFavorites();
            setupEventHandlers();
            await initSignalR();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', async () => {
            if (signalRConnected) {
                await DashboardHub.leaveGuildAudioGroup(window.guildId);
                DashboardHub.disconnect();
            }
        });

        // ========================================
        // SignalR Real-Time Connection
        // ========================================
        async function initSignalR() {
            try {
                // Register event handlers before connecting
                DashboardHub.on('PlaybackStarted', handlePlaybackStarted);
                DashboardHub.on('PlaybackFinished', handlePlaybackFinished);
                DashboardHub.on('PlaybackProgress', handlePlaybackProgress);
                DashboardHub.on('AudioConnected', handleAudioConnected);
                DashboardHub.on('AudioDisconnected', handleAudioDisconnected);
                DashboardHub.on('VoiceChannelMemberCountUpdated', handleVoiceChannelMemberCountUpdated);
                DashboardHub.on('SoundUploaded', handleSoundUploaded);
                DashboardHub.on('SoundDeleted', handleSoundDeleted);

                // Connection state handlers
                DashboardHub.on('reconnected', async () => {
                    console.log('[Soundboard] SignalR reconnected, rejoining audio group');
                    await DashboardHub.joinGuildAudioGroup(window.guildId);
                    // Refresh status after reconnect
                    const status = await DashboardHub.getCurrentAudioStatus(window.guildId);
                    if (status) {
                        syncFromAudioStatus(status);
                    }
                });

                DashboardHub.on('disconnected', () => {
                    console.warn('[Soundboard] SignalR disconnected');
                    signalRConnected = false;
                });

                // Connect to SignalR hub
                const connected = await DashboardHub.connect();
                if (connected) {
                    signalRConnected = true;
                    console.log('[Soundboard] SignalR connected');

                    // Join the guild audio group to receive events
                    await DashboardHub.joinGuildAudioGroup(window.guildId);

                    // Get initial status
                    const status = await DashboardHub.getCurrentAudioStatus(window.guildId);
                    if (status) {
                        syncFromAudioStatus(status);
                    }
                } else {
                    console.warn('[Soundboard] Failed to connect to SignalR, updates may be delayed');
                }
            } catch (error) {
                console.error('[Soundboard] SignalR initialization error:', error);
            }
        }

        // Sync UI from audio status DTO
        function syncFromAudioStatus(status) {
            if (status.isConnected !== isConnected) {
                isConnected = status.isConnected;
                updateConnectionUI(isConnected);
            }

            if (!status.isPlaying && currentlyPlaying) {
                // Bot stopped playing
                currentlyPlaying = null;
                currentlyPlayingName = null;
                updateNowPlayingUI(null);
                document.querySelectorAll('.sound-card').forEach(card => {
                    card.classList.remove('playing');
                });
            }
        }

        // Handle playback started event from SignalR
        function handlePlaybackStarted(data) {
            console.log('[Soundboard] PlaybackStarted:', data.name);

            currentlyPlaying = data.soundId;
            currentlyPlayingName = data.name;

            // Update Now Playing panel
            updateNowPlayingUI(data.name);

            // Update card state
            document.querySelectorAll('.sound-card').forEach(card => {
                card.classList.remove('playing');
            });
            const playingCard = document.querySelector(`.sound-card[data-sound-id="${data.soundId}"]`);
            if (playingCard) {
                playingCard.classList.add('playing');

                // Increment play count in UI
                const playsEl = playingCard.querySelector('.sound-plays');
                if (playsEl) {
                    const currentText = playsEl.textContent;
                    const match = currentText.match(/^(\d+)/);
                    if (match) {
                        const newCount = parseInt(match[1], 10) + 1;
                        playsEl.textContent = `${newCount} plays`;
                    }
                }
            }
        }

        // Handle playback finished event from SignalR
        function handlePlaybackFinished(data) {
            console.log('[Soundboard] PlaybackFinished:', data.soundId, 'cancelled:', data.wasCancelled);

            currentlyPlaying = null;
            currentlyPlayingName = null;

            // Update Now Playing panel
            updateNowPlayingUI(null);

            // Remove playing state from cards
            document.querySelectorAll('.sound-card').forEach(card => {
                card.classList.remove('playing');
            });
        }

        // Handle playback progress event from SignalR (optional progress bar)
        function handlePlaybackProgress(data) {
            // Could be used for a progress bar in the future
            // For now, just confirms playback is ongoing
        }

        // Handle audio connected event from SignalR
        function handleAudioConnected(data) {
            console.log('[Soundboard] AudioConnected:', data.channelName, 'MemberCount:', data.memberCount);

            isConnected = true;
            updateConnectionUI(true, data.memberCount);

            // Update channel selector to show connected channel
            const channelSelect = document.getElementById('channelSelect');
            if (data.channelId && channelSelect) {
                channelSelect.value = data.channelId.toString();
                selectedChannel = data.channelId.toString();
            }
        }

        // Handle voice channel member count update from SignalR
        function handleVoiceChannelMemberCountUpdated(data) {
            console.log('[Soundboard] VoiceChannelMemberCountUpdated:', data.channelId, 'MemberCount:', data.memberCount);

            // Update member count display if connected to this channel
            if (isConnected && selectedChannel === data.channelId.toString()) {
                updateMemberCountDisplay(data.memberCount);
            }

            // Update the channel selector option for this channel
            const channelSelect = document.getElementById('channelSelect');
            if (channelSelect) {
                const option = channelSelect.querySelector(`option[value="${data.channelId}"]`);
                if (option) {
                    const channelName = data.channelName || option.textContent.replace(/\s*\(\d+\s*members?\)\s*$/, '').trim();
                    option.textContent = `${channelName} (${data.memberCount} ${data.memberCount === 1 ? 'member' : 'members'})`;
                }
            }
        }

        // Handle audio disconnected event from SignalR
        function handleAudioDisconnected(data) {
            console.log('[Soundboard] AudioDisconnected:', data.reason);

            isConnected = false;
            selectedChannel = '';
            currentlyPlaying = null;
            currentlyPlayingName = null;

            // Update UI
            updateConnectionUI(false, null);
            updateNowPlayingUI(null);
            document.getElementById('channelSelect').value = '';

            // Remove playing state from cards
            document.querySelectorAll('.sound-card').forEach(card => {
                card.classList.remove('playing');
            });
        }

        // Handle sound uploaded event from SignalR (another user uploaded a sound)
        function handleSoundUploaded(data) {
            console.log('[Soundboard] SoundUploaded:', data.name, data.soundId);

            // Check if this sound already exists (uploaded by this user)
            const existingCard = document.querySelector(`.sound-card[data-sound-id="${data.soundId}"]`);
            if (existingCard) {
                console.log('[Soundboard] Sound already in grid, skipping');
                return;
            }

            // Add the new sound to the grid
            addSoundToGrid({
                id: data.soundId,
                name: data.name,
                playCount: data.playCount
            });

            // Show a toast notification
            PortalToast.info(`New sound "${data.name}" was added`);
        }

        // Handle sound deleted event from SignalR (admin deleted a sound)
        function handleSoundDeleted(data) {
            console.log('[Soundboard] SoundDeleted:', data.soundId);

            const grid = document.getElementById('soundGrid');
            const emptyState = document.getElementById('emptyState');

            // Find and remove the sound card
            const card = document.querySelector(`.sound-card[data-sound-id="${data.soundId}"]`);
            if (card) {
                const soundName = card.getAttribute('data-sound-name') || 'Sound';

                // Add fade-out animation
                card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                card.style.opacity = '0';
                card.style.transform = 'scale(0.9)';

                setTimeout(() => {
                    card.remove();

                    // If deleted sound was playing, clear now playing UI
                    if (currentlyPlaying === data.soundId) {
                        currentlyPlaying = null;
                        currentlyPlayingName = null;
                        updateNowPlayingUI(null);
                    }

                    // Remove from favorites if present
                    const favIndex = favorites.indexOf(data.soundId);
                    if (favIndex > -1) {
                        favorites.splice(favIndex, 1);
                        localStorage.setItem('soundboard_favorites_' + window.guildId, JSON.stringify(favorites));
                    }

                    // Show empty state if no sounds remain
                    const remainingCards = grid.querySelectorAll('.sound-card');
                    if (remainingCards.length === 0) {
                        grid.classList.add('hidden');
                        emptyState.classList.remove('hidden');
                    }

                    // Show toast notification
                    PortalToast.warning(`Sound "${soundName}" was deleted`);
                }, 300);
            }
        }

        // Helper: Show toast notification
        function showToast(message, type = 'info') {
            // Remove existing toast if any
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = `toast-notification toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            // Trigger animation
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Helper: Update connection status UI
        function updateConnectionUI(connected, memberCount) {
            const statusBadge = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionStatusText');
            const joinBtn = document.getElementById('joinBtn');
            const leaveBtn = document.getElementById('leaveBtn');
            const memberCountEl = document.getElementById('channelMemberCount');

            if (connected) {
                statusBadge.classList.remove('disconnected');
                statusBadge.classList.add('connected');
                statusText.textContent = 'Connected';
                joinBtn.disabled = true;
                leaveBtn.disabled = false;
                // Show and update member count
                if (memberCountEl) {
                    memberCountEl.classList.remove('hidden');
                    if (memberCount !== undefined && memberCount !== null) {
                        memberCountEl.textContent = `${memberCount} ${memberCount === 1 ? 'member' : 'members'}`;
                    }
                }
            } else {
                statusBadge.classList.remove('connected');
                statusBadge.classList.add('disconnected');
                statusText.textContent = 'Disconnected';
                joinBtn.disabled = false;
                leaveBtn.disabled = true;
                // Hide member count
                if (memberCountEl) {
                    memberCountEl.classList.add('hidden');
                }
            }
        }

        // Helper: Update member count display
        function updateMemberCountDisplay(memberCount) {
            const memberCountEl = document.getElementById('channelMemberCount');
            if (memberCountEl && memberCount !== undefined && memberCount !== null) {
                memberCountEl.textContent = `${memberCount} ${memberCount === 1 ? 'member' : 'members'}`;
            }
        }

        // Helper: Update now playing UI
        function updateNowPlayingUI(soundName) {
            const nowPlayingContent = document.getElementById('nowPlayingContent');
            const nowPlayingEmpty = document.getElementById('nowPlayingEmpty');
            const nowPlayingNameEl = document.getElementById('nowPlayingName');

            if (soundName) {
                nowPlayingNameEl.textContent = soundName;
                nowPlayingContent.classList.remove('hidden');
                nowPlayingEmpty.classList.add('hidden');
            } else {
                nowPlayingContent.classList.add('hidden');
                nowPlayingEmpty.classList.remove('hidden');
            }
        }

        // Initialize favorites from localStorage
        function initializeFavorites() {
            favorites.forEach(soundId => {
                const btn = document.querySelector(`.favorite-btn[data-sound-id="${soundId}"]`);
                if (btn) {
                    btn.classList.add('active');
                    btn.querySelector('svg').setAttribute('fill', 'currentColor');
                }
            });

            // Sort sound cards: favorites first, then by name
            sortSoundGrid();
        }

        // Sort sound grid: favorites first, then alphabetical
        function sortSoundGrid() {
            const grid = document.getElementById('soundGrid');
            const cards = Array.from(grid.querySelectorAll('.sound-card'));

            cards.sort((a, b) => {
                const aId = a.getAttribute('data-sound-id');
                const bId = b.getAttribute('data-sound-id');
                const aFav = favorites.includes(aId);
                const bFav = favorites.includes(bId);

                if (aFav && !bFav) return -1;
                if (!aFav && bFav) return 1;

                const aName = a.getAttribute('data-sound-name');
                const bName = b.getAttribute('data-sound-name');
                return aName.localeCompare(bName);
            });

            // Re-append in sorted order
            cards.forEach(card => grid.appendChild(card));
        }

        // Setup event handlers
        function setupEventHandlers() {
            // Search functionality with debounce
            const searchInput = document.getElementById('searchInput');
            const clearBtn = document.getElementById('searchClearBtn');

            searchInput.addEventListener('input', function() {
                // Update clear button visibility
                clearBtn.classList.toggle('visible', this.value.length > 0);

                // Debounce search (150ms)
                clearTimeout(searchDebounceTimer);
                if (this.value === '') {
                    // Immediate clear when search is emptied
                    filterSounds();
                } else {
                    searchDebounceTimer = setTimeout(filterSounds, 150);
                }
            });

            // Clear search button
            clearBtn.addEventListener('click', function() {
                searchInput.value = '';
                clearBtn.classList.remove('visible');
                filterSounds();
                searchInput.focus();
            });

            // Channel select
            document.getElementById('channelSelect').addEventListener('change', function() {
                selectedChannel = this.value;
            });

            // Join/Leave buttons
            document.getElementById('joinBtn').addEventListener('click', joinChannel);
            document.getElementById('leaveBtn').addEventListener('click', leaveChannel);

            // Favorite buttons
            document.querySelectorAll('.favorite-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleFavorite(this.getAttribute('data-sound-id'));
                });
            });

            // Sound cards
            document.querySelectorAll('.sound-card').forEach(card => {
                card.addEventListener('click', function() {
                    const soundId = this.getAttribute('data-sound-id');
                    const soundName = this.getAttribute('data-sound-name');
                    playSound(soundId, soundName);
                });
            });

            // Stop button
            document.querySelector('.stop-btn').addEventListener('click', stopPlaying);

            // Upload dropzone
            const dropzone = document.getElementById('dropzone');
            dropzone.addEventListener('click', () => document.getElementById('fileInput').click());
            dropzone.addEventListener('dragover', handleDragOver);
            dropzone.addEventListener('dragleave', handleDragLeave);
            dropzone.addEventListener('drop', handleDrop);

            // File input
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);

            // Upload form handlers
            setupUploadHandlers();
        }

        // ========================================
        // Search Functionality
        // ========================================
        function filterSounds() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const cards = document.querySelectorAll('.sound-card');
            let visibleCount = 0;

            cards.forEach(card => {
                const soundName = card.getAttribute('data-sound-name').toLowerCase();
                if (soundName.includes(searchTerm)) {
                    card.style.display = '';
                    visibleCount++;
                } else {
                    card.style.display = 'none';
                }
            });

            // Show/hide empty state
            const grid = document.getElementById('soundGrid');
            const emptyState = document.getElementById('emptyState');
            if (visibleCount === 0) {
                grid.classList.add('hidden');
                emptyState.classList.remove('hidden');
            } else {
                grid.classList.remove('hidden');
                emptyState.classList.add('hidden');
            }
        }

        // ========================================
        // Favorites
        // ========================================
        function toggleFavorite(soundId) {
            const btn = document.querySelector(`.favorite-btn[data-sound-id="${soundId}"]`);
            const svg = btn.querySelector('svg');
            const index = favorites.indexOf(soundId);

            if (index === -1) {
                favorites.push(soundId);
                btn.classList.add('active');
                svg.setAttribute('fill', 'currentColor');
            } else {
                favorites.splice(index, 1);
                btn.classList.remove('active');
                svg.setAttribute('fill', 'none');
            }

            // Save to localStorage
            localStorage.setItem('soundboard_favorites_' + window.guildId, JSON.stringify(favorites));

            // Re-sort grid
            sortSoundGrid();
        }

        // ========================================
        // Sound Playback
        // ========================================
        function playSound(soundId, soundName) {
            if (!isConnected) {
                PortalToast.warning('Please join a voice channel first!');
                highlightChannelSelector();
                return;
            }

            // Call API to play sound
            fetch(`/api/portal/soundboard/${window.guildId}/play/${soundId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(async response => {
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    if (errorData.message === 'Not connected to voice channel') {
                        PortalToast.warning('Please join a voice channel first!');
                        highlightChannelSelector();
                        return Promise.reject('not_connected');
                    }
                    throw new Error(errorData.message || 'Failed to play sound');
                }
                return response.json();
            })
            .then(data => {
                if (!data) return; // Rejected promise

                currentlyPlaying = soundId;
                currentlyPlayingName = soundName;

                // Update Now Playing panel
                updateNowPlayingUI(soundName);

                // Update card state
                document.querySelectorAll('.sound-card').forEach(card => {
                    card.classList.remove('playing');
                });
                const playingCard = document.querySelector(`.sound-card[data-sound-id="${soundId}"]`);
                if (playingCard) {
                    playingCard.classList.add('playing');
                }
            })
            .catch(error => {
                if (error === 'not_connected') return;
                console.error('Error playing sound:', error);
                PortalToast.error(error.message || 'Failed to play sound. Please try again.');
            });
        }

        function highlightChannelSelector() {
            const selector = document.getElementById('channelSelect');
            selector.style.borderColor = '#fbbf24';
            selector.style.boxShadow = '0 0 0 2px rgba(251, 191, 36, 0.2)';
            setTimeout(() => {
                selector.style.borderColor = '';
                selector.style.boxShadow = '';
            }, 3000);
        }

        function stopPlaying() {
            if (!currentlyPlaying) return;

            // Call API to stop sound
            fetch(`/api/portal/soundboard/${window.guildId}/stop`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || 'Failed to stop sound');
                    });
                }
                return response.json();
            })
            .then(data => {
                currentlyPlaying = null;
                currentlyPlayingName = null;

                // Update Now Playing panel
                updateNowPlayingUI(null);

                // Remove playing state from cards
                document.querySelectorAll('.sound-card').forEach(card => {
                    card.classList.remove('playing');
                });
            })
            .catch(error => {
                console.error('Error stopping sound:', error);
                PortalToast.error(error.message || 'Failed to stop playback');
            });
        }

        // ========================================
        // Voice Channel Controls
        // ========================================
        function joinChannel() {
            if (!selectedChannel) {
                PortalToast.warning('Please select a voice channel first!');
                highlightChannelSelector();
                return;
            }

            const joinBtn = document.getElementById('joinBtn');
            joinBtn.disabled = true;
            joinBtn.innerHTML = '<svg class="animate-spin" fill="none" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Joining...';

            // Call API to join channel (POST /channel)
            fetch(`/api/portal/soundboard/${window.guildId}/channel`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ channelId: selectedChannel })
            })
            .then(async response => {
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Failed to join channel');
                }
                return response.json();
            })
            .then(data => {
                isConnected = true;
                updateConnectionUI(true);
                PortalToast.success('Connected to voice channel');
            })
            .catch(error => {
                console.error('Error joining channel:', error);
                PortalToast.error(error.message || 'Failed to join voice channel');
                joinBtn.disabled = false;
            })
            .finally(() => {
                // Reset button state
                joinBtn.disabled = isConnected;
                joinBtn.innerHTML = '<svg fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" /></svg> Join';
            });
        }

        function leaveChannel() {
            const leaveBtn = document.getElementById('leaveBtn');
            leaveBtn.disabled = true;
            leaveBtn.innerHTML = '<svg class="animate-spin" fill="none" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Leaving...';

            // Call API to leave channel (DELETE /channel)
            fetch(`/api/portal/soundboard/${window.guildId}/channel`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(async response => {
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || 'Failed to leave channel');
                }
                return response.json();
            })
            .then(data => {
                isConnected = false;
                selectedChannel = '';
                currentlyPlaying = null;
                currentlyPlayingName = null;

                // Update UI using helper functions
                updateConnectionUI(false);
                updateNowPlayingUI(null);
                document.getElementById('channelSelect').value = '';

                // Remove playing state from cards
                document.querySelectorAll('.sound-card').forEach(card => {
                    card.classList.remove('playing');
                });

                PortalToast.info('Disconnected from voice channel');
            })
            .catch(error => {
                console.error('Error leaving channel:', error);
                PortalToast.error(error.message || 'Failed to leave voice channel');
                leaveBtn.disabled = false;
            })
            .finally(() => {
                // Reset button state
                leaveBtn.disabled = !isConnected;
                leaveBtn.innerHTML = '<svg fill="none" viewBox="0 0 24 24" stroke="currentColor" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg> Leave';
            });
        }

        // ========================================
        // File Upload
        // ========================================
        let selectedFile = null;
        let isUploading = false;
        const maxSizeBytes = @Model.MaxFileSizeMB * 1024 * 1024;
        const maxSounds = @Model.MaxSounds;
        const currentSoundCount = @Model.CurrentSoundCount;

        function handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                selectFile(files[0]);
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('dropzone').classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('dropzone').classList.remove('drag-over');
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();
            document.getElementById('dropzone').classList.remove('drag-over');

            const files = event.dataTransfer.files;
            if (files.length > 0) {
                selectFile(files[0]);
            }
        }

        function selectFile(file) {
            // Clear any previous message
            hideUploadMessage();

            // Validate file type
            const validTypes = ['audio/mpeg', 'audio/wav', 'audio/ogg', 'audio/mp3', 'audio/x-wav'];
            const validExtensions = /\.(mp3|wav|ogg)$/i;
            if (!validTypes.includes(file.type) && !file.name.match(validExtensions)) {
                showUploadMessage('error', `Invalid file type. Please upload MP3, WAV, or OGG files.`);
                return;
            }

            // Validate file size
            if (file.size > maxSizeBytes) {
                showUploadMessage('error', `File too large. Maximum size is @Model.MaxFileSizeMB MB.`);
                return;
            }

            // Check sound count limit
            if (currentSoundCount >= maxSounds) {
                showUploadMessage('error', `Sound limit reached. This guild has ${maxSounds} sounds maximum. Please delete some before uploading new ones.`);
                return;
            }

            // Store selected file
            selectedFile = file;

            // Update dropzone appearance
            const dropzone = document.getElementById('dropzone');
            dropzone.classList.add('has-file');
            document.getElementById('dropzoneText').textContent = 'File selected';
            document.getElementById('dropzoneHint').textContent = 'Click to change';

            // Show upload form
            document.getElementById('uploadForm').classList.remove('hidden');
            document.getElementById('filePreviewName').textContent = file.name;
            document.getElementById('filePreviewSize').textContent = formatFileSize(file.size);

            // Pre-fill name from filename (without extension)
            const nameWithoutExt = file.name.replace(/\.[^/.]+$/, '');
            document.getElementById('soundNameInput').value = nameWithoutExt;
            document.getElementById('soundNameInput').focus();

            // Enable upload button
            updateUploadButton();
        }

        function clearFileSelection() {
            selectedFile = null;

            // Reset dropzone
            const dropzone = document.getElementById('dropzone');
            dropzone.classList.remove('has-file');
            document.getElementById('dropzoneText').textContent = 'Drop audio file here';
            document.getElementById('dropzoneHint').textContent = 'or click to browse';

            // Hide upload form
            document.getElementById('uploadForm').classList.add('hidden');
            document.getElementById('soundNameInput').value = '';
            document.getElementById('fileInput').value = '';

            // Hide any messages
            hideUploadMessage();
        }

        function updateUploadButton() {
            const btn = document.getElementById('uploadBtn');
            const name = document.getElementById('soundNameInput').value.trim();
            btn.disabled = !selectedFile || !name || isUploading;
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        function showUploadMessage(type, message) {
            const container = document.getElementById('uploadMessage');
            const icon = document.getElementById('uploadMessageIcon');
            const text = document.getElementById('uploadMessageText');

            container.classList.remove('hidden', 'success', 'error');
            container.classList.add(type);

            if (type === 'success') {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />';
            } else {
                icon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />';
            }

            text.textContent = message;
        }

        function hideUploadMessage() {
            document.getElementById('uploadMessage').classList.add('hidden');
        }

        function uploadFile() {
            if (!selectedFile || isUploading) return;

            const name = document.getElementById('soundNameInput').value.trim();
            if (!name) {
                showUploadMessage('error', 'Please enter a name for the sound.');
                return;
            }

            isUploading = true;
            updateUploadButton();

            // Show progress
            const progressContainer = document.getElementById('uploadProgress');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            progressContainer.classList.remove('hidden');
            progressBar.style.width = '0%';
            progressText.textContent = 'Uploading...';

            // Prepare form data
            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('name', name);

            // Use XMLHttpRequest for progress tracking
            const xhr = new XMLHttpRequest();
            xhr.open('POST', `/api/portal/soundboard/${window.guildId}/sounds`, true);

            xhr.upload.onprogress = function(event) {
                if (event.lengthComputable) {
                    const percent = Math.round((event.loaded / event.total) * 100);
                    progressBar.style.width = percent + '%';
                    progressText.textContent = `Uploading... ${percent}%`;
                }
            };

            xhr.onload = function() {
                isUploading = false;
                progressContainer.classList.add('hidden');

                if (xhr.status === 201) {
                    // Success
                    const data = JSON.parse(xhr.responseText);
                    showUploadMessage('success', `Sound "${data.name}" uploaded successfully!`);
                    clearFileSelection();

                    // Add the new sound to the grid without full page reload
                    addSoundToGrid(data);
                } else {
                    // Error - try to get message from response
                    let errorMessage = 'Upload failed. Please try again.';
                    try {
                        const error = JSON.parse(xhr.responseText);
                        if (error.message) {
                            errorMessage = error.message;
                            if (error.detail) {
                                errorMessage += ' ' + error.detail;
                            }
                        }
                    } catch (e) {
                        // Use default message
                    }
                    showUploadMessage('error', errorMessage);
                    updateUploadButton();
                }
            };

            xhr.onerror = function() {
                isUploading = false;
                progressContainer.classList.add('hidden');
                showUploadMessage('error', 'Network error. Please check your connection and try again.');
                updateUploadButton();
            };

            xhr.send(formData);
        }

        function addSoundToGrid(sound) {
            const grid = document.getElementById('soundGrid');
            const emptyState = document.getElementById('emptyState');

            // Hide empty state if visible
            emptyState.classList.add('hidden');
            grid.classList.remove('hidden');

            // Create new sound card
            const card = document.createElement('div');
            card.className = 'sound-card';
            card.setAttribute('data-sound-id', sound.id);
            card.setAttribute('data-sound-name', sound.name);
            card.innerHTML = `
                <button class="favorite-btn" data-sound-id="${sound.id}" title="Add to favorites">
                    <svg style="width: 20px; height: 20px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                    </svg>
                </button>
                <div class="play-icon-wrapper">
                    <svg class="play-icon" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </div>
                <div class="sound-name">${sound.name}</div>
                <div class="sound-plays">0 plays</div>
            `;

            // Add event listeners
            card.querySelector('.favorite-btn').addEventListener('click', function(e) {
                e.stopPropagation();
                toggleFavorite(sound.id);
            });

            card.addEventListener('click', function() {
                playSound(sound.id, sound.name);
            });

            // Add to beginning of grid (newest first)
            grid.insertBefore(card, grid.firstChild);

            // Re-sort with favorites
            initializeFavorites();
        }

        // Setup additional upload event handlers
        function setupUploadHandlers() {
            document.getElementById('clearFileBtn').addEventListener('click', clearFileSelection);
            document.getElementById('soundNameInput').addEventListener('input', updateUploadButton);
            document.getElementById('uploadBtn').addEventListener('click', uploadFile);

            // Handle Enter key in name input
            document.getElementById('soundNameInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    uploadFile();
                }
            });
        }

        // Add animate-spin class for loading spinners
        const style = document.createElement('style');
        style.textContent = `
            .animate-spin {
                animation: spin 1s linear infinite;
            }
            @@keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
}
}
