@page
@model DiscordBot.Bot.Pages.Commands.IndexModel
@using DiscordBot.Bot.ViewModels.Components
@using DiscordBot.Bot.ViewModels.Pages
@{
    ViewData["Title"] = "Commands";

    // Define tabs for the tab panel
    var tabs = new List<TabItemViewModel>
    {
        new TabItemViewModel { Id = "command-list", Label = "Command List" },
        new TabItemViewModel { Id = "execution-logs", Label = "Execution Logs" },
        new TabItemViewModel { Id = "analytics", Label = "Analytics" }
    };

    var tabPanel = new TabPanelViewModel
    {
        Id = "commandTabs",
        Tabs = tabs,
        ActiveTabId = Model.ActiveTab ?? "command-list",
        NavigationMode = TabNavigationMode.InPage,
        PersistenceMode = TabPersistenceMode.UrlHash
    };

    // Dynamic subtitle based on active tab
    var subtitle = Model.ActiveTab switch
    {
        "execution-logs" => "Command execution history",
        "analytics" => "Usage statistics and performance",
        _ => "All registered slash commands"
    };

    var headerModel = new CommandHeaderViewModel
    {
        Title = "Commands",
        Subtitle = subtitle,
        ActiveTab = Model.ActiveTab ?? "command-list"
    };

    var breadcrumbModel = new CommandBreadcrumbViewModel
    {
        ActiveTab = Model.ActiveTab ?? "command-list"
    };
}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Breadcrumb -->
    <partial name="Shared/Components/_CommandBreadcrumb" model="breadcrumbModel" />

    <!-- Header -->
    <partial name="Shared/Components/_CommandHeader" model="headerModel" />

    <!-- Action Bar (Clear Commands button and module count) -->
    <div class="flex items-center justify-between mb-6">
        <span class="text-sm text-text-secondary">
            @Model.ViewModel.ModuleCount module@(Model.ViewModel.ModuleCount != 1 ? "s" : "") registered
        </span>
        @if (User.IsInRole("Admin") || User.IsInRole("SuperAdmin"))
        {
            <button type="button"
                    onclick="window.quickActions?.showConfirmationModal('clearCommandsModal')"
                    class="flex items-center gap-2 px-4 py-2 bg-warning hover:bg-amber-600 active:bg-amber-700 text-text-inverse font-semibold text-sm rounded-lg transition-colors">
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Clear & Re-register Globally
            </button>
        }
    </div>

    <!-- Tab Panel Navigation -->
    <partial name="Shared/Components/_TabPanel" model="tabPanel" />

    <!-- Tab 1: Command List -->
    <div data-tab-panel-for="commandTabs" data-tab-id="command-list" role="tabpanel" aria-labelledby="commandTabs-tab-command-list">
    @if (Model.ViewModel.HasModules)
    {
        <!-- Command Modules -->
        <div class="space-y-4">
            @foreach (var module in Model.ViewModel.Modules)
            {
                <div class="bg-bg-secondary border border-border-primary rounded-lg overflow-hidden" id="module-@module.ModuleId">
                    <!-- Module Header (clickable to expand/collapse) -->
                    <button type="button"
                            class="w-full flex items-center justify-between px-6 py-4 hover:bg-bg-hover/50 transition-colors focus:outline-none focus:ring-2 focus:ring-border-focus focus:ring-inset"
                            onclick="toggleModule('@module.ModuleId')"
                            aria-expanded="true"
                            aria-controls="commands-@module.ModuleId">
                        <div class="flex items-center gap-3">
                            <!-- Module Icon -->
                            <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-accent-blue to-accent-orange flex items-center justify-center text-white flex-shrink-0">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                            </div>
                            <div class="text-left">
                                <h2 class="text-lg font-semibold text-text-primary">
                                    @module.DisplayName
                                    @if (module.IsSlashGroup && !string.IsNullOrEmpty(module.GroupName))
                                    {
                                        <span class="text-text-tertiary font-normal text-sm ml-2">/@module.GroupName</span>
                                    }
                                </h2>
                                @if (!string.IsNullOrEmpty(module.Description))
                                {
                                    <p class="text-sm text-text-secondary">@module.Description</p>
                                }
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="text-sm text-text-tertiary">@module.CommandCount command@(module.CommandCount != 1 ? "s" : "")</span>
                            <svg class="w-5 h-5 text-text-tertiary transition-transform duration-200 module-chevron" fill="none" viewBox="0 0 24 24" stroke="currentColor" data-module="@module.ModuleId">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </button>

                    <!-- Command List (collapsible) -->
                    <div id="commands-@module.ModuleId" class="border-t border-border-primary">
                        <div class="divide-y divide-border-secondary">
                            @foreach (var command in module.Commands)
                            {
                                <div class="px-6 py-4 hover:bg-bg-hover/30 transition-colors">
                                    <div class="flex flex-col lg:flex-row lg:items-start gap-3">
                                        <!-- Command Name and Parameters -->
                                        <div class="flex-1 min-w-0">
                                            <div class="flex flex-wrap items-center gap-2 mb-1">
                                                <code class="text-accent-orange font-mono font-semibold text-sm">@command.FullDisplayName</code>
                                                @if (!string.IsNullOrEmpty(command.ParametersDisplay))
                                                {
                                                    <code class="text-text-tertiary font-mono text-sm">@command.ParametersDisplay</code>
                                                }
                                            </div>
                                            <p class="text-sm text-text-secondary">@command.Description</p>

                                            <!-- Parameters Details (if any) -->
                                            @if (command.HasParameters)
                                            {
                                                <div class="mt-3 space-y-2">
                                                    @foreach (var param in command.Parameters)
                                                    {
                                                        <div class="flex items-start gap-2 text-sm">
                                                            <span class="font-mono text-text-primary">@param.Name</span>
                                                            <span class="text-text-tertiary">(@param.Type@(param.IsRequired ? ", required" : ", optional"))</span>
                                                            @if (!string.IsNullOrEmpty(param.Description))
                                                            {
                                                                <span class="text-text-secondary">- @param.Description</span>
                                                            }
                                                        </div>
                                                        @if (param.HasChoices)
                                                        {
                                                            <div class="ml-4 text-xs text-text-tertiary">
                                                                Choices: @string.Join(", ", param.Choices!)
                                                            </div>
                                                        }
                                                    }
                                                </div>
                                            }
                                        </div>

                                        <!-- Precondition Badges -->
                                        @if (command.HasPreconditions)
                                        {
                                            <div class="flex flex-wrap gap-2 lg:flex-shrink-0">
                                                @foreach (var badge in command.PreconditionBadges)
                                                {
                                                    <partial name="Shared/Components/_Badge" model="badge" />
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
    else
    {
        <!-- Empty State -->
        <div class="bg-bg-secondary border border-border-primary rounded-lg p-12">
            @{
                var emptyState = new EmptyStateViewModel
                {
                    Type = EmptyStateType.NoData,
                    Title = "No commands loaded",
                    Description = "The bot hasn't loaded any command modules yet. Commands will appear once the bot has connected to Discord."
                };
            }
            <partial name="Shared/Components/_EmptyState" model="emptyState" />
        </div>
    }
    </div>

    <!-- Tab 2: Execution Logs -->
    <div id="commandTabs-panel-execution-logs" data-tab-panel-for="commandTabs" data-tab-id="execution-logs" role="tabpanel" aria-labelledby="commandTabs-tab-execution-logs" hidden>
        @{
            // Calculate active filter count for Execution Logs (includes all 6 filters)
            var logsActiveFilterCount = 0;
            if (Model.StartDate.HasValue) logsActiveFilterCount++;
            if (Model.EndDate.HasValue) logsActiveFilterCount++;
            if (Model.GuildId.HasValue) logsActiveFilterCount++;
            if (!string.IsNullOrWhiteSpace(Model.SearchTerm)) logsActiveFilterCount++;
            if (!string.IsNullOrWhiteSpace(Model.CommandName)) logsActiveFilterCount++;
            if (Model.StatusFilter.HasValue) logsActiveFilterCount++;

            var logsHasActiveFilters = logsActiveFilterCount > 0;

            // Quick filter detection for Execution Logs
            var today = DateTime.UtcNow.Date;
            var isToday = Model.StartDate.HasValue && Model.EndDate.HasValue &&
                         Model.StartDate.Value.Date == today && Model.EndDate.Value.Date == today;
            var is7Days = Model.StartDate.HasValue && Model.EndDate.HasValue &&
                         Model.StartDate.Value.Date == today.AddDays(-7) && Model.EndDate.Value.Date == today;
            var is30Days = Model.StartDate.HasValue && Model.EndDate.HasValue &&
                          Model.StartDate.Value.Date == today.AddDays(-30) && Model.EndDate.Value.Date == today;

            // Command autocomplete ViewModel
            var commandAutocomplete = new AutocompleteInputViewModel
            {
                Id = "CommandName",
                Name = "CommandName",
                Label = "Command",
                Placeholder = "Search by command name...",
                Endpoint = "/api/autocomplete/commands",
                InitialValue = Model.CommandName,
                InitialDisplayText = Model.CommandName,
                NoResultsMessage = "No commands found"
            };
        }

        <!-- Filter Panel -->
        <div class="bg-bg-secondary border border-border-primary rounded-lg mb-6" data-filter-panel="executionLogsFilter" data-has-active-filters="@logsHasActiveFilters.ToString().ToLower()">
            <button type="button"
                    id="executionLogsFilter-toggle"
                    class="w-full flex items-center justify-between px-5 py-4 text-left"
                    aria-expanded="@logsHasActiveFilters.ToString().ToLower()"
                    aria-controls="executionLogsFilter-content"
                    onclick="window.DateRangeFilter?.togglePanel('executionLogsFilter')">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                    </svg>
                    <span class="text-lg font-semibold text-text-primary">Filters</span>
                    @if (logsHasActiveFilters)
                    {
                        <partial name="Shared/Components/_Badge" model="@(new BadgeViewModel { Text = $"{logsActiveFilterCount} active", Variant = BadgeVariant.Orange, Size = BadgeSize.Small })" />
                    }
                </div>
                <svg id="executionLogsFilter-chevron" class="w-5 h-5 text-text-secondary transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </button>

            <div id="executionLogsFilter-content" class="overflow-hidden transition-all duration-300" style="max-height: 0;">
                <div class="border-t border-border-primary p-6">
                    <form method="get" id="executionLogsFilterForm" onsubmit="window.DateRangeFilter?.preserveHashAndSubmit(this); return false;">
                        <input type="hidden" name="ActiveTab" value="execution-logs" />

                        <!-- Quick Date Presets -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-text-primary mb-2">Quick Date Range</label>
                            <div class="flex flex-wrap gap-2">
                                <button type="button"
                                        onclick="window.DateRangeFilter?.setPreset('executionLogsFilter', 'today')"
                                        class="px-4 py-2 text-sm font-medium rounded-lg transition-colors border @(isToday ? "bg-accent-blue text-white border-accent-blue" : "bg-bg-tertiary text-text-secondary border-border-primary hover:bg-bg-hover")">
                                    Today
                                </button>
                                <button type="button"
                                        onclick="window.DateRangeFilter?.setPreset('executionLogsFilter', '7days')"
                                        class="px-4 py-2 text-sm font-medium rounded-lg transition-colors border @(is7Days ? "bg-accent-blue text-white border-accent-blue" : "bg-bg-tertiary text-text-secondary border-border-primary hover:bg-bg-hover")">
                                    Last 7 Days
                                </button>
                                <button type="button"
                                        onclick="window.DateRangeFilter?.setPreset('executionLogsFilter', '30days')"
                                        class="px-4 py-2 text-sm font-medium rounded-lg transition-colors border @(is30Days ? "bg-accent-blue text-white border-accent-blue" : "bg-bg-tertiary text-text-secondary border-border-primary hover:bg-bg-hover")">
                                    Last 30 Days
                                </button>
                            </div>
                        </div>

                        <!-- Filter Grid -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4 mb-4">
                            <!-- Start Date -->
                            <div>
                                <label for="logs-StartDate" class="block text-sm font-medium text-text-primary mb-1">Start Date</label>
                                <input type="date" id="logs-StartDate" name="StartDate"
                                       value="@Model.StartDate?.ToString("yyyy-MM-dd")"
                                       class="w-full px-3 py-2 text-sm bg-bg-primary border border-border-primary rounded-lg text-text-primary focus:border-border-focus focus:ring-1 focus:ring-border-focus transition-colors" />
                            </div>

                            <!-- End Date -->
                            <div>
                                <label for="logs-EndDate" class="block text-sm font-medium text-text-primary mb-1">End Date</label>
                                <input type="date" id="logs-EndDate" name="EndDate"
                                       value="@Model.EndDate?.ToString("yyyy-MM-dd")"
                                       class="w-full px-3 py-2 text-sm bg-bg-primary border border-border-primary rounded-lg text-text-primary focus:border-border-focus focus:ring-1 focus:ring-border-focus transition-colors" />
                            </div>

                            <!-- Guild -->
                            <div>
                                <label for="logs-GuildId" class="block text-sm font-medium text-text-primary mb-1">Server</label>
                                <select id="logs-GuildId" name="GuildId"
                                        class="w-full px-3 py-2 text-sm bg-bg-primary border border-border-primary rounded-lg text-text-primary focus:border-border-focus focus:ring-1 focus:ring-border-focus transition-colors">
                                    <option value="">All Servers</option>
                                    @foreach (var guild in Model.AvailableGuilds)
                                    {
                                        <option value="@guild.Id" selected="@(Model.GuildId == guild.Id)">@guild.Name</option>
                                    }
                                </select>
                            </div>

                            <!-- Command Name (Autocomplete) -->
                            <div>
                                <partial name="Shared/Components/_AutocompleteInput" model="commandAutocomplete" />
                            </div>

                            <!-- Status Filter -->
                            <div>
                                <label for="logs-StatusFilter" class="block text-sm font-medium text-text-primary mb-1">Status</label>
                                <select id="logs-StatusFilter" name="StatusFilter"
                                        class="w-full px-3 py-2 text-sm bg-bg-primary border border-border-primary rounded-lg text-text-primary focus:border-border-focus focus:ring-1 focus:ring-border-focus transition-colors">
                                    <option value="">All Statuses</option>
                                    <option value="true" selected="@(Model.StatusFilter == true)">Success</option>
                                    <option value="false" selected="@(Model.StatusFilter == false)">Failure</option>
                                </select>
                            </div>
                        </div>

                        <!-- Search Input (Full Width) -->
                        <div class="mb-4">
                            <label for="logs-SearchTerm" class="block text-sm font-medium text-text-primary mb-1">Search</label>
                            <input type="text" id="logs-SearchTerm" name="SearchTerm"
                                   value="@Model.SearchTerm"
                                   placeholder="Search in user names, command names, parameters..."
                                   class="w-full px-3 py-2 text-sm bg-bg-primary border border-border-primary rounded-lg text-text-primary placeholder-text-tertiary focus:border-border-focus focus:ring-1 focus:ring-border-focus transition-colors" />
                        </div>

                        <!-- Filter Actions -->
                        <div class="flex items-center gap-3">
                            <button type="submit" class="btn btn-primary">
                                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                                </svg>
                                Apply Filters
                            </button>
                            @if (logsHasActiveFilters)
                            {
                                <button type="button" onclick="window.DateRangeFilter?.clearFiltersAndReload('executionLogsFilterForm')" class="btn btn-secondary">
                                    <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                    Clear Filters
                                </button>
                            }
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Content Container -->
        <div data-tab-content>
            <div class="bg-bg-secondary border border-border-primary rounded-lg p-8 text-center">
                <p class="text-text-secondary">Execution logs will be loaded here...</p>
            </div>
        </div>
    </div>

    <!-- Tab 3: Analytics -->
    <div id="commandTabs-panel-analytics" data-tab-panel-for="commandTabs" data-tab-id="analytics" role="tabpanel" aria-labelledby="commandTabs-tab-analytics" hidden>
        @{
            // Calculate active filter count for Analytics (only 3 filters)
            var analyticsActiveFilterCount = 0;
            if (Model.StartDate.HasValue) analyticsActiveFilterCount++;
            if (Model.EndDate.HasValue) analyticsActiveFilterCount++;
            if (Model.GuildId.HasValue) analyticsActiveFilterCount++;

            var analyticsHasActiveFilters = analyticsActiveFilterCount > 0;

            // Reuse quick filter detection from above (already calculated)
        }

        <!-- Filter Panel -->
        <div class="bg-bg-secondary border border-border-primary rounded-lg mb-6" data-filter-panel="analyticsFilter" data-has-active-filters="@analyticsHasActiveFilters.ToString().ToLower()">
            <button type="button"
                    id="analyticsFilter-toggle"
                    class="w-full flex items-center justify-between px-5 py-4 text-left"
                    aria-expanded="@analyticsHasActiveFilters.ToString().ToLower()"
                    aria-controls="analyticsFilter-content"
                    onclick="window.DateRangeFilter?.togglePanel('analyticsFilter')">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                    </svg>
                    <span class="text-lg font-semibold text-text-primary">Filters</span>
                    @if (analyticsHasActiveFilters)
                    {
                        <partial name="Shared/Components/_Badge" model="@(new BadgeViewModel { Text = $"{analyticsActiveFilterCount} active", Variant = BadgeVariant.Orange, Size = BadgeSize.Small })" />
                    }
                </div>
                <svg id="analyticsFilter-chevron" class="w-5 h-5 text-text-secondary transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </button>

            <div id="analyticsFilter-content" class="overflow-hidden transition-all duration-300" style="max-height: 0;">
                <div class="border-t border-border-primary p-6">
                    <form method="get" id="analyticsFilterForm" onsubmit="window.DateRangeFilter?.preserveHashAndSubmit(this); return false;">
                        <input type="hidden" name="ActiveTab" value="analytics" />

                        <!-- Quick Date Presets -->
                        <div class="mb-4">
                            <label class="block text-sm font-medium text-text-primary mb-2">Quick Date Range</label>
                            <div class="flex flex-wrap gap-2">
                                <button type="button"
                                        onclick="window.DateRangeFilter?.setPreset('analyticsFilter', 'today')"
                                        class="px-4 py-2 text-sm font-medium rounded-lg transition-colors border @(isToday ? "bg-accent-blue text-white border-accent-blue" : "bg-bg-tertiary text-text-secondary border-border-primary hover:bg-bg-hover")">
                                    Today
                                </button>
                                <button type="button"
                                        onclick="window.DateRangeFilter?.setPreset('analyticsFilter', '7days')"
                                        class="px-4 py-2 text-sm font-medium rounded-lg transition-colors border @(is7Days ? "bg-accent-blue text-white border-accent-blue" : "bg-bg-tertiary text-text-secondary border-border-primary hover:bg-bg-hover")">
                                    Last 7 Days
                                </button>
                                <button type="button"
                                        onclick="window.DateRangeFilter?.setPreset('analyticsFilter', '30days')"
                                        class="px-4 py-2 text-sm font-medium rounded-lg transition-colors border @(is30Days ? "bg-accent-blue text-white border-accent-blue" : "bg-bg-tertiary text-text-secondary border-border-primary hover:bg-bg-hover")">
                                    Last 30 Days
                                </button>
                            </div>
                        </div>

                        <!-- Filter Grid (3 columns on xl) -->
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                            <!-- Start Date -->
                            <div>
                                <label for="analytics-StartDate" class="block text-sm font-medium text-text-primary mb-1">Start Date</label>
                                <input type="date" id="analytics-StartDate" name="StartDate"
                                       value="@Model.StartDate?.ToString("yyyy-MM-dd")"
                                       class="w-full px-3 py-2 text-sm bg-bg-primary border border-border-primary rounded-lg text-text-primary focus:border-border-focus focus:ring-1 focus:ring-border-focus transition-colors" />
                            </div>

                            <!-- End Date -->
                            <div>
                                <label for="analytics-EndDate" class="block text-sm font-medium text-text-primary mb-1">End Date</label>
                                <input type="date" id="analytics-EndDate" name="EndDate"
                                       value="@Model.EndDate?.ToString("yyyy-MM-dd")"
                                       class="w-full px-3 py-2 text-sm bg-bg-primary border border-border-primary rounded-lg text-text-primary focus:border-border-focus focus:ring-1 focus:ring-border-focus transition-colors" />
                            </div>

                            <!-- Guild -->
                            <div>
                                <label for="analytics-GuildId" class="block text-sm font-medium text-text-primary mb-1">Server</label>
                                <select id="analytics-GuildId" name="GuildId"
                                        class="w-full px-3 py-2 text-sm bg-bg-primary border border-border-primary rounded-lg text-text-primary focus:border-border-focus focus:ring-1 focus:ring-border-focus transition-colors">
                                    <option value="">All Servers</option>
                                    @foreach (var guild in Model.AvailableGuilds)
                                    {
                                        <option value="@guild.Id" selected="@(Model.GuildId == guild.Id)">@guild.Name</option>
                                    }
                                </select>
                            </div>
                        </div>

                        <!-- Filter Actions -->
                        <div class="flex items-center gap-3">
                            <button type="submit" class="btn btn-primary">
                                <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                                </svg>
                                Apply Filters
                            </button>
                            @if (analyticsHasActiveFilters)
                            {
                                <button type="button" onclick="window.DateRangeFilter?.clearFiltersAndReload('analyticsFilterForm')" class="btn btn-secondary">
                                    <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                    Clear Filters
                                </button>
                            }
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Content Container -->
        <div data-tab-content>
            <div class="bg-bg-secondary border border-border-primary rounded-lg p-8 text-center">
                <p class="text-text-secondary">Analytics will be loaded here...</p>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
@if (Model.ClearCommandsModal != null)
{
    <partial name="Shared/Components/_ConfirmationModal" model="Model.ClearCommandsModal" />
}

@section Styles {
    <link rel="stylesheet" href="~/css/tab-panel.css" asp-append-version="true" />
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="~/js/quick-actions.js"></script>
    <script src="~/js/tab-panel.js" asp-append-version="true"></script>
    <script src="~/js/command-tabs.js" asp-append-version="true"></script>
    <script src="~/js/command-tab-loader.js" asp-append-version="true"></script>
    <script src="~/js/command-filters.js" asp-append-version="true"></script>
    <script src="~/js/command-pagination.js" asp-append-version="true"></script>
    <script src="~/js/url-state.js" asp-append-version="true"></script>
    <script src="~/js/date-range-filter.js" asp-append-version="true"></script>
    <script src="~/js/autocomplete.js" asp-append-version="true"></script>
    <script>
        function toggleModule(moduleId) {
            const commandsContainer = document.getElementById('commands-' + moduleId);
            const chevron = document.querySelector('.module-chevron[data-module="' + moduleId + '"]');
            const button = commandsContainer.parentElement.querySelector('button');

            if (commandsContainer.classList.contains('hidden')) {
                commandsContainer.classList.remove('hidden');
                chevron.classList.remove('rotate-180');
                button.setAttribute('aria-expanded', 'true');
            } else {
                commandsContainer.classList.add('hidden');
                chevron.classList.add('rotate-180');
                button.setAttribute('aria-expanded', 'false');
            }
        }

        // Helper function to initialize tab-specific modules after AJAX load
        function initializeTabSpecificModules(tabId) {
            // Convert timestamps to local time
            if (window.timezoneUtils && typeof window.timezoneUtils.convertDisplayTimes === 'function') {
                window.timezoneUtils.convertDisplayTimes();
            }

            // Re-initialize autocomplete if present
            if (window.Autocomplete && typeof window.Autocomplete.init === 'function') {
                window.Autocomplete.init();
            }

            // Re-initialize filter panels after AJAX load (fixes scrollHeight calculation)
            if (window.DateRangeFilter && window.DateRangeFilter.initFilterPanels) {
                // Small delay to ensure DOM is painted
                requestAnimationFrame(function() {
                    window.DateRangeFilter.initFilterPanels();
                });
            }

            // Initialize analytics charts if on analytics tab
            // Use requestAnimationFrame to ensure DOM is painted before initializing charts
            if (tabId === 'analytics') {
                requestAnimationFrame(function() {
                    if (window.initializeAnalyticsCharts && typeof window.initializeAnalyticsCharts === 'function') {
                        window.initializeAnalyticsCharts();
                    }
                });
            }
        }

        // Initialize AJAX modules when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize URL state management first (before other modules)
            if (window.UrlState) {
                window.UrlState.init({
                    onStateRestore: function(urlState) {
                        console.log('UrlState: State restored from URL:', urlState);
                    }
                });
            }

            // Initialize tab loader for AJAX content loading
            if (window.CommandTabLoader) {
                window.CommandTabLoader.init({
                    onLoadStart: function(tabId) {
                        console.log('Loading tab:', tabId);
                    },
                    onLoadComplete: function(tabId, content) {
                        console.log('Tab loaded:', tabId);
                        // Re-initialize filters and pagination after content loads
                        initializeTabSpecificModules(tabId);
                    },
                    onError: function(tabId, error) {
                        console.error('Failed to load tab:', tabId, error);
                    }
                });
            }

            // Initialize filter handlers for both execution logs and analytics
            if (window.CommandFilters) {
                window.CommandFilters.init({
                    formSelector: '#executionLogsFilterForm, #analyticsFilterForm',
                    onFiltersApplied: function(filters) {
                        console.log('Filters applied:', filters);

                        // Update URL with filter state (skip if restoring from URL to prevent loops)
                        if (window.UrlState && !window.UrlState.isRestoringFromUrl()) {
                            const currentPage = window.CommandPagination ? window.CommandPagination.getCurrentPage() : null;
                            const urlState = window.UrlState.getStateForUrl(filters, currentPage);
                            window.UrlState.updateUrl(urlState, { replaceHistory: true });
                        }

                        // Reload active tab with filters
                        if (window.CommandTabLoader) {
                            window.CommandTabLoader.reloadActiveTab();
                        }
                    },
                    onFiltersClear: function() {
                        console.log('Filters cleared');

                        // Clear URL parameters
                        if (window.UrlState) {
                            window.UrlState.clearUrl();
                        }
                    }
                });
            }

            // Initialize pagination
            if (window.CommandPagination) {
                window.CommandPagination.init({
                    scrollBehavior: 'top',
                    onPageChange: function(page) {
                        console.log('Page changed to:', page);

                        // Update URL with new page (skip if restoring from URL)
                        if (window.UrlState && !window.UrlState.isRestoringFromUrl()) {
                            const filters = window.CommandFilters ? window.CommandFilters.getFilters() : {};
                            const urlState = window.UrlState.getStateForUrl(filters, page);
                            window.UrlState.updateUrl(urlState, { replaceHistory: true });
                        }

                        // Reload active tab with new page
                        if (window.CommandTabLoader) {
                            window.CommandTabLoader.reloadActiveTab();
                        }
                    }
                });
            }

            // Restore state from URL after all modules are initialized
            if (window.UrlState) {
                const urlState = window.UrlState.restoreStateFromUrl();

                // If URL had state, trigger a reload to apply it
                if (Object.keys(urlState).length > 0 && window.CommandTabLoader) {
                    // Use requestAnimationFrame to ensure DOM is fully ready
                    // This is more reliable than setTimeout for DOM-related operations
                    requestAnimationFrame(function() {
                        // Double RAF ensures painting is complete
                        requestAnimationFrame(function() {
                            window.CommandTabLoader.reloadActiveTab();
                        });
                    });
                }
            }
        });
    </script>
}
