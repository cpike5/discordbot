@model DiscordBot.Bot.ViewModels.Components.VoiceSelectorViewModel
@using DiscordBot.Bot.ViewModels.Components

@*
    VoiceSelector Component
    -----------------------
    Custom 2-tier dropdown selector for TTS voices with language grouping.

    Features:
    - Trigger button displays selected voice as "Name (Gender) - Language" or placeholder
    - Dropdown panel with search input and scrollable language groups
    - Two-tier structure: Language groups (collapsible) â†’ Voice options
    - Client-side search/filter with auto-expand on match
    - Keyboard navigation (ArrowUp/Down, Enter, Escape, Home, End)
    - Click-outside to close
    - Accessible with ARIA attributes

    Usage:
    var model = new VoiceSelectorViewModel
    {
        Voices = GetAvailableVoices(),
        SelectedVoice = "en-US-JennyNeural",
        ContainerId = "voiceSelector",
        OnVoiceChange = "handleVoiceChange",
        Placeholder = "Select a voice",
        SearchPlaceholder = "Search voices..."
    };
    @await Html.PartialAsync("Components/_VoiceSelector", model)
*@

@{
    var voicesByLocale = Model.Voices
        .GroupBy(v => new { v.Locale, v.LocaleDisplayName })
        .OrderBy(g => g.Key.LocaleDisplayName)
        .ToList();

    var selectedVoiceOption = Model.Voices.FirstOrDefault(v => v.Value == Model.SelectedVoice);
    var triggerText = selectedVoiceOption != null
        ? $"{selectedVoiceOption.DisplayName} ({selectedVoiceOption.Gender}) - {selectedVoiceOption.LocaleDisplayName}"
        : Model.Placeholder;
}

<div id="@Model.ContainerId"
     class="voice-selector"
     data-selected-voice="@Model.SelectedVoice"
     data-callback-voice="@Model.OnVoiceChange">

    <!-- Trigger Button -->
    <button type="button"
            class="voice-selector__trigger"
            aria-haspopup="listbox"
            aria-expanded="false"
            onclick="voiceSelector_toggle('@Model.ContainerId')">
        <span class="voice-selector__trigger-text">@triggerText</span>
        <svg class="voice-selector__trigger-icon"
             fill="none"
             viewBox="0 0 24 24"
             stroke="currentColor"
             aria-hidden="true">
            <path stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
        </svg>
    </button>

    <!-- Dropdown Panel -->
    <div class="voice-selector__dropdown" role="listbox" aria-label="Voice options" style="display: none;">
        <!-- Search Input -->
        <div class="voice-selector__search-wrapper">
            <svg class="voice-selector__search-icon"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke="currentColor"
                 aria-hidden="true">
                <path stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" />
            </svg>
            <input type="text"
                   class="voice-selector__search"
                   placeholder="@Model.SearchPlaceholder"
                   aria-label="Search voices"
                   oninput="voiceSelector_search('@Model.ContainerId')" />
        </div>

        <!-- Voice Groups -->
        <div class="voice-selector__list">
            @if (voicesByLocale.Any())
            {
                foreach (var group in voicesByLocale)
                {
                    var voiceCount = group.Count();
                    <div class="voice-selector__group" data-locale="@group.Key.Locale">
                        <!-- Group Header (Tier 1) -->
                        <button type="button"
                                class="voice-selector__group-header"
                                aria-expanded="true"
                                onclick="voiceSelector_toggleGroup('@Model.ContainerId', '@group.Key.Locale')">
                            <span class="voice-selector__group-name">@group.Key.LocaleDisplayName</span>
                            <span class="voice-selector__group-count">@voiceCount</span>
                            <svg class="voice-selector__group-chevron"
                                 fill="none"
                                 viewBox="0 0 24 24"
                                 stroke="currentColor"
                                 aria-hidden="true">
                                <path stroke-linecap="round"
                                      stroke-linejoin="round"
                                      stroke-width="2"
                                      d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                            </svg>
                        </button>

                        <!-- Voice Options (Tier 2) -->
                        <div class="voice-selector__options">
                            @foreach (var voice in group.OrderBy(v => v.DisplayName))
                            {
                                var isSelected = voice.Value == Model.SelectedVoice;
                                var searchText = $"{voice.DisplayName} {voice.Gender} {voice.LocaleDisplayName}".ToLower();
                                <button type="button"
                                        class="voice-selector__option @(isSelected ? "voice-selector__option--selected" : "")"
                                        role="option"
                                        aria-selected="@isSelected.ToString().ToLower()"
                                        data-voice-value="@voice.Value"
                                        data-voice-display="@voice.DisplayName"
                                        data-voice-gender="@voice.Gender"
                                        data-voice-locale="@voice.LocaleDisplayName"
                                        data-search-text="@searchText"
                                        onclick="voiceSelector_selectFromButton(this)">
                                    <span class="voice-selector__option-name">@voice.DisplayName</span>
                                    <span class="voice-selector__option-gender">(@voice.Gender)</span>
                                    @if (isSelected)
                                    {
                                        <svg class="voice-selector__option-checkmark"
                                             fill="none"
                                             viewBox="0 0 24 24"
                                             stroke="currentColor"
                                             aria-hidden="true">
                                            <path stroke-linecap="round"
                                                  stroke-linejoin="round"
                                                  stroke-width="2"
                                                  d="M4.5 12.75l6 6 9-13.5" />
                                        </svg>
                                    }
                                </button>
                            }
                        </div>
                    </div>
                }
            }
            else
            {
                <div class="voice-selector__empty">No voices available</div>
            }
        </div>

        <!-- Empty State (Hidden by default, shown during search) -->
        <div class="voice-selector__empty" style="display: none;">No voices found</div>
    </div>
</div>

<style>
    /* Container */
    .voice-selector {
        position: relative;
        display: flex;
        flex-direction: column;
    }

    /* Trigger Button */
    .voice-selector__trigger {
        width: 100%;
        padding: 0.625rem 2.5rem 0.625rem 0.75rem;
        background: var(--color-bg-primary);
        border: 1px solid var(--color-border-primary);
        border-radius: 0.5rem;
        color: var(--color-text-primary);
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
        text-align: left;
        display: flex;
        align-items: center;
        justify-content: space-between;
        appearance: none;
    }

    .voice-selector__trigger:hover {
        border-color: var(--color-accent-orange-hover);
        background: var(--color-bg-hover);
    }

    .voice-selector__trigger:focus {
        outline: none;
        border-color: var(--color-accent-orange);
        box-shadow: 0 0 0 3px var(--color-accent-orange-muted);
    }

    .voice-selector__trigger[aria-expanded="true"] .voice-selector__trigger-icon {
        transform: rotate(180deg);
    }

    .voice-selector__trigger-text {
        flex: 1;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .voice-selector__trigger-icon {
        width: 1.25rem;
        height: 1.25rem;
        margin-left: 0.5rem;
        color: var(--color-text-secondary);
        transition: transform 150ms cubic-bezier(0.4, 0, 0.2, 1);
        flex-shrink: 0;
    }

    /* Dropdown Panel */
    .voice-selector__dropdown {
        position: absolute;
        top: calc(100% + 0.5rem);
        left: 0;
        right: 0;
        background: var(--color-bg-tertiary);
        border: 1px solid var(--color-border-primary);
        border-radius: 0.5rem;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                    0 4px 6px -2px rgba(0, 0, 0, 0.05);
        z-index: 50;
        max-height: 20rem;
        display: flex;
        flex-direction: column;
    }

    /* Search Wrapper */
    .voice-selector__search-wrapper {
        position: relative;
        padding: 0.75rem;
        border-bottom: 1px solid var(--color-border-primary);
    }

    .voice-selector__search-icon {
        position: absolute;
        left: 1.25rem;
        top: 50%;
        transform: translateY(-50%);
        width: 1.125rem;
        height: 1.125rem;
        color: var(--color-text-secondary);
        pointer-events: none;
    }

    .voice-selector__search {
        width: 100%;
        padding: 0.5rem 0.75rem 0.5rem 2.25rem;
        background: var(--color-bg-primary);
        border: 1px solid var(--color-border-primary);
        border-radius: 0.375rem;
        color: var(--color-text-primary);
        font-size: 0.875rem;
        transition: all 200ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    .voice-selector__search:focus {
        outline: none;
        border-color: var(--color-accent-orange);
        box-shadow: 0 0 0 3px var(--color-accent-orange-muted);
    }

    .voice-selector__search::placeholder {
        color: var(--color-text-tertiary);
    }

    /* Voice List */
    .voice-selector__list {
        overflow-y: auto;
        max-height: calc(20rem - 3.5rem);
    }

    /* Voice Group */
    .voice-selector__group {
        border-bottom: 1px solid var(--color-border-primary);
    }

    .voice-selector__group:last-child {
        border-bottom: none;
    }

    .voice-selector__group.voice-selector__group--hidden {
        display: none;
    }

    /* Group Header (Tier 1) */
    .voice-selector__group-header {
        width: 100%;
        padding: 0.625rem 0.75rem;
        background: var(--color-bg-secondary);
        border: none;
        color: var(--color-text-secondary);
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: background 200ms cubic-bezier(0.4, 0, 0.2, 1);
    }

    .voice-selector__group-header:hover {
        background: var(--color-bg-hover);
    }

    .voice-selector__group-name {
        flex: 1;
        text-align: left;
    }

    .voice-selector__group-count {
        color: var(--color-text-tertiary);
        font-size: 0.6875rem;
    }

    .voice-selector__group-chevron {
        width: 1rem;
        height: 1rem;
        color: var(--color-text-secondary);
        transition: transform 150ms cubic-bezier(0.4, 0, 0.2, 1);
        flex-shrink: 0;
    }

    .voice-selector__group-header[aria-expanded="false"] .voice-selector__group-chevron {
        transform: rotate(-90deg);
    }

    /* Voice Options (Tier 2) */
    .voice-selector__options {
        display: flex;
        flex-direction: column;
    }

    .voice-selector__group-header[aria-expanded="false"] + .voice-selector__options {
        display: none;
    }

    /* Voice Option */
    .voice-selector__option {
        width: 100%;
        padding: 0.625rem 0.75rem 0.625rem 2rem;
        background: transparent;
        border: none;
        color: var(--color-text-primary);
        font-size: 0.875rem;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        transition: background 200ms cubic-bezier(0.4, 0, 0.2, 1);
        text-align: left;
    }

    .voice-selector__option:hover {
        background: var(--color-bg-hover);
    }

    .voice-selector__option:focus {
        outline: 2px solid var(--color-accent-orange);
        outline-offset: -2px;
        background: var(--color-bg-hover);
    }

    .voice-selector__option--selected {
        background: var(--color-accent-orange-muted);
    }

    .voice-selector__option--selected:hover {
        background: var(--color-accent-orange-muted);
    }

    .voice-selector__option.voice-selector__option--hidden {
        display: none;
    }

    .voice-selector__option-name {
        font-weight: 500;
    }

    .voice-selector__option-gender {
        color: var(--color-text-secondary);
        font-size: 0.8125rem;
    }

    .voice-selector__option-checkmark {
        width: 1.125rem;
        height: 1.125rem;
        margin-left: auto;
        color: var(--color-accent-orange);
        flex-shrink: 0;
    }

    /* Empty State */
    .voice-selector__empty {
        padding: 2rem 1rem;
        text-align: center;
        color: var(--color-text-tertiary);
        font-size: 0.875rem;
    }

    /* Mobile Responsive */
    @@media (max-width: 767px) {
        .voice-selector__trigger {
            min-height: 44px;
        }

        .voice-selector__dropdown {
            max-height: 16rem;
        }

        .voice-selector__list {
            max-height: calc(16rem - 3.5rem);
        }

        .voice-selector__option {
            min-height: 44px;
            padding: 0.75rem 0.75rem 0.75rem 2rem;
        }
    }
</style>

@* Script loaded via @section Scripts in consuming page *@
