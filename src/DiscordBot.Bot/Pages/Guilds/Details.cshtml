@page "{guildId:long}"
@model DiscordBot.Bot.Pages.Guilds.DetailsModel
@using DiscordBot.Bot.ViewModels.Components
@{
    ViewData["Title"] = Model.ViewModel.Name;
    Layout = "_GuildLayout";
    var guild = Model.ViewModel;
}

<!-- Success Message -->
    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="mb-6">
            <partial name="Shared/Components/_Alert" model="new AlertViewModel {
                Variant = AlertVariant.Success,
                Message = Model.SuccessMessage,
                IsDismissible = true
            }" />
        </div>
    }

    <!-- Guild Information Card (Always visible, not in tabs) -->
    <div class="bg-bg-secondary border border-border-primary rounded-lg p-4 sm:p-6 mb-6">
        <h2 class="text-lg font-semibold text-text-primary mb-4">Guild Information</h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 sm:gap-6">
            <!-- Members -->
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <svg class="w-5 h-5 text-text-tertiary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span class="text-sm text-text-tertiary font-medium">Members</span>
                </div>
                <p class="text-xl font-bold text-text-primary">@guild.MemberCount.ToString("N0")</p>
            </div>
            <!-- Bot Joined -->
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <svg class="w-5 h-5 text-text-tertiary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span class="text-sm text-text-tertiary font-medium">Bot Joined</span>
                </div>
                <p class="text-xl font-bold text-text-primary" data-utc="@guild.JoinedAtUtcIso" data-format="date">
                </p>
            </div>
            <!-- Prefix -->
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <svg class="w-5 h-5 text-text-tertiary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                    </svg>
                    <span class="text-sm text-text-tertiary font-medium">Prefix</span>
                </div>
                <p class="text-xl font-bold text-text-primary font-mono">
                    @if (!string.IsNullOrEmpty(guild.Prefix))
                    {
                        @guild.Prefix
                    }
                    else
                    {
                        <span class="text-text-secondary text-base">Default (/)</span>
                    }
                </p>
            </div>
            <!-- Status -->
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <svg class="w-5 h-5 text-text-tertiary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    <span class="text-sm text-text-tertiary font-medium">Status</span>
                </div>
                <p class="text-xl font-bold text-text-primary">
                    @if (guild.IsActive)
                    {
                        <span class="text-success">Active</span>
                    }
                    else
                    {
                        <span class="text-error">Inactive</span>
                    }
                </p>
            </div>
            <!-- Welcome Messages -->
            <div>
                <div class="flex items-center gap-2 mb-1">
                    <svg class="w-5 h-5 text-text-tertiary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
                    </svg>
                    <span class="text-sm text-text-tertiary font-medium">Welcome</span>
                </div>
                <p class="text-xl font-bold">
                    @if (Model.WelcomeEnabled)
                    {
                        <span class="text-success">Enabled</span>
                    }
                    else
                    {
                        <span class="text-text-secondary">Disabled</span>
                    }
                </p>
            </div>
        </div>
    </div>

    <!-- Dashboard Widgets Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-6 mb-6">
        <!-- Scheduled Messages Widget -->
        @{
            string scheduledMessagesBody = "";
            EmptyStateViewModel? scheduledMessagesEmpty = null;

            if (Model.ScheduledMessagesTotal > 0)
            {
                scheduledMessagesBody = $@"
                <div class='grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4'>
                    <!-- Total -->
                    <div class='bg-bg-primary rounded-lg p-3 sm:p-4'>
                        <div class='flex items-center gap-2 mb-1'>
                            <svg class='w-4 h-4 text-text-tertiary' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' />
                            </svg>
                            <span class='text-xs text-text-tertiary font-medium'>Total</span>
                        </div>
                        <p class='text-2xl font-bold text-text-primary'>{Model.ScheduledMessagesTotal}</p>
                    </div>

                    <!-- Active -->
                    <div class='bg-bg-primary rounded-lg p-3 sm:p-4'>
                        <div class='flex items-center gap-2 mb-1'>
                            <svg class='w-4 h-4 text-success' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' />
                            </svg>
                            <span class='text-xs text-text-tertiary font-medium'>Active</span>
                        </div>
                        <p class='text-2xl font-bold text-success'>{Model.ScheduledMessagesActive}</p>
                    </div>

                    <!-- Paused -->
                    <div class='bg-bg-primary rounded-lg p-3 sm:p-4'>
                        <div class='flex items-center gap-2 mb-1'>
                            <svg class='w-4 h-4 text-warning' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z' />
                            </svg>
                            <span class='text-xs text-text-tertiary font-medium'>Paused</span>
                        </div>
                        <p class='text-2xl font-bold text-warning'>{Model.ScheduledMessagesPaused}</p>
                    </div>

                    <!-- Next Run -->
                    <div class='bg-bg-primary rounded-lg p-3 sm:p-4'>
                        <div class='flex items-center gap-2 mb-1'>
                            <svg class='w-4 h-4 text-accent-blue' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M13 7l5 5m0 0l-5 5m5-5H6' />
                            </svg>
                            <span class='text-xs text-text-tertiary font-medium'>Next Run</span>
                        </div>
                        " + (Model.NextScheduledExecution.HasValue
                            ? $"<span class='text-sm font-bold text-text-primary' data-utc='{Model.NextScheduledExecutionUtcIso}' data-format='datetime-short'>Loading...</span><p class='text-xs text-text-tertiary line-clamp-2 sm:truncate mt-1' title='{System.Net.WebUtility.HtmlEncode(Model.NextScheduledMessageTitle)}'>{System.Net.WebUtility.HtmlEncode(Model.NextScheduledMessageTitle)}</p>"
                            : "<p class='text-sm text-text-tertiary'>--</p>") + @"
                    </div>
                </div>";
            }
            else
            {
                scheduledMessagesEmpty = new EmptyStateViewModel
                {
                    Type = EmptyStateType.NoData,
                    Title = "No scheduled messages yet",
                    Description = "",
                    IconSvgPath = "M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z",
                    PrimaryActionText = "Create Scheduled Message",
                    PrimaryActionUrl = Url.Page("ScheduledMessages/Create", new { guildId = guild.Id })
                };
            }

            var scheduledMessagesWidget = new DashboardWidgetViewModel
            {
                Title = "Scheduled Messages",
                DetailUrl = Url.Page("ScheduledMessages/Index", new { guildId = guild.Id }),
                BodyContent = scheduledMessagesBody,
                EmptyState = scheduledMessagesEmpty,
                ColSpan = 1
            };
        }
        <partial name="Shared/Components/_DashboardWidget" model="scheduledMessagesWidget" />

        <!-- Rat Watch Widget -->
        @{
            string ratWatchBody = "";
            EmptyStateViewModel? ratWatchEmpty = null;

            if (Model.RatWatchTotal > 0)
            {
                ratWatchBody = $@"
                <div class='grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4'>
                    <!-- Total -->
                    <div class='bg-bg-primary rounded-lg p-3 sm:p-4'>
                        <div class='flex items-center gap-2 mb-1'>
                            <svg class='w-4 h-4 text-text-tertiary' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 12a3 3 0 11-6 0 3 3 0 016 0z' />
                                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z' />
                            </svg>
                            <span class='text-xs text-text-tertiary font-medium'>Total Watches</span>
                        </div>
                        <p class='text-2xl font-bold text-text-primary'>{Model.RatWatchTotal}</p>
                    </div>

                    <!-- Pending -->
                    <div class='bg-bg-primary rounded-lg p-3 sm:p-4'>
                        <div class='flex items-center gap-2 mb-1'>
                            <svg class='w-4 h-4 text-warning' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' />
                            </svg>
                            <span class='text-xs text-text-tertiary font-medium'>Pending/Voting</span>
                        </div>
                        <p class='text-2xl font-bold text-warning'>{Model.RatWatchPending}</p>
                    </div>

                    <!-- Completed -->
                    <div class='bg-bg-primary rounded-lg p-3 sm:p-4'>
                        <div class='flex items-center gap-2 mb-1'>
                            <svg class='w-4 h-4 text-success' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' />
                            </svg>
                            <span class='text-xs text-text-tertiary font-medium'>Completed</span>
                        </div>
                        <p class='text-2xl font-bold text-success'>{Model.RatWatchCompleted}</p>
                    </div>

                    <!-- Top Rat -->
                    <div class='bg-bg-primary rounded-lg p-3 sm:p-4'>
                        <div class='flex items-center gap-2 mb-1'>
                            <svg class='w-4 h-4 text-error' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17.657 18.657A8 8 0 016.343 7.343S7 9 9 10c0-2 .5-5 2.986-7C14 5 16.09 5.777 17.656 7.343A7.975 7.975 0 0120 13a7.975 7.975 0 01-2.343 5.657z' />
                                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9.879 16.121A3 3 0 1012.015 11L11 14H9c0 .768.293 1.536.879 2.121z' />
                            </svg>
                            <span class='text-xs text-text-tertiary font-medium'>Top Rat</span>
                        </div>
                        " + (!string.IsNullOrEmpty(Model.TopRatUsername)
                            ? $"<p class='text-sm font-bold text-text-primary truncate' title='{System.Net.WebUtility.HtmlEncode(Model.TopRatUsername)}'>{System.Net.WebUtility.HtmlEncode(Model.TopRatUsername)}</p><p class='text-xs text-error'>{Model.TopRatGuiltyCount} guilty</p>"
                            : "<p class='text-sm text-text-tertiary'>None yet</p>") + @"
                    </div>
                </div>";
            }
            else
            {
                ratWatchEmpty = new EmptyStateViewModel
                {
                    Type = EmptyStateType.NoData,
                    Title = "No Rat Watches yet",
                    Description = "Use the \"Rat Watch\" context menu on messages in Discord to start accountability tracking.",
                    IconSvgPath = "M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"
                };
            }

            var ratWatchWidget = new DashboardWidgetViewModel
            {
                Title = "Rat Watch",
                IsEnabled = Model.RatWatchEnabled,
                DetailUrl = Url.Page("RatWatch/Incidents", new { guildId = guild.Id }),
                DetailLinkText = "Incidents â†’",
                HeaderActions = new List<WidgetHeaderAction>
                {
                    new WidgetHeaderAction { Text = "Settings", Url = Url.Page("RatWatch/Index", new { guildId = guild.Id }) },
                    new WidgetHeaderAction { Text = "Analytics", Url = Url.Page("RatWatch/Analytics", new { guildId = guild.Id }) }
                },
                BodyContent = ratWatchBody,
                EmptyState = ratWatchEmpty,
                ColSpan = 1
            };
        }
        <partial name="Shared/Components/_DashboardWidget" model="ratWatchWidget" />

        <!-- Reminders Widget -->
        @{
            string remindersBody = "";
            EmptyStateViewModel? remindersEmpty = null;

            if (Model.RemindersTotal > 0)
            {
                remindersBody = $@"
                <div class='grid grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4'>
                    <!-- Total -->
                    <div class='bg-bg-primary rounded-lg p-3 sm:p-4'>
                        <div class='flex items-center gap-2 mb-1'>
                            <svg class='w-4 h-4 text-text-tertiary' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9' />
                            </svg>
                            <span class='text-xs text-text-tertiary font-medium'>Total</span>
                        </div>
                        <p class='text-2xl font-bold text-text-primary'>{Model.RemindersTotal}</p>
                    </div>

                    <!-- Pending -->
                    <div class='bg-bg-primary rounded-lg p-3 sm:p-4'>
                        <div class='flex items-center gap-2 mb-1'>
                            <svg class='w-4 h-4 text-accent-blue' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z' />
                            </svg>
                            <span class='text-xs text-text-tertiary font-medium'>Pending</span>
                        </div>
                        <p class='text-2xl font-bold text-accent-blue'>{Model.RemindersPending}</p>
                    </div>

                    <!-- Delivered Today -->
                    <div class='bg-bg-primary rounded-lg p-3 sm:p-4'>
                        <div class='flex items-center gap-2 mb-1'>
                            <svg class='w-4 h-4 text-success' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' />
                            </svg>
                            <span class='text-xs text-text-tertiary font-medium'>Delivered Today</span>
                        </div>
                        <p class='text-2xl font-bold text-success'>{Model.RemindersDeliveredToday}</p>
                    </div>

                    <!-- Failed -->
                    <div class='bg-bg-primary rounded-lg p-3 sm:p-4'>
                        <div class='flex items-center gap-2 mb-1'>
                            <svg class='w-4 h-4 " + (Model.RemindersFailed > 0 ? "text-error" : "text-text-tertiary") + @"' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z' />
                            </svg>
                            <span class='text-xs text-text-tertiary font-medium'>Failed</span>
                        </div>
                        <p class='text-2xl font-bold " + (Model.RemindersFailed > 0 ? "text-error" : "text-text-primary") + @"'>{Model.RemindersFailed}</p>
                    </div>
                </div>";
            }
            else
            {
                remindersEmpty = new EmptyStateViewModel
                {
                    Type = EmptyStateType.NoData,
                    Title = "No reminders yet",
                    Description = "Users can create reminders using the /remind command in Discord.",
                    IconSvgPath = "M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"
                };
            }

            var remindersWidget = new DashboardWidgetViewModel
            {
                Title = "Reminders",
                DetailUrl = Url.Page("Reminders/Index", new { guildId = guild.Id }),
                BodyContent = remindersBody,
                EmptyState = remindersEmpty,
                ColSpan = 1
            };
        }
        <partial name="Shared/Components/_DashboardWidget" model="remindersWidget" />

        <!-- Audio Widget -->
        @{
            string audioBody = "";
            EmptyStateViewModel? audioEmpty = null;

            if (Model.AudioEnabled && (Model.TotalSoundCount > 0 || Model.TopSounds.Any() || !string.IsNullOrEmpty(Model.MostUsedTtsVoice)))
            {
                audioBody = $@"
                <div class='grid grid-cols-2 gap-3 sm:gap-4 mb-4'>
                    <!-- Total Sounds -->
                    <div class='bg-bg-primary rounded-lg p-3 sm:p-4'>
                        <div class='flex items-center gap-2 mb-1'>
                            <svg class='w-4 h-4 text-text-tertiary' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3' />
                            </svg>
                            <span class='text-xs text-text-tertiary font-medium'>Total Sounds</span>
                        </div>
                        <p class='text-2xl font-bold text-text-primary'>{Model.TotalSoundCount}</p>
                    </div>

                    <!-- Most Used TTS Voice -->
                    <div class='bg-bg-primary rounded-lg p-3 sm:p-4'>
                        <div class='flex items-center gap-2 mb-1'>
                            <svg class='w-4 h-4 text-accent-blue' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z' />
                            </svg>
                            <span class='text-xs text-text-tertiary font-medium'>Top TTS Voice</span>
                        </div>
                        " + (!string.IsNullOrEmpty(Model.MostUsedTtsVoice)
                            ? $"<p class='text-sm font-bold text-text-primary truncate' title='{System.Net.WebUtility.HtmlEncode(Model.MostUsedTtsVoice)}'>{System.Net.WebUtility.HtmlEncode(Model.MostUsedTtsVoice)}</p>"
                            : "<p class='text-sm text-text-tertiary'>No TTS usage</p>") + @"
                    </div>
                </div>";

                if (Model.TopSounds.Any())
                {
                    audioBody += @"
                <div class='space-y-2'>
                    <h3 class='text-xs font-semibold text-text-tertiary uppercase tracking-wide mb-3'>Top Sounds This Week</h3>";

                    foreach (var sound in Model.TopSounds)
                    {
                        audioBody += $@"
                    <div class='flex items-center justify-between p-2 rounded-lg bg-bg-primary hover:bg-bg-tertiary transition-colors'>
                        <div class='flex items-center gap-2 min-w-0 flex-1'>
                            <svg class='w-4 h-4 text-text-tertiary flex-shrink-0' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3' />
                            </svg>
                            <span class='text-sm font-medium text-text-primary truncate' title='{System.Net.WebUtility.HtmlEncode(sound.Name)}'>{System.Net.WebUtility.HtmlEncode(sound.Name)}</span>
                        </div>
                        <span class='text-sm font-bold text-accent-blue ml-2 flex-shrink-0'>{sound.PlayCount} plays</span>
                    </div>";
                    }

                    audioBody += @"
                </div>";
                }
            }
            else
            {
                audioEmpty = new EmptyStateViewModel
                {
                    Type = EmptyStateType.NoData,
                    Title = Model.AudioEnabled ? "No audio activity yet" : "Audio is disabled",
                    Description = Model.AudioEnabled ? "Upload sounds and use TTS to see stats here." : "Enable audio features in Audio settings.",
                    IconSvgPath = "M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3",
                    PrimaryActionText = Model.AudioEnabled ? null : "Configure Audio",
                    PrimaryActionUrl = Model.AudioEnabled ? null : Url.Page("AudioSettings/Index", new { guildId = guild.Id })
                };
            }

            var audioWidget = new DashboardWidgetViewModel
            {
                Title = "Audio",
                IsEnabled = Model.AudioEnabled,
                DetailUrl = Url.Page("AudioSettings/Index", new { guildId = guild.Id }),
                BodyContent = audioBody,
                EmptyState = audioEmpty,
                ColSpan = 1
            };
        }
        <partial name="Shared/Components/_DashboardWidget" model="audioWidget" />

        <!-- Members Widget -->
        @{
            string membersBody = "";
            EmptyStateViewModel? membersEmpty = null;

            if (Model.MembersTotalCount > 0)
            {
                membersBody = $@"
                <div class='grid grid-cols-2 gap-3 sm:gap-4 mb-4'>
                    <!-- Total Members -->
                    <div class='bg-bg-primary rounded-lg p-3 sm:p-4'>
                        <div class='flex items-center gap-2 mb-1'>
                            <svg class='w-4 h-4 text-text-tertiary' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z' />
                            </svg>
                            <span class='text-xs text-text-tertiary font-medium'>Total Members</span>
                        </div>
                        <p class='text-2xl font-bold text-text-primary'>{Model.MembersTotalCount:N0}</p>
                    </div>

                    <!-- Active Today -->
                    <div class='bg-bg-primary rounded-lg p-3 sm:p-4'>
                        <div class='flex items-center gap-2 mb-1'>
                            <svg class='w-4 h-4 text-success' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                                <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z' />
                            </svg>
                            <span class='text-xs text-text-tertiary font-medium'>Active Today</span>
                        </div>
                        <p class='text-2xl font-bold text-success'>{Model.MembersActiveToday:N0}</p>
                    </div>
                </div>";

                if (Model.NewestMembers.Any())
                {
                    membersBody += @"
                <div class='space-y-2'>
                    <h3 class='text-xs font-semibold text-text-tertiary uppercase tracking-wide mb-4'>Newest Members</h3>";

                    foreach (var member in Model.NewestMembers)
                    {
                        string? avatarUrl = null;
                        if (!string.IsNullOrEmpty(member.AvatarHash))
                        {
                            var extension = member.AvatarHash.StartsWith("a_") ? "gif" : "png";
                            avatarUrl = $"https://cdn.discordapp.com/avatars/{member.UserId}/{member.AvatarHash}.{extension}?size=80";
                        }

                        var avatarHtml = !string.IsNullOrEmpty(avatarUrl)
                            ? $"<img src='{avatarUrl}' alt='{System.Net.WebUtility.HtmlEncode(member.DisplayName)}' class='w-10 h-10 rounded-full' />"
                            : @"<div class='w-10 h-10 rounded-full bg-bg-tertiary flex items-center justify-center'>
                                   <svg class='w-6 h-6 text-text-tertiary' fill='none' viewBox='0 0 24 24' stroke='currentColor'>
                                       <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z' />
                                   </svg>
                               </div>";

                        var joinedDateUtcIso = DateTime.SpecifyKind(member.JoinedAt, DateTimeKind.Utc).ToString("o");
                        var memberUrl = Url.Page("Members/Index", new { guildId = guild.Id, searchTerm = member.UserId.ToString() });

                        membersBody += $@"
                    <a href='{memberUrl}'
                       class='flex items-center gap-3 p-2 rounded-lg hover:bg-bg-tertiary transition-colors'>
                        {avatarHtml}
                        <div class='flex-1 min-w-0'>
                            <p class='text-sm font-medium text-text-primary truncate preview-trigger' data-preview-type='user' data-user-id='{member.UserId}' data-context-guild-id='{guild.Id}'>{System.Net.WebUtility.HtmlEncode(member.DisplayName)}</p>
                            <p class='text-xs text-text-tertiary' data-utc='{joinedDateUtcIso}' data-format='date'></p>
                        </div>
                    </a>";
                    }

                    membersBody += @"
                </div>";
                }
            }
            else
            {
                membersEmpty = new EmptyStateViewModel
                {
                    Type = EmptyStateType.NoData,
                    Title = "No members found",
                    Description = "Member data will appear here after synchronization.",
                    IconSvgPath = "M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"
                };
            }

            var membersWidget = new DashboardWidgetViewModel
            {
                Title = "Members",
                DetailUrl = Url.Page("Members/Index", new { guildId = guild.Id }),
                BodyContent = membersBody,
                EmptyState = membersEmpty,
                ColSpan = 1
            };
        }
        <partial name="Shared/Components/_DashboardWidget" model="membersWidget" />
    </div>

    <!-- Full-width Activity Section -->
    <div class="w-full">
        @{
            string activityBody = "";
            EmptyStateViewModel? activityEmpty = null;

            if (guild.RecentCommandLogs.Any())
            {
                var activityTable = new System.Text.StringBuilder();

                // Desktop Table
                activityTable.Append(@"
                <div class='overflow-x-auto hidden md:block'>
                    <table class='min-w-full divide-y divide-border-primary'>
                        <thead class='bg-bg-tertiary'>
                            <tr>
                                <th class='px-6 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider'>Command</th>
                                <th class='px-6 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider'>User</th>
                                <th class='px-6 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider'>Time</th>
                                <th class='px-6 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider'>Response</th>
                                <th class='px-6 py-3 text-left text-xs font-medium text-text-secondary uppercase tracking-wider'>Status</th>
                            </tr>
                        </thead>
                        <tbody class='divide-y divide-border-primary'>");

                foreach (var cmd in guild.RecentCommandLogs)
                {
                    var successBadge = cmd.Success
                        ? "<span class='inline-flex items-center px-2 py-0.5 rounded-md text-xs font-semibold bg-success/20 text-success'>Success</span>"
                        : "<span class='inline-flex items-center px-2 py-0.5 rounded-md text-xs font-semibold bg-error/20 text-error'>Failed</span>";

                    activityTable.Append($@"
                            <tr class='hover:bg-bg-tertiary/50 transition-colors'>
                                <td class='px-6 py-4 whitespace-nowrap'>
                                    <span class='text-sm font-medium text-text-primary font-mono'>/{System.Net.WebUtility.HtmlEncode(cmd.CommandName)}</span>
                                </td>
                                <td class='px-6 py-4 whitespace-nowrap text-sm text-text-secondary'>
                                    <span class='preview-trigger' data-preview-type='user' data-user-id='{cmd.UserId}' data-context-guild-id='{guild.Id}'>{System.Net.WebUtility.HtmlEncode(cmd.Username)}</span>
                                </td>
                                <td class='px-6 py-4 whitespace-nowrap text-sm text-text-secondary'>
                                    <span data-utc='{cmd.ExecutedAtUtcIso}' data-format='datetime-short'>{System.Net.WebUtility.HtmlEncode(GetRelativeTime(cmd.ExecutedAt))}</span>
                                </td>
                                <td class='px-6 py-4 whitespace-nowrap text-sm text-text-secondary'>
                                    {cmd.ResponseTimeMs} ms
                                </td>
                                <td class='px-6 py-4 whitespace-nowrap'>
                                    {successBadge}
                                </td>
                            </tr>");
                }

                activityTable.Append(@"
                        </tbody>
                    </table>
                </div>

                <!-- Mobile Card Layout -->
                <div class='md:hidden divide-y divide-border-primary'>");

                foreach (var cmd in guild.RecentCommandLogs)
                {
                    var successBadgeMobile = cmd.Success
                        ? "<span class='inline-flex items-center px-2 py-0.5 rounded-md text-xs font-semibold bg-success/20 text-success'>Success</span>"
                        : "<span class='inline-flex items-center px-2 py-0.5 rounded-md text-xs font-semibold bg-error/20 text-error'>Failed</span>";

                    activityTable.Append($@"
                    <div class='p-3 sm:p-4 hover:bg-bg-tertiary/50 transition-colors'>
                        <div class='flex items-center justify-between mb-2'>
                            <span class='text-sm font-medium text-text-primary font-mono'>/{System.Net.WebUtility.HtmlEncode(cmd.CommandName)}</span>
                            {successBadgeMobile}
                        </div>
                        <div class='space-y-1 text-sm'>
                            <div class='flex justify-between'>
                                <span class='text-text-tertiary'>User:</span>
                                <span class='text-text-secondary preview-trigger' data-preview-type='user' data-user-id='{cmd.UserId}' data-context-guild-id='{guild.Id}'>{System.Net.WebUtility.HtmlEncode(cmd.Username)}</span>
                            </div>
                            <div class='flex justify-between'>
                                <span class='text-text-tertiary'>Time:</span>
                                <span class='text-text-secondary' data-utc='{cmd.ExecutedAtUtcIso}' data-format='datetime-short'>{System.Net.WebUtility.HtmlEncode(GetRelativeTime(cmd.ExecutedAt))}</span>
                            </div>
                            <div class='flex justify-between'>
                                <span class='text-text-tertiary'>Response:</span>
                                <span class='text-text-secondary'>{cmd.ResponseTimeMs} ms</span>
                            </div>
                        </div>
                    </div>");
                }

                activityTable.Append(@"
                </div>");

                activityBody = activityTable.ToString();
            }
            else
            {
                activityEmpty = new EmptyStateViewModel
                {
                    Type = EmptyStateType.NoData,
                    Title = "No command activity yet",
                    Description = "No commands have been executed in this server"
                };
            }

            var activityWidget = new DashboardWidgetViewModel
            {
                Title = "Recent Command Activity",
                Subtitle = "Last 10 commands executed in this server",
                DetailUrl = null, // No detail page for activity yet
                BodyContent = activityBody,
                EmptyState = activityEmpty,
                ColSpan = 2
            };
        }
        <partial name="Shared/Components/_DashboardWidget" model="activityWidget" />
    </div>

<!-- Toast Container -->
<partial name="Shared/Components/_ToastContainer" />

@section Scripts {
    <script src="~/js/toast.js"></script>
    <script src="~/js/guild-sync.js"></script>
    <script>
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                ToastManager.show('success', 'ID copied to clipboard');
            }).catch(err => {
                console.error('Failed to copy:', err);
                ToastManager.show('error', 'Failed to copy to clipboard');
            });
        }

        // More Actions Dropdown
        function toggleMoreActions() {
            const menu = document.getElementById('moreActionsMenu');
            const btn = document.getElementById('moreActionsBtn');
            if (menu && btn) {
                const isHidden = menu.classList.contains('hidden');
                menu.classList.toggle('hidden');
                btn.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('moreActionsDropdown');
            const menu = document.getElementById('moreActionsMenu');
            const btn = document.getElementById('moreActionsBtn');

            if (dropdown && menu && btn && !dropdown.contains(event.target)) {
                menu.classList.add('hidden');
                btn.setAttribute('aria-expanded', 'false');
            }
        });

        // Close dropdown on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const menu = document.getElementById('moreActionsMenu');
                const btn = document.getElementById('moreActionsBtn');
                if (menu && btn && !menu.classList.contains('hidden')) {
                    menu.classList.add('hidden');
                    btn.setAttribute('aria-expanded', 'false');
                    btn.focus();
                }
            }
        });

        // Convert UTC times to local time
        document.addEventListener('DOMContentLoaded', function() {
            const timeElements = document.querySelectorAll('.local-time');
            timeElements.forEach(function(el) {
                const datetime = el.getAttribute('datetime');
                if (datetime) {
                    const date = new Date(datetime);
                    const options = {
                        month: 'short',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: '2-digit',
                        hour12: true
                    };
                    el.textContent = date.toLocaleDateString('en-US', options);
                }
            });
        });
    </script>
}

@functions {
    private string GetRelativeTime(DateTime timestamp)
    {
        var now = DateTime.UtcNow;
        var diff = now - timestamp;

        if (diff.TotalMinutes < 1)
            return "Just now";
        if (diff.TotalMinutes < 60)
            return $"{(int)diff.TotalMinutes}m ago";
        if (diff.TotalHours < 24)
            return $"{(int)diff.TotalHours}h ago";
        if (diff.TotalDays < 7)
            return $"{(int)diff.TotalDays}d ago";

        return timestamp.ToString("MMM d, yyyy");
    }
}
