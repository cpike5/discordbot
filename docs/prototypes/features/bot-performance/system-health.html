<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>System Health - Discord Bot Admin</title>

  <!-- Shared Styles -->
  <link rel="stylesheet" href="../../css/main.css">
  <link rel="stylesheet" href="performance-shared.css">

  <!-- Tailwind CSS CDN with shared config -->
  <script src="../../css/tailwind.config.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = window.tailwindConfig;</script>

  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="bg-bg-primary text-text-primary font-sans antialiased">

  <!-- Main Content Area -->
  <main class="min-h-screen">
    <div class="p-4 lg:p-8 max-w-7xl mx-auto">

      <!-- Breadcrumb Navigation -->
      <nav aria-label="Breadcrumb" class="mb-6">
        <ol class="flex items-center gap-2 text-sm flex-wrap">
          <li>
            <a href="../../dashboard.html" class="text-text-secondary hover:text-accent-blue transition-colors">Dashboard</a>
          </li>
          <li class="text-text-tertiary" aria-hidden="true">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </li>
          <li>
            <a href="index.html" class="text-text-secondary hover:text-accent-blue transition-colors">Bot Performance</a>
          </li>
          <li class="text-text-tertiary" aria-hidden="true">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </li>
          <li>
            <span class="text-text-primary font-medium" aria-current="page">System Health</span>
          </li>
        </ol>
      </nav>

      <!-- Page Header -->
      <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-6">
        <div>
          <h1 class="text-2xl lg:text-3xl font-bold text-text-primary">System Health</h1>
          <p class="text-text-secondary mt-1">Database, cache, and background service monitoring</p>
        </div>

        <!-- System Status -->
        <div class="health-status health-status-healthy">
          <span class="health-status-dot"></span>
          <span>All Services Running</span>
        </div>
      </div>

      <!-- Navigation Tabs -->
      <div class="performance-tabs mb-6">
        <a href="index.html" class="performance-tab">
          <svg class="tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
          </svg>
          Overview
        </a>
        <a href="health-metrics.html" class="performance-tab">
          <svg class="tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
          </svg>
          Health Metrics
        </a>
        <a href="command-performance.html" class="performance-tab">
          <svg class="tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
          </svg>
          Commands
        </a>
        <a href="api-rate-limits.html" class="performance-tab">
          <svg class="tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          API & Rate Limits
        </a>
        <a href="system-health.html" class="performance-tab active">
          <svg class="tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01" />
          </svg>
          System
        </a>
        <a href="alerts-incidents.html" class="performance-tab">
          <svg class="tab-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
          </svg>
          Alerts
        </a>
      </div>

      <!-- Database Performance Card -->
      <div class="chart-card mb-6">
        <div class="chart-card-header">
          <div>
            <h2 class="chart-card-title">Database Performance</h2>
            <p class="chart-card-subtitle">SQLite connection pool and query metrics</p>
          </div>
          <span class="status-badge status-badge-connected">Healthy</span>
        </div>
        <div class="chart-card-body">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <!-- Avg Query Time -->
            <div class="text-center p-4 bg-bg-tertiary rounded-lg">
              <div class="text-3xl font-bold text-text-primary">12<span class="text-lg font-normal text-text-secondary">ms</span></div>
              <div class="text-sm text-text-secondary mt-1">Avg Query Time</div>
              <div class="text-xs text-success mt-0.5">-2ms vs yesterday</div>
            </div>

            <!-- Active Connections -->
            <div class="text-center p-4 bg-bg-tertiary rounded-lg">
              <div class="text-3xl font-bold text-text-primary">8<span class="text-lg font-normal text-text-secondary">/20</span></div>
              <div class="text-sm text-text-secondary mt-1">Active Connections</div>
              <div class="text-xs text-text-tertiary mt-0.5">Pool size: 20</div>
            </div>

            <!-- Queries/sec -->
            <div class="text-center p-4 bg-bg-tertiary rounded-lg">
              <div class="text-3xl font-bold text-text-primary">45</div>
              <div class="text-sm text-text-secondary mt-1">Queries/sec</div>
              <div class="text-xs text-success mt-0.5">+12% vs yesterday</div>
            </div>

            <!-- Connection Pool Usage -->
            <div class="text-center p-4 bg-bg-tertiary rounded-lg">
              <div class="text-3xl font-bold text-text-primary">40<span class="text-lg font-normal text-text-secondary">%</span></div>
              <div class="text-sm text-text-secondary mt-1">Pool Utilization</div>
              <div class="progress-bar-container mt-2">
                <div class="progress-bar-fill progress-bar-healthy" style="width: 40%;"></div>
              </div>
            </div>
          </div>

          <!-- Query Time Chart -->
          <div class="chart-container chart-container-sm">
            <canvas id="queryTimeChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Slow Queries Table -->
      <div class="chart-card mb-6">
        <div class="chart-card-header">
          <div>
            <h2 class="chart-card-title">Slow Queries</h2>
            <p class="chart-card-subtitle">Queries exceeding 100ms threshold (last 24 hours)</p>
          </div>
          <span class="severity-badge severity-info">5 slow queries</span>
        </div>
        <div class="overflow-x-auto">
          <table class="performance-table">
            <thead>
              <tr>
                <th>Query</th>
                <th>Avg Time</th>
                <th>Max Time</th>
                <th>Calls</th>
                <th>Last Seen</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>
                  <code class="text-mono text-xs text-text-secondary">SELECT * FROM message_logs WHERE guild_id = ? ORDER BY created_at DESC LIMIT 1000</code>
                </td>
                <td class="font-medium text-warning">245ms</td>
                <td class="text-error">892ms</td>
                <td>156</td>
                <td>15 min ago</td>
                <td><span class="status-badge status-badge-reconnecting">Needs Index</span></td>
              </tr>
              <tr>
                <td>
                  <code class="text-mono text-xs text-text-secondary">SELECT COUNT(*) FROM rat_watch_incidents WHERE guild_id = ? AND created_at > ?</code>
                </td>
                <td class="font-medium text-warning">178ms</td>
                <td class="text-warning">445ms</td>
                <td>89</td>
                <td>32 min ago</td>
                <td><span class="status-badge status-badge-reconnecting">Investigating</span></td>
              </tr>
              <tr>
                <td>
                  <code class="text-mono text-xs text-text-secondary">SELECT * FROM guild_members WHERE guild_id = ? AND last_active > ?</code>
                </td>
                <td class="font-medium">142ms</td>
                <td class="text-warning">312ms</td>
                <td>234</td>
                <td>1 hour ago</td>
                <td><span class="status-badge status-badge-connected">Optimized</span></td>
              </tr>
              <tr>
                <td>
                  <code class="text-mono text-xs text-text-secondary">UPDATE guild_settings SET ... WHERE guild_id = ?</code>
                </td>
                <td class="font-medium">125ms</td>
                <td>198ms</td>
                <td>45</td>
                <td>2 hours ago</td>
                <td><span class="status-badge status-badge-connected">Normal</span></td>
              </tr>
              <tr>
                <td>
                  <code class="text-mono text-xs text-text-secondary">SELECT * FROM command_logs WHERE ... GROUP BY command_name</code>
                </td>
                <td class="font-medium">112ms</td>
                <td>178ms</td>
                <td>67</td>
                <td>3 hours ago</td>
                <td><span class="status-badge status-badge-connected">Normal</span></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Background Services & Cache Status -->
      <div class="performance-grid-2 mb-6">
        <!-- Background Services -->
        <div class="chart-card">
          <div class="chart-card-header">
            <div>
              <h2 class="chart-card-title">Background Services</h2>
              <p class="chart-card-subtitle">Hosted service status and schedules</p>
            </div>
          </div>
          <div class="chart-card-body p-0">
            <div class="divide-y divide-border-primary">
              <!-- Bot Hosted Service -->
              <div class="p-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-3 h-3 rounded-full bg-success animate-pulse"></div>
                  <div>
                    <div class="font-medium text-text-primary">BotHostedService</div>
                    <div class="text-xs text-text-tertiary">Discord gateway connection</div>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-sm font-medium text-success">Running</div>
                  <div class="text-xs text-text-tertiary">Since Dec 15, 2025</div>
                </div>
              </div>

              <!-- Reminder Service -->
              <div class="p-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-3 h-3 rounded-full bg-success animate-pulse"></div>
                  <div>
                    <div class="font-medium text-text-primary">ReminderService</div>
                    <div class="text-xs text-text-tertiary">Scheduled reminder delivery</div>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-sm font-medium text-success">Running</div>
                  <div class="text-xs text-text-tertiary">Next run: 45s</div>
                </div>
              </div>

              <!-- Scheduled Message Service -->
              <div class="p-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-3 h-3 rounded-full bg-success animate-pulse"></div>
                  <div>
                    <div class="font-medium text-text-primary">ScheduledMessageService</div>
                    <div class="text-xs text-text-tertiary">Automated message posting</div>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-sm font-medium text-success">Running</div>
                  <div class="text-xs text-text-tertiary">Next run: 2m 15s</div>
                </div>
              </div>

              <!-- Message Log Cleanup -->
              <div class="p-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-3 h-3 rounded-full bg-success"></div>
                  <div>
                    <div class="font-medium text-text-primary">MessageLogCleanupService</div>
                    <div class="text-xs text-text-tertiary">Log retention cleanup</div>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-sm font-medium text-success">Running</div>
                  <div class="text-xs text-text-tertiary">Last run: 6h ago</div>
                </div>
              </div>

              <!-- Rat Watch Processor -->
              <div class="p-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                  <div class="w-3 h-3 rounded-full bg-success animate-pulse"></div>
                  <div>
                    <div class="font-medium text-text-primary">RatWatchProcessor</div>
                    <div class="text-xs text-text-tertiary">Incident processing queue</div>
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-sm font-medium text-success">Running</div>
                  <div class="text-xs text-text-tertiary">Queue: 0 items</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Cache Status -->
        <div class="chart-card">
          <div class="chart-card-header">
            <div>
              <h2 class="chart-card-title">Cache Performance</h2>
              <p class="chart-card-subtitle">In-memory cache hit rates</p>
            </div>
            <button class="btn btn-sm btn-secondary">
              <svg class="btn-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
              Clear All
            </button>
          </div>
          <div class="chart-card-body space-y-6">
            <!-- Guild Settings Cache -->
            <div>
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-text-primary">Guild Settings</span>
                <span class="text-sm text-success font-medium">94.2%</span>
              </div>
              <div class="progress-bar-container progress-bar-lg">
                <div class="progress-bar-fill progress-bar-healthy" style="width: 94.2%;"></div>
              </div>
              <div class="flex justify-between text-xs text-text-tertiary mt-1">
                <span>1,247 hits / 78 misses</span>
                <span>Size: 2.4 MB</span>
              </div>
            </div>

            <!-- Command Metadata Cache -->
            <div>
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-text-primary">Command Metadata</span>
                <span class="text-sm text-success font-medium">99.8%</span>
              </div>
              <div class="progress-bar-container progress-bar-lg">
                <div class="progress-bar-fill progress-bar-healthy" style="width: 99.8%;"></div>
              </div>
              <div class="flex justify-between text-xs text-text-tertiary mt-1">
                <span>8,542 hits / 12 misses</span>
                <span>Size: 156 KB</span>
              </div>
            </div>

            <!-- User Permissions Cache -->
            <div>
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-text-primary">User Permissions</span>
                <span class="text-sm text-success font-medium">87.5%</span>
              </div>
              <div class="progress-bar-container progress-bar-lg">
                <div class="progress-bar-fill progress-bar-healthy" style="width: 87.5%;"></div>
              </div>
              <div class="flex justify-between text-xs text-text-tertiary mt-1">
                <span>2,345 hits / 334 misses</span>
                <span>Size: 892 KB</span>
              </div>
            </div>

            <!-- Interaction State Cache -->
            <div>
              <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-text-primary">Interaction State</span>
                <span class="text-sm text-warning font-medium">72.3%</span>
              </div>
              <div class="progress-bar-container progress-bar-lg">
                <div class="progress-bar-fill progress-bar-warning" style="width: 72.3%;"></div>
              </div>
              <div class="flex justify-between text-xs text-text-tertiary mt-1">
                <span>567 hits / 217 misses</span>
                <span>Size: 1.8 MB</span>
              </div>
            </div>

            <!-- Total Cache Stats -->
            <div class="pt-4 border-t border-border-primary">
              <div class="grid grid-cols-3 gap-4 text-center">
                <div>
                  <div class="text-xl font-bold text-text-primary">12,701</div>
                  <div class="text-xs text-text-tertiary">Total Hits</div>
                </div>
                <div>
                  <div class="text-xl font-bold text-text-primary">641</div>
                  <div class="text-xs text-text-tertiary">Total Misses</div>
                </div>
                <div>
                  <div class="text-xl font-bold text-text-primary">5.2 MB</div>
                  <div class="text-xs text-text-tertiary">Total Size</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Memory & GC Stats -->
      <div class="chart-card">
        <div class="chart-card-header">
          <div>
            <h2 class="chart-card-title">Memory & Garbage Collection</h2>
            <p class="chart-card-subtitle">.NET runtime memory statistics</p>
          </div>
        </div>
        <div class="chart-card-body">
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-6">
            <div class="text-center p-3 bg-bg-tertiary rounded-lg">
              <div class="text-xl font-bold text-text-primary">256 MB</div>
              <div class="text-xs text-text-tertiary">Working Set</div>
            </div>
            <div class="text-center p-3 bg-bg-tertiary rounded-lg">
              <div class="text-xl font-bold text-text-primary">198 MB</div>
              <div class="text-xs text-text-tertiary">Private Bytes</div>
            </div>
            <div class="text-center p-3 bg-bg-tertiary rounded-lg">
              <div class="text-xl font-bold text-text-primary">145 MB</div>
              <div class="text-xs text-text-tertiary">Heap Size</div>
            </div>
            <div class="text-center p-3 bg-bg-tertiary rounded-lg">
              <div class="text-xl font-bold text-text-primary">1,247</div>
              <div class="text-xs text-text-tertiary">Gen 0 Collections</div>
            </div>
            <div class="text-center p-3 bg-bg-tertiary rounded-lg">
              <div class="text-xl font-bold text-text-primary">89</div>
              <div class="text-xs text-text-tertiary">Gen 1 Collections</div>
            </div>
            <div class="text-center p-3 bg-bg-tertiary rounded-lg">
              <div class="text-xl font-bold text-text-primary">14</div>
              <div class="text-xs text-text-tertiary">Gen 2 Collections</div>
            </div>
          </div>

          <div class="chart-container">
            <canvas id="memoryChart"></canvas>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- JavaScript -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Chart.js default dark theme settings
      Chart.defaults.color = '#a8a5a3';
      Chart.defaults.borderColor = '#3f4447';

      // Query Time Chart
      const queryCtx = document.getElementById('queryTimeChart').getContext('2d');
      const hours = Array.from({ length: 12 }, (_, i) => (i * 2).toString().padStart(2, '0') + ':00');

      new Chart(queryCtx, {
        type: 'line',
        data: {
          labels: hours,
          datasets: [{
            label: 'Avg Query Time',
            data: [10, 11, 9, 8, 12, 15, 18, 14, 12, 11, 10, 12],
            borderColor: '#098ecf',
            backgroundColor: 'rgba(9, 142, 207, 0.1)',
            fill: true,
            tension: 0.4,
            pointRadius: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: '#2f3336',
              titleColor: '#d7d3d0',
              bodyColor: '#a8a5a3',
              borderColor: '#3f4447',
              borderWidth: 1,
              padding: 12,
              callbacks: {
                label: function(context) {
                  return context.parsed.y + ' ms';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: '#2f3336'
              },
              ticks: {
                callback: function(value) {
                  return value + ' ms';
                }
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });

      // Memory Chart
      const memoryCtx = document.getElementById('memoryChart').getContext('2d');

      new Chart(memoryCtx, {
        type: 'line',
        data: {
          labels: hours,
          datasets: [
            {
              label: 'Working Set',
              data: [240, 245, 238, 242, 255, 268, 275, 262, 258, 252, 248, 256],
              borderColor: '#098ecf',
              backgroundColor: 'transparent',
              tension: 0.4,
              pointRadius: 2
            },
            {
              label: 'Heap Size',
              data: [135, 138, 132, 136, 145, 158, 162, 152, 148, 142, 140, 145],
              borderColor: '#10b981',
              backgroundColor: 'transparent',
              tension: 0.4,
              pointRadius: 2
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false
          },
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                boxWidth: 12,
                padding: 20
              }
            },
            tooltip: {
              backgroundColor: '#2f3336',
              titleColor: '#d7d3d0',
              bodyColor: '#a8a5a3',
              borderColor: '#3f4447',
              borderWidth: 1,
              padding: 12,
              callbacks: {
                label: function(context) {
                  return context.dataset.label + ': ' + context.parsed.y + ' MB';
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: false,
              grid: {
                color: '#2f3336'
              },
              ticks: {
                callback: function(value) {
                  return value + ' MB';
                }
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });
    });
  </script>

</body>
</html>
